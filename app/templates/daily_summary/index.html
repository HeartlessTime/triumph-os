{% extends "base.html" %}

{% block title %}Daily Summary - Triumph OS{% endblock %}

{% block extra_css %}
<style>
    /* Daily Summary — mirrors dashboard-v2 patterns */
    .daily-summary {
        --row-padding: 0.5rem 0.75rem;
        --section-gap: 1rem;
    }

    .daily-summary .content-area {
        padding: 1rem 1.5rem;
    }

    .daily-summary .page-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-default);
    }

    .daily-summary .page-header h1 {
        font-size: 1.25rem;
        margin-bottom: 0;
        color: var(--text-heading);
    }

    .daily-summary .section-card {
        background: var(--bg-surface);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-card-sm);
        margin-bottom: var(--section-gap);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .daily-summary .section-header {
        background: var(--bg-elevated);
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-default);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: var(--text-secondary);
    }

    .daily-summary .section-header .badge {
        font-size: 0.7rem;
        padding: 0.2em 0.5em;
        font-weight: 500;
    }

    .daily-summary .section-body {
        padding: 0;
        flex: 1;
    }

    /* Dense table */
    .daily-summary .dense-table {
        width: 100%;
        font-size: 0.85rem;
        margin: 0;
    }

    .daily-summary .dense-table td {
        padding: var(--row-padding);
        border-bottom: 1px solid var(--border-subtle);
        vertical-align: middle;
        color: var(--text-primary);
    }

    .daily-summary .dense-table tr:last-child td {
        border-bottom: none;
    }

    .daily-summary .dense-table tr:hover {
        background: var(--bg-hover);
    }

    .daily-summary .dense-table tr[data-href] {
        cursor: pointer;
    }
    .daily-summary .dense-table tr[data-href]:hover {
        background: var(--bg-hover-row);
    }

    /* Entity styling */
    .daily-summary .entity-name {
        font-weight: 500;
        color: var(--text-heading);
    }

    .daily-summary .entity-sub {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Status badges */
    .daily-summary .badge-overdue {
        background: var(--danger-bg);
        color: var(--danger-text);
        font-weight: 500;
    }

    .daily-summary .badge-today {
        background: var(--warning-bg);
        color: var(--warning-text);
        font-weight: 500;
    }

    .daily-summary .badge-soon {
        background: var(--success-bg);
        color: var(--success-text);
        font-weight: 500;
    }

    /* Empty state */
    .daily-summary .empty-state {
        padding: 1.5rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .daily-summary .empty-state i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Quick stats row */
    .daily-summary .quick-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .daily-summary .quick-stat {
        background: var(--bg-surface);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border-default);
        font-size: 0.85rem;
    }

    .daily-summary .quick-stat strong {
        color: var(--text-heading);
    }

    .daily-summary .quick-stat span {
        color: var(--text-secondary);
        margin-left: 0.25rem;
    }

    /* AI Briefing box — collapsible */
    .daily-summary .briefing-card {
        background: var(--bg-surface);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-card-sm);
        margin-bottom: var(--section-gap);
        overflow: hidden;
        border-left: 3px solid #8b5cf6;
    }

    .daily-summary .briefing-header {
        background: var(--bg-elevated);
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .daily-summary .briefing-header:hover {
        background: var(--bg-hover);
    }

    .daily-summary .briefing-header .briefing-toggle {
        transition: transform 0.2s;
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    .daily-summary .briefing-card.expanded .briefing-toggle {
        transform: rotate(180deg);
    }

    .daily-summary .briefing-card.expanded .briefing-header {
        border-bottom: 1px solid var(--border-default);
    }

    .daily-summary .briefing-body {
        padding: 0.75rem;
        display: none;
    }

    .daily-summary .briefing-card.expanded .briefing-body {
        display: block;
    }

    .daily-summary .briefing-body textarea {
        width: 100%;
        min-height: 200px;
        background: var(--bg-elevated);
        color: var(--text-primary);
        border: 1px solid var(--border-default);
        border-radius: 0.375rem;
        padding: 0.75rem;
        font-size: 0.85rem;
        font-family: inherit;
        line-height: 1.5;
        resize: vertical;
    }

    .daily-summary .briefing-body textarea:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .daily-summary .briefing-body textarea::placeholder {
        color: var(--text-muted);
        font-style: italic;
    }

    .daily-summary .briefing-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.4rem;
        font-size: 0.72rem;
        color: var(--text-muted);
    }

    .daily-summary .briefing-preview {
        font-size: 0.78rem;
        color: var(--text-muted);
        font-style: italic;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 60%;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="daily-summary">
    <div class="content-area">
        <!-- Header with date navigation -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-sunrise me-2"></i>Daily Summary</h1>
                <small class="text-muted">{{ selected_date.strftime('%A, %B %d, %Y') }}{% if is_today %} — Today{% endif %}</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a href="/daily-summary?date={{ prev_date }}" class="tos-btn tos-btn-sm btn-view" title="Previous day">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <div style="position: relative; display: inline-block;">
                    <input type="date" id="datePicker" value="{{ selected_date.isoformat() }}"
                           style="position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;">
                    <button type="button" class="tos-btn tos-btn-sm btn-view" id="calendarBtn" title="Pick a date">
                        <i class="bi bi-calendar3"></i>
                    </button>
                </div>
                {% if not is_today %}
                <a href="/daily-summary?date={{ next_date }}" class="tos-btn tos-btn-sm btn-view" title="Next day">
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="/daily-summary" class="tos-btn tos-btn-sm btn-view" title="Back to today" style="font-size: 0.7rem;">
                    Today
                </a>
                {% endif %}
            </div>
        </div>

        <!-- AI Briefing (collapsed by default, expanded if has content) -->
        <div class="briefing-card {% if briefing_notes %}expanded{% endif %}" id="briefingCard">
            <div class="briefing-header" id="briefingToggle">
                <span>
                    <i class="bi bi-robot me-1"></i>AI Briefing
                    {% if briefing_notes %}
                    <span class="badge bg-secondary ms-2" style="font-size: 0.6rem; text-transform: none; letter-spacing: 0;">Has content</span>
                    {% endif %}
                    <span class="briefing-preview" id="briefingPreview">{% if briefing_notes and not briefing_notes.strip() == '' %}{{ briefing_notes[:80] }}{% if briefing_notes|length > 80 %}...{% endif %}{% endif %}</span>
                </span>
                <span>
                    <i class="bi bi-chevron-down briefing-toggle"></i>
                </span>
            </div>
            <div class="briefing-body">
                <textarea id="aiBriefing" placeholder="Paste your AI-generated briefing here — use Claude to scan your Outlook inbox and paste the summary into this box.">{{ briefing_notes or '' }}</textarea>
                <div class="briefing-footer">
                    <span>
                        <i class="bi bi-info-circle me-1"></i>Syncs across all devices.
                        <span id="saveStatus" style="margin-left: 0.5rem;"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat">
                <strong>{{ followup_contacts|length }}</strong>
                <span>follow-ups due</span>
            </div>
            <div class="quick-stat">
                <strong>{{ overdue_tasks|length }}</strong>
                <span>tasks due</span>
            </div>
            <div class="quick-stat">
                <strong>{{ next_action_accounts|length }}</strong>
                <span>account actions</span>
            </div>
        </div>

        {# ===== FOLLOW-UPS (CONTACTS) ===== #}
        <div class="section-card">
            <div class="section-header">
                <i class="bi bi-people me-1"></i>Follow-Ups Due — Contacts
                <span class="badge badge-overdue ms-2">{{ followup_contacts|length }}</span>
            </div>
            <div class="section-body">
                {% if followup_contacts %}
                <table class="dense-table">
                    <tbody>
                        {% for contact in followup_contacts %}
                        <tr data-href="/contacts/{{ contact.id }}">
                            <td style="width: 45%;">
                                <span class="entity-name">{{ contact.full_name }}</span>
                                <div class="entity-sub">{{ contact.account.name if contact.account else 'No Account' }}</div>
                            </td>
                            <td>
                                {% set days_overdue = (today - contact.next_followup).days %}
                                <span class="badge {% if days_overdue > 0 %}badge-overdue{% elif days_overdue == 0 %}badge-today{% else %}badge-soon{% endif %}">
                                    {% if days_overdue > 0 %}{{ days_overdue }}d overdue{% elif days_overdue == 0 %}Due today{% else %}{{ contact.next_followup.strftime('%b %d') }}{% endif %}
                                </span>
                            </td>
                            <td class="text-end text-muted" style="font-size: 0.75rem; white-space: nowrap;">
                                {% if contact.last_contacted %}
                                    Last: {{ contact.last_contacted.strftime('%b %d') }}
                                {% else %}
                                    Never contacted
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <div>No contact follow-ups due.</div>
                </div>
                {% endif %}
            </div>
        </div>

        {# ===== TASKS DUE/OVERDUE ===== #}
        <div class="section-card">
            <div class="section-header">
                <i class="bi bi-check2-square me-1"></i>Tasks Due Today or Overdue
                <span class="badge bg-secondary ms-2">{{ overdue_tasks|length }}</span>
            </div>
            <div class="section-body">
                {% if overdue_tasks %}
                <table class="dense-table">
                    <tbody>
                        {% for task in overdue_tasks %}
                        <tr data-href="/tasks/{{ task.id }}/edit?from=/daily-summary">
                            <td style="width: 50%;">
                                <span class="entity-name">{{ task.title }}</span>
                                {% if task.opportunity %}
                                <div class="entity-sub">{{ task.opportunity.name }}</div>
                                {% endif %}
                            </td>
                            <td class="text-end" style="white-space: nowrap;">
                                {% if task.due_date %}
                                {% set days = (today - task.due_date).days %}
                                <span class="{% if days > 0 %}text-danger{% elif days == 0 %}text-warning{% else %}text-muted{% endif %}" style="font-size: 0.75rem;">
                                    {% if days > 0 %}{{ days }}d overdue{% elif days == 0 %}Today{% else %}{{ task.due_date.strftime('%b %d') }}{% endif %}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-check-all"></i>
                    <div>No tasks due today. All clear.</div>
                </div>
                {% endif %}
            </div>
        </div>

        {# ===== ACCOUNT ACTIONS DUE ===== #}
        <div class="section-card">
            <div class="section-header">
                <i class="bi bi-building me-1"></i>Account Actions Due
                <span class="badge bg-secondary ms-2">{{ next_action_accounts|length }}</span>
            </div>
            <div class="section-body">
                {% if next_action_accounts %}
                <table class="dense-table">
                    <tbody>
                        {% for account in next_action_accounts %}
                        <tr data-href="/accounts/{{ account.id }}">
                            <td>
                                <span class="entity-name">{{ account.name }}</span>
                                <div class="entity-sub">{{ account.next_action }}</div>
                            </td>
                            <td class="text-end" style="white-space: nowrap;">
                                {% if account.next_action_due_date %}
                                {% set days = (account.next_action_due_date - today).days %}
                                <span class="{% if days < 0 %}text-danger{% elif days <= 2 %}text-warning{% else %}text-muted{% endif %}" style="font-size: 0.75rem;">
                                    {% if days < 0 %}{{ days|abs }}d overdue{% elif days == 0 %}Today{% else %}In {{ days }}d{% endif %}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <div>No account actions due.</div>
                </div>
                {% endif %}
            </div>
        </div>

    </div><!-- /content-area -->
</div><!-- /daily-summary -->
{% endblock %}

{% block extra_js %}
<script>
// Clickable rows — same pattern as dashboard_v2
document.addEventListener('click', function(e) {
    var clickable = e.target.closest('tr[data-href]');
    if (!clickable) return;
    if (e.target.closest('a, button, input, textarea, select, form')) return;
    window.location.href = clickable.dataset.href;
});

// Date picker — calendar button opens native date input
(function() {
    var picker = document.getElementById('datePicker');
    var btn = document.getElementById('calendarBtn');
    btn.addEventListener('click', function() {
        picker.showPicker ? picker.showPicker() : picker.click();
    });
    picker.addEventListener('change', function() {
        if (picker.value) {
            window.location.href = '/daily-summary?date=' + picker.value;
        }
    });
})();

// AI Briefing — collapsible + auto-save to database
(function() {
    var selectedDate = '{{ selected_date.isoformat() }}';
    var card = document.getElementById('briefingCard');
    var toggle = document.getElementById('briefingToggle');
    var textarea = document.getElementById('aiBriefing');
    var saveStatus = document.getElementById('saveStatus');
    var preview = document.getElementById('briefingPreview');
    var debounceTimer = null;

    // Toggle expand/collapse
    toggle.addEventListener('click', function() {
        card.classList.toggle('expanded');
    });

    function showStatus(msg) {
        saveStatus.textContent = msg;
        setTimeout(function() { saveStatus.textContent = ''; }, 2000);
    }

    function updatePreview(text) {
        var trimmed = (text || '').trim();
        if (trimmed) {
            preview.textContent = trimmed.substring(0, 80) + (trimmed.length > 80 ? '...' : '');
        } else {
            preview.textContent = '';
        }
    }

    function saveBriefing(notes) {
        fetch('/daily-summary/auto-save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: selectedDate, notes: notes})
        }).then(function() {
            showStatus('Saved');
        }).catch(function() {
            showStatus('Save failed');
        });
    }

    // Debounced auto-save on input (1 second delay)
    textarea.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        updatePreview(textarea.value);
        debounceTimer = setTimeout(function() {
            saveBriefing(textarea.value);
        }, 1000);
    });
})();
</script>
{% endblock %}
