{% extends "base.html" %}

{% block title %}Dashboard - Triumph OS{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard V2 - Dense execution-focused layout */
    .dashboard-v2 {
        --row-padding: 0.5rem 0.75rem;
        --section-gap: 1rem;
    }

    .dashboard-v2 .content-area {
        padding: 1rem 1.5rem;
    }

    .dashboard-v2 .page-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-default);
    }

    .dashboard-v2 .page-header h1 {
        font-size: 1.25rem;
        margin-bottom: 0;
        color: var(--text-heading);
    }

    .dashboard-v2 .section-card {
        background: var(--bg-surface);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-card-sm);
        margin-bottom: var(--section-gap);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .dashboard-v2 .section-header {
        background: var(--bg-elevated);
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-default);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: var(--text-secondary);
    }

    /* Pastel section header backgrounds */
    .dashboard-v2 .section--outreach .section-header { background: var(--tint-outreach); }
    .dashboard-v2 .section--meetings .section-header { background: var(--tint-meetings); }
    .dashboard-v2 .section--tasks .section-header { background: var(--tint-tasks); }
    .dashboard-v2 .section--pipeline .section-header { background: var(--tint-pipeline); }

    .dashboard-v2 .section-header .badge {
        font-size: 0.7rem;
        padding: 0.2em 0.5em;
        font-weight: 500;
    }

    .dashboard-v2 .section-body {
        padding: 0;
        flex: 1;
        overflow-y: auto;
    }

    /* Dense table styling */
    .dashboard-v2 .dense-table {
        width: 100%;
        font-size: 0.85rem;
        margin: 0;
    }

    .dashboard-v2 .dense-table th {
        background: var(--bg-elevated);
        padding: 0.4rem 0.75rem;
        font-weight: 500;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-default);
    }

    .dashboard-v2 .dense-table td {
        padding: var(--row-padding);
        border-bottom: 1px solid var(--border-subtle);
        vertical-align: middle;
        color: var(--text-primary);
    }

    .dashboard-v2 .dense-table tr:last-child td {
        border-bottom: none;
    }

    .dashboard-v2 .dense-table tr:hover {
        background: var(--bg-hover);
    }

    /* Clickable rows */
    .dashboard-v2 .dense-table tr[data-href] {
        cursor: pointer;
    }
    .dashboard-v2 .dense-table tr[data-href]:hover {
        background: var(--bg-hover-row);
    }

    /* Dashboard action buttons - alias to tos-btn-sm sizing */
    .dashboard-v2 .btn-push {
        background: var(--warning-bg);
        color: var(--warning-text);
        border: 1px solid var(--warning-text);
        padding: 0.2rem 0.4rem;
        font-size: 0.72rem;
        font-weight: 500;
        line-height: 1.3;
        border-radius: 0.375rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.15s;
    }
    .dashboard-v2 .btn-push:hover { opacity: 0.85; }

    /* Status badges - use theme variables */
    .dashboard-v2 .badge-overdue {
        background: var(--danger-bg);
        color: var(--danger-text);
        font-weight: 500;
    }

    .dashboard-v2 .badge-today {
        background: var(--warning-bg);
        color: var(--warning-text);
        font-weight: 500;
    }

    .dashboard-v2 .badge-soon {
        background: var(--success-bg);
        color: var(--success-text);
        font-weight: 500;
    }

    .dashboard-v2 .badge-pending {
        background: var(--success-bg);
        color: var(--success-text);
        font-weight: 500;
    }

    .dashboard-v2 .badge-completed {
        background: var(--success-bg);
        color: var(--success-text);
        font-weight: 500;
    }

    /* Priority badges - muted */
    .dashboard-v2 .priority-high { color: var(--text-danger-inline); }
    .dashboard-v2 .priority-medium { color: var(--text-warning-inline); }
    .dashboard-v2 .priority-low { color: var(--text-muted); }

    /* Compact action buttons - match tos-btn-sm sizing */
    .dashboard-v2 .btn-action {
        padding: 0.2rem 0.4rem;
        font-size: 0.72rem;
        font-weight: 500;
        line-height: 1.3;
        border-radius: 0.375rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        transition: background 0.15s, color 0.15s, opacity 0.15s;
        white-space: nowrap;
        text-decoration: none;
        border: 1px solid transparent;
    }

    .dashboard-v2 .btn-log {
        background: var(--success-bg);
        color: var(--success-text);
        border-color: var(--success-text);
    }
    .dashboard-v2 .btn-log:hover { opacity: 0.85; }

    .dashboard-v2 .btn-view {
        background: var(--bg-elevated);
        color: var(--text-secondary);
        border-color: var(--border-default);
    }
    .dashboard-v2 .btn-view:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: var(--text-muted);
    }

    /* Empty state - compact */
    .dashboard-v2 .empty-state {
        padding: 1.5rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .dashboard-v2 .empty-state i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Sub-section headers */
    .dashboard-v2 .sub-header {
        background: var(--bg-elevated);
        padding: 0.35rem 0.75rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border-subtle);
    }

    /* Row link styling */
    .dashboard-v2 .row-link {
        color: inherit;
        text-decoration: none;
    }

    .dashboard-v2 .row-link:hover {
        color: var(--link-color);
    }

    .dashboard-v2 .entity-name {
        font-weight: 500;
        color: var(--text-heading);
    }

    .dashboard-v2 .entity-sub {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Task checkbox */
    .dashboard-v2 .task-check {
        width: 1.1rem;
        height: 1.1rem;
        cursor: pointer;
    }

    /* Responsive columns */
    @media (min-width: 992px) {
        .dashboard-v2 .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .dashboard-v2 .section-full {
            grid-column: 1 / -1;
        }
    }

    /* Quick stats row */
    .dashboard-v2 .quick-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .dashboard-v2 .quick-stat {
        background: var(--bg-surface);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border-default);
        font-size: 0.85rem;
    }

    .dashboard-v2 .quick-stat strong {
        color: var(--text-heading);
    }

    .dashboard-v2 .quick-stat span {
        color: var(--text-secondary);
        margin-left: 0.25rem;
    }

    /* Account next-action rows inside Tasks */
    .dashboard-v2 .task-row-account {
        border-left: 3px solid #6366f1;
    }
    .dashboard-v2 .badge-account {
        display: inline-block;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 0.1rem 0.35rem;
        border-radius: 0.2rem;
        background: #eef2ff;
        color: #4338ca;
        vertical-align: middle;
        margin-left: 0.35rem;
    }
    [data-theme="dark"] .dashboard-v2 .badge-account {
        background: #312e81;
        color: #a5b4fc;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-v2">
    <div class="content-area">
        <!-- Header -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1>Today's Execution</h1>
                <small class="text-muted">{{ today.strftime('%A, %B %d, %Y') }}</small>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#quickAddTaskModal">
                    <i class="bi bi-plus-lg"></i> Task
                </button>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logSiteVisitModal">
                    <i class="bi bi-geo-alt"></i> Site Visit
                </button>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#startJobWalkModal">
                    <i class="bi bi-signpost-2"></i> Job Walk
                </button>
                <a href="/opportunities/intake" class="tos-btn tos-btn-primary">
                    <i class="bi bi-plus-lg"></i> Opportunity
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat">
                <strong>{{ followup_opps|length + followup_contacts|length }}</strong>
                <span>follow-ups due</span>
            </div>
            <div class="quick-stat">
                <strong>{{ meetings_pending|length }}</strong>
                <span>meetings pending</span>
            </div>
            <div class="quick-stat">
                <strong>{{ my_tasks|length }}</strong>
                <span>open tasks</span>
            </div>
            <div class="quick-stat">
                <strong class="currency">{{ pipeline_value }}</strong>
                <span>pipeline</span>
            </div>
        </div>

        <!-- Tasks (top priority) — includes account next actions -->
        <div class="section-card" style="margin-bottom: 1rem;">
            <div class="section-header">
                <i class="bi bi-check2-square me-1"></i>Tasks
                <span class="badge bg-secondary ms-2">{{ my_tasks|length + next_action_accounts|length }}</span>
                <button type="button" class="tos-btn tos-btn-sm btn-view ms-2" data-bs-toggle="modal" data-bs-target="#quickAddTaskModal">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <div class="section-body" style="max-height: 320px; overflow-y: auto;">
                {% if my_tasks or next_action_accounts %}
                <table class="dense-table">
                    <tbody>
                        {#- Build a unified list: tasks get sort_date from due_date, accounts from next_action_due_date -#}
                        {#- Jinja doesn't support mixed sorting easily, so we render tasks first then account actions, -#}
                        {#- both already sorted by due date from their queries -#}

                        {#- Account next actions (already sorted by due date ASC from query) -#}
                        {% for account in next_action_accounts %}
                        <tr class="task-row-account" data-href="/accounts/{{ account.id }}"
                            {% if account.days_until_next_action is not none and account.days_until_next_action <= 1 %}style="background-color: #fee2e2;"{% elif account.days_until_next_action is not none and account.days_until_next_action <= 3 %}style="background-color: #fef3c7;"{% endif %}>
                            <td style="width: 1.5rem; padding-right: 0;">
                                <button type="button"
                                    class="task-check"
                                    data-account-next-action-complete
                                    data-account-id="{{ account.id }}"
                                    title="Complete Next Action"></button>
                            </td>
                            <td>
                                <span class="entity-name">{{ account.next_action }}</span>
                                <span class="badge-account">Account</span>
                                <div class="entity-sub">{{ account.name }}</div>
                            </td>
                            <td class="text-end" style="white-space: nowrap;">
                                {% if account.days_until_next_action is not none %}
                                <span class="ms-1 {% if account.days_until_next_action <= 1 %}text-danger{% elif account.days_until_next_action <= 3 %}text-warning{% else %}text-muted{% endif %}" style="font-size: 0.75rem;">
                                    {{ account.next_action_due_date.strftime('%b %d') }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        {#- Regular tasks -#}
                        {% for task in my_tasks %}
                        <tr data-href="/tasks/{{ task.id }}/edit?from=/"
                            {% if task.status != 'Completed' and task.due_date %}
                            {% if task.is_overdue or (task.days_until_due is not none and task.days_until_due <= 1) %}style="background-color: #fee2e2;"{% elif task.days_until_due is not none and task.days_until_due <= 3 %}style="background-color: #fef3c7;"{% endif %}
                            {% endif %}>
                            <td style="width: 1.5rem; padding-right: 0;">
                                <button type="button"
                                    class="task-check {% if task.status == 'Completed' %}checked{% endif %}"
                                    data-task-complete
                                    data-task-id="{{ task.id }}"
                                    data-completed="{{ 'true' if task.status == 'Completed' else 'false' }}"
                                    title="{{ 'Reopen Task' if task.status == 'Completed' else 'Complete Task' }}"
                                    >{% if task.status == 'Completed' %}<i class="bi bi-check"></i>{% endif %}</button>
                            </td>
                            <td>
                                <span class="entity-name {% if task.status == 'Completed' %}text-decoration-line-through text-muted{% endif %}">{{ task.title }}</span>
                                {% if task.opportunity %}
                                <div class="entity-sub">{{ task.opportunity.name }}</div>
                                {% endif %}
                            </td>
                            <td class="text-end" style="white-space: nowrap;">
                                <span class="priority-{{ task.priority|lower }}" style="font-size: 0.7rem; font-weight: 500;">
                                    {{ task.priority }}
                                </span>
                                {% if task.due_date %}
                                <span class="ms-1 {% if task.is_overdue or (task.days_until_due is not none and task.days_until_due <= 1) %}text-danger{% elif task.days_until_due is not none and task.days_until_due <= 3 %}text-warning{% else %}text-muted{% endif %}" style="font-size: 0.75rem;">
                                    {{ task.due_date.strftime('%b %d') }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-check-all"></i>
                    <div>No open tasks.</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- SECTION 1: Outreach & Follow-Ups -->
            <div class="section-card section-full section--outreach">
                <div class="section-header">
                    <i class="bi bi-telephone-outbound me-1"></i>Outreach & Follow-Ups
                    <span class="badge badge-overdue ms-2">{{ followup_opps|length + followup_contacts|length }} due</span>
                </div>
                <div class="section-body">
                    {% set overdue_opps = followup_opps | selectattr('followup_status') | selectattr('followup_status.status', 'equalto', 'overdue') | list %}
                    {% set today_opps = followup_opps | selectattr('followup_status') | selectattr('followup_status.status', 'equalto', 'due_today') | list %}
                    {% set soon_opps = followup_opps | selectattr('followup_status') | selectattr('followup_status.status', 'equalto', 'due_soon') | list %}

                    {% set overdue_contacts = followup_contacts | selectattr('next_followup') | selectattr('next_followup', 'lt', today) | list %}
                    {% set today_contacts = followup_contacts | selectattr('next_followup') | selectattr('next_followup', 'equalto', today) | list %}

                    {% if overdue_opps or overdue_contacts %}
                    <div class="sub-header text-danger"><i class="bi bi-exclamation-circle me-1"></i>Overdue</div>
                    <table class="dense-table">
                        <tbody>
                            {% for opp in overdue_opps %}
                            <tr data-href="/opportunities/{{ opp.id }}">
                                <td style="width: 40%;">
                                    <span class="entity-name">{{ opp.name }}</span>
                                    <div class="entity-sub">{{ opp.primary_account.name if opp.primary_account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-overdue">{{ opp.followup_status.days_until|abs }}d overdue</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <form method="post" action="/opportunities/{{ opp.id }}/push-followup?from=/" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-push" title="Push follow-up 7 days">
                                            <i class="bi bi-calendar-plus me-1"></i>+7d
                                        </button>
                                    </form>
                                    <form method="post" action="/opportunities/{{ opp.id }}/log-contact" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-log" title="Log Contact">
                                            <i class="bi bi-telephone me-1"></i>Log
                                        </button>
                                    </form>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% for contact in overdue_contacts %}
                            <tr data-href="/contacts/{{ contact.id }}">
                                <td style="width: 40%;">
                                    <span class="entity-name">{{ contact.full_name }}</span>
                                    <div class="entity-sub">{{ contact.account.name if contact.account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-overdue">{{ (today - contact.next_followup).days }}d overdue</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <a href="/contacts/{{ contact.id }}" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% if today_opps or today_contacts %}
                    <div class="sub-header text-warning"><i class="bi bi-clock me-1"></i>Due Today</div>
                    <table class="dense-table">
                        <tbody>
                            {% for opp in today_opps %}
                            <tr data-href="/opportunities/{{ opp.id }}">
                                <td style="width: 40%;">
                                    <span class="entity-name">{{ opp.name }}</span>
                                    <div class="entity-sub">{{ opp.primary_account.name if opp.primary_account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-today">Due today</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <form method="post" action="/opportunities/{{ opp.id }}/push-followup?from=/" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-push" title="Push follow-up 7 days">
                                            <i class="bi bi-calendar-plus me-1"></i>+7d
                                        </button>
                                    </form>
                                    <form method="post" action="/opportunities/{{ opp.id }}/log-contact" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-log" title="Log Contact">
                                            <i class="bi bi-telephone me-1"></i>Log
                                        </button>
                                    </form>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% for contact in today_contacts %}
                            <tr data-href="/contacts/{{ contact.id }}">
                                <td style="width: 40%;">
                                    <span class="entity-name">{{ contact.full_name }}</span>
                                    <div class="entity-sub">{{ contact.account.name if contact.account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-today">Due today</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <a href="/contacts/{{ contact.id }}" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% if soon_opps %}
                    <div class="sub-header text-success"><i class="bi bi-calendar-event me-1"></i>Due Soon</div>
                    <table class="dense-table">
                        <tbody>
                            {% for opp in soon_opps %}
                            <tr data-href="/opportunities/{{ opp.id }}">
                                <td style="width: 40%;">
                                    <span class="entity-name">{{ opp.name }}</span>
                                    <div class="entity-sub">{{ opp.primary_account.name if opp.primary_account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-soon">In {{ opp.followup_status.days_until }}d</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <form method="post" action="/opportunities/{{ opp.id }}/push-followup?from=/" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-push" title="Push follow-up 7 days">
                                            <i class="bi bi-calendar-plus me-1"></i>+7d
                                        </button>
                                    </form>
                                    <form method="post" action="/opportunities/{{ opp.id }}/log-contact" class="d-inline">
                                        <button type="submit" class="tos-btn tos-btn-sm btn-log" title="Log Contact">
                                            <i class="bi bi-telephone me-1"></i>Log
                                        </button>
                                    </form>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% if not followup_opps and not followup_contacts %}
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <div>All caught up! No follow-ups needed.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- SECTION 2: Meetings -->
            <div class="section-card section--meetings">
                <div class="section-header">
                    <i class="bi bi-calendar-check me-1"></i>Meetings
                    <span class="badge badge-pending ms-2">{{ meetings_pending|length }} pending</span>
                </div>
                <div class="section-body">
                    {% if meetings_pending %}
                    <div class="sub-header"><i class="bi bi-hourglass-split me-1"></i>Pending (awaiting confirmation)</div>
                    <table class="dense-table">
                        <tbody>
                            {% for activity in meetings_pending %}
                            <tr data-href="/activities/{{ activity.id }}?from=/">
                                <td style="width: 45%;">
                                    <span class="entity-name">{{ activity.attendees_display or activity.contact.full_name }}</span>
                                    <div class="entity-sub">{{ activity.contact.account.name if activity.contact and activity.contact.account else '' }}</div>
                                    {% if activity.description %}
                                    <div class="entity-sub text-truncate" style="max-width: 250px; font-style: italic;">{{ activity.description[:80] }}{% if activity.description|length > 80 %}...{% endif %}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-muted" style="font-size: 0.75rem;">
                                        {{ activity.activity_date | localtime('%b %d') }}
                                    </span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <button type="button"
                                            class="tos-btn tos-btn-sm btn-log mark-meeting-btn"
                                            data-activity-id="{{ activity.id }}"
                                            title="Mark as Meeting Occurred">
                                        <i class="bi bi-check-lg me-1"></i>Met
                                    </button>
                                    <a href="/activities/{{ activity.id }}/edit?from=/" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-pencil"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% if meetings_completed %}
                    <div class="sub-header"><i class="bi bi-check-circle me-1"></i>Completed (this week)</div>
                    <div style="max-height: 200px; overflow-y: auto;">
                    <table class="dense-table">
                        <tbody>
                            {% for activity in meetings_completed %}
                            <tr data-href="/activities/{{ activity.id }}?from=/">
                                <td style="width: 45%;">
                                    <span class="entity-name">{{ activity.attendees_display or activity.subject }}</span>
                                    <div class="entity-sub">{{ activity.contact.account.name if activity.contact and activity.contact.account else '' }}</div>
                                    {% if activity.description %}
                                    <div class="entity-sub text-truncate" style="max-width: 250px; font-style: italic;">{{ activity.description[:80] }}{% if activity.description|length > 80 %}...{% endif %}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-completed">
                                        {{ activity.activity_date | localtime('%b %d') }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a href="/activities/{{ activity.id }}?from=/" class="tos-btn tos-btn-sm btn-view"><i class="bi bi-eye"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    {% endif %}

                    {% if not meetings_pending and not meetings_completed %}
                    <div class="empty-state">
                        <i class="bi bi-calendar"></i>
                        <div>No meetings tracked.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Hot Accounts -->
            {% if hot_accounts %}
            <div class="section-card">
                <div class="section-header" style="background: #fef2f2;">
                    <i class="bi bi-fire me-1" style="color: #dc2626;"></i>Hot Accounts
                    <a href="/accounts?view=hot" class="ms-auto" style="font-size: 0.7rem; font-weight: 400; text-transform: none; letter-spacing: 0; color: #64748b; text-decoration: none;">View all &rarr;</a>
                </div>
                <div class="section-body">
                    <table class="dense-table">
                        <tbody>
                            {% for account in hot_accounts %}
                            {% set urgency_days = account.days_until_next_action if account.days_until_next_action is not none else none %}
                            {% set fallback_days = account.days_since_last_activity %}
                            <tr data-href="/accounts/{{ account.id }}"
                                {% if urgency_days is not none %}
                                    {% if urgency_days < 0 %}style="background-color: #fee2e2;"{% elif urgency_days <= 2 %}style="background-color: #fef3c7;"{% endif %}
                                {% else %}
                                    {% if fallback_days is none or fallback_days >= 30 %}style="background-color: #fee2e2;"{% elif fallback_days >= 21 %}style="background-color: #fef3c7;"{% endif %}
                                {% endif %}>
                                <td style="padding: 0.35rem 0.75rem;">
                                    <span class="entity-name">{{ account.name }}</span>
                                    {% if account.next_action %}
                                    <div class="entity-sub">{{ account.next_action }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-end" style="white-space: nowrap; padding: 0.35rem 0.75rem; font-size: 0.8rem;">
                                    {% if urgency_days is not none %}
                                    <span style="color: {% if urgency_days < 0 %}#dc2626{% elif urgency_days <= 2 %}#d97706{% else %}#059669{% endif %};">
                                        {% if urgency_days < 0 %}{{ urgency_days|abs }}d overdue{% elif urgency_days == 0 %}Today{% else %}In {{ urgency_days }}d{% endif %}
                                    </span>
                                    {% elif fallback_days is not none %}
                                    <span style="color: {% if fallback_days >= 30 %}#dc2626{% elif fallback_days >= 21 %}#d97706{% else %}#059669{% endif %};">
                                        {{ fallback_days }}d ago
                                    </span>
                                    {% else %}
                                    <span style="color: #dc2626;">Never</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- SECTION 4: Jobs Walked — Awaiting Estimate -->
            <div class="section-card section-full section--pipeline">
                <div class="section-header">
                    <i class="bi bi-clipboard-check me-1"></i>Jobs I Walked — Awaiting Estimate
                    <span class="badge bg-primary ms-2">{{ jobs_awaiting_estimate|length }}</span>
                </div>
                <div class="section-body" style="max-height: 320px; overflow-y: auto;">
                    {% if jobs_awaiting_estimate %}
                    <table class="dense-table">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Name</th>
                                <th>Due</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sv in jobs_awaiting_estimate %}
                            {% set days_left = (sv.estimate_due_by - today_date).days if sv.estimate_due_by else none %}
                            <tr data-href="/job-walks/{{ sv.id }}"
                                {% if days_left is not none and days_left <= 0 %}style="background-color: var(--danger-bg, #fee2e2);"
                                {% elif days_left is not none and days_left <= 3 %}style="background-color: var(--warning-bg, #fef3c7);"
                                {% endif %}>
                                <td>
                                    {% if sv.contact and sv.contact.account %}
                                    <a href="/accounts/{{ sv.contact.account.id }}" class="row-link entity-name">{{ sv.contact.account.name }}</a>
                                    {% else %}
                                    <span class="entity-name">{{ sv.subject }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ sv.subject }}</td>
                                <td style="white-space: nowrap; font-size: 0.8rem;">
                                    {% if sv.estimate_due_by %}
                                    <span class="{% if days_left <= 0 %}text-danger fw-bold{% elif days_left <= 3 %}text-warning{% else %}text-muted{% endif %}">
                                        {{ sv.estimate_due_by.strftime('%b %d') }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted" style="font-size: 0.75rem;">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sv.job_walk_status == 'sent_to_estimator' %}
                                    <span class="badge bg-info" style="font-size: 0.65rem;">Sent</span>
                                    {% else %}
                                    <span class="badge bg-secondary" style="font-size: 0.65rem;">Open</span>
                                    {% endif %}
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <button type="button"
                                            class="tos-btn tos-btn-sm btn-log mark-estimate-btn"
                                            data-activity-id="{{ sv.id }}"
                                            title="Mark Complete">
                                        <i class="bi bi-check-lg me-1"></i>Complete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <i class="bi bi-clipboard-check"></i>
                        <div>No open job walks.</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Task Modal -->
<div class="modal fade" id="quickAddTaskModal" tabindex="-1" aria-labelledby="quickAddTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/tasks/quick-add">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="quickAddTaskModalLabel"><i class="bi bi-plus-circle me-2"></i>Quick Add Task</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2">
                    <div class="mb-2">
                        <label for="taskTitle" class="form-label small mb-1">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="taskTitle" name="title" required placeholder="What needs to be done?">
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label for="taskDueDate" class="form-label small mb-1">Due Date</label>
                            <input type="date" class="form-control form-control-sm" id="taskDueDate" name="due_date">
                        </div>
                        <div class="col-6">
                            <label for="taskPriority" class="form-label small mb-1">Priority</label>
                            <select class="form-select form-select-sm" id="taskPriority" name="priority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label for="taskNotes" class="form-label small mb-1">Notes</label>
                        <input type="text" class="form-control form-control-sm" id="taskNotes" name="description" placeholder="Optional notes...">
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="tos-btn tos-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="tos-btn tos-btn-primary"><i class="bi bi-plus-lg"></i> Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Site Visit Modal: inject data for searchable selects (used by shared partial)
window._siteVisitOpps = [
    {% for opp in all_open_opps %}
    { id: {{ opp.id }}, name: "{{ opp.name | replace('"', '\\"') }}", account: "{{ (opp.primary_account.name if opp.primary_account else 'No Account') | replace('"', '\\"') }}" },
    {% endfor %}
];
window._siteVisitContacts = [
    {% for contact in all_contacts %}
    { id: {{ contact.id }}, name: "{{ contact.full_name | replace('"', '\\"') }}", account: "{{ (contact.account.name if contact.account else 'No Account') | replace('"', '\\"') }}", account_id: {{ contact.account_id or 'null' }} },
    {% endfor %}
];
window._jobWalkAccounts = [
    {% for account in all_accounts %}
    { id: {{ account.id }}, name: "{{ account.name | replace('"', '\\"') }}" },
    {% endfor %}
];
</script>

{% include "partials/site_visit_modal.html" %}
{% include "partials/job_walk_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
// Mark meeting as occurred (AJAX)
document.querySelectorAll('.mark-meeting-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const activityId = this.dataset.activityId;
        const row = this.closest('tr');

        fetch('/today/mark-meeting-occurred/' + activityId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row with fade effect
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            } else {
                alert(data.error || 'Failed to update meeting');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Failed to update meeting');
        });
    });
});

// Mark estimate as received (AJAX)
document.querySelectorAll('.mark-estimate-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const activityId = this.dataset.activityId;
        const row = this.closest('tr');

        fetch('/job-walks/' + activityId + '/update-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'complete' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            } else {
                alert('Failed to mark complete');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Failed to mark complete');
        });
    });
});

// Clickable rows handler - navigates to detail page when row is clicked
// Does not interfere with buttons, forms, or links inside the row
document.addEventListener('click', function(e) {
    const clickable = e.target.closest('tr[data-href]');
    if (!clickable) return;

    // Ignore clicks on interactive elements inside the row
    if (e.target.closest('a, button, input, textarea, select, form')) return;

    // Navigate to the detail page
    window.location.href = clickable.dataset.href;
});

// Site Visit data + searchable selects are injected before the partial in content block
</script>
{% endblock %}
