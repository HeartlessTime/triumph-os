{% extends "base.html" %}

{% block title %}Edit {{ opportunity.name }} - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/opportunities">Opportunities</a></li>
                <li class="breadcrumb-item"><a href="/opportunities/{{ opportunity.id }}">{{ opportunity.name }}</a></li>
                <li class="breadcrumb-item active">Edit</li>
            </ol>
        </nav>
        <h1>Edit Opportunity</h1>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-danger mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- Warning Alert with Override -->
    {% if warnings %}
    <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-circle me-2"></i><strong>Warning:</strong>
        <ul class="mb-2 mt-2">
            {% for w in warnings %}
            <li>{{ w }}</li>
            {% endfor %}
        </ul>
        <small>Click "Save Anyway" to proceed despite warnings.</small>
    </div>
    {% endif %}

    <form method="post" action="/opportunities/{{ opportunity.id }}/edit" id="opportunityForm" {% if not warnings %}data-auto-save="/opportunities/{{ opportunity.id }}/auto-save"{% endif %}>
        <!-- Hidden field for warning override -->
        {% if warnings %}
        <input type="hidden" name="confirm_warnings" value="true">
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">Basic Information</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="stage" class="form-label">Stage</label>
                                <select class="form-select" id="stage" name="stage">
                                    {% for stg, prob in stages %}
                                    <option value="{{ stg }}" {% if opportunity.stage == stg %}selected{% endif %}>{{ stg }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="account_id" class="form-label">Account <span class="text-danger">*</span></label>
                                <select class="form-select" id="account_id" name="account_id" required>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}" {% if opportunity.account_id == account.id %}selected{% endif %}>
                                        {{ account.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="primary_contact_id" class="form-label">Primary Contact</label>
                                <select class="form-select" id="primary_contact_id" name="primary_contact_id">
                                    <option value="">Select Contact</option>
                                    {% for contact in contacts %}
                                    <option value="{{ contact.id }}" {% if opportunity.primary_contact_id == contact.id %}selected{% endif %}>
                                        {{ contact.full_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="end_user_account_id" class="form-label">End-User / Owner</label>
                                <select class="form-select" id="end_user_account_id" name="end_user_account_id">
                                    <option value="">Select Account</option>
                                    {% for acc in accounts %}
                                    <option value="{{ acc.id }}" {% if opportunity.end_user_account_id == acc.id %}selected{% endif %}>
                                        {{ acc.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">General Contractors (GCs)</label>
                                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    {% for acc in accounts %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="gc_ids" value="{{ acc.id }}" id="gc_{{ acc.id }}"
                                            {% if opportunity.gcs and (acc.id in opportunity.gcs) %}checked{% endif %}>
                                        <label class="form-check-label" for="gc_{{ acc.id }}">{{ acc.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text">Select one or more GCs bidding on this project.</div>
                            </div>
                            <div class="col-12">
                                <label for="name" class="form-label">Opportunity Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name"
                                    value="{{ form_name if form_name is defined else opportunity.name }}" required>
                            </div>
                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{{ form_description if form_description is defined else (opportunity.description or '') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Related Contacts & Quick Links</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="related_contact_ids" class="form-label">Related Contacts</label>
                            <select class="form-select" id="related_contact_ids" name="related_contact_ids" multiple>
                                {% for c in contacts %}
                                <option value="{{ c.id }}" {% if opportunity.related_contact_ids and (c.id in opportunity.related_contact_ids) %}selected{% endif %}>{{ c.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Contacts relevant to this project.</div>
                        </div>
                        <div>
                            <label for="quick_links_text" class="form-label">Quick Links (one per line)</label>
                            <textarea class="form-control" id="quick_links_text" name="quick_links_text" rows="3">{% if opportunity.quick_links %}{{ '\n'.join(opportunity.quick_links) }}{% endif %}</textarea>
                            <div class="form-text">Add URLs to bid pages or shared folders.</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Known Risks / Constraints / Special Notes</div>
                    <div class="card-body">
                        <p class="text-muted small">e.g., Tight schedule, partial design, union site, GC history, owner-furnished equipment, etc.</p>
                        <div class="mb-3">
                            <textarea class="form-control" id="known_risks" name="known_risks" rows="4">{{ form_known_risks if form_known_risks is defined else (opportunity.known_risks or '') }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Low-Voltage Scope Packages</div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Select all that apply (Low-Voltage specific):</p>
                        <div class="row g-2">
                            {% set LV_SCOPES = [
                                'Horizontal Cabling (Copper)',
                                'Backbone Cabling (Fiber/Copper)',
                                'Site / Campus Fiber',
                                'IDF / MDF Closet Buildout',
                                'Security / Access Control',
                                'Cameras / Surveillance',
                                'Wireless / Access Points',
                                'AV / Paging / Intercom',
                                'Other'
                            ] %}
                            {% for s in LV_SCOPES %}
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="scope_names" value="{{ s }}" id="scope_{{ loop.index }}"
                                    {% if s in selected_scope_names %}checked{% endif %}>
                                    <label class="form-check-label" for="scope_{{ loop.index }}">{{ s }}</label>
                                </div>
                                {% if s == 'Other' %}
                                <div class="mt-2">
                                    <input type="text" class="form-control" name="scope_other_text" placeholder="Other (describe)" value="{{ selected_scope_other_text }}">
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Additional Details</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="source" class="form-label">Lead Source</label>
                                <select class="form-select" id="source" name="source">
                                    <option value="">Select Source</option>
                                    {% for src in sources %}
                                    <option value="{{ src }}" {% if opportunity.source == src %}selected{% endif %}>{{ src }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="stalled_reason" class="form-label">Stalled Reason</label>
                                <select class="form-select" id="stalled_reason" name="stalled_reason">
                                    <option value="">Not Stalled</option>
                                    {% for reason in stalled_reasons %}
                                    <option value="{{ reason }}" {% if opportunity.stalled_reason == reason %}selected{% endif %}>{{ reason }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Probability removed from UI -->
                            <div class="col-12">
                                <label for="notes" class="form-label">Internal Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2">{{ form_notes if form_notes is defined else (opportunity.notes or '') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">Dates & Value</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="lv_value" class="form-label">Estimated LV Contract Value ($)</label>
                            <input type="text" class="form-control currency-input" id="lv_value" name="lv_value"
                                value="{{ form_lv_value if form_lv_value is defined else (opportunity.lv_value or '') }}">
                            <small class="text-muted">Can be filled after estimating</small>
                        </div>
                        <div class="mb-3">
                            <label for="hdd_value" class="form-label">Estimated HDD / Underground Value ($)</label>
                            <input type="text" class="form-control currency-input" id="hdd_value" name="hdd_value"
                                value="{{ form_hdd_value if form_hdd_value is defined else (opportunity.hdd_value or '') }}">
                            <small class="text-muted">Can be filled after estimating</small>
                        </div>
                        <div class="mb-3">
                            <label for="project_type" class="form-label">Project Type</label>
                            <select class="form-select" id="project_type" name="project_type">
                                <option value="">Select</option>
                                {% for pt in ['Education / ISD','Healthcare','Office','Religious','Industrial','Multi-Family','Government','Other'] %}
                                <option value="{{ pt }}" {% if opportunity.project_type == pt %}selected{% endif %}>{{ pt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input class="form-check-input" type="checkbox" id="rebid" name="rebid" value="true" {% if opportunity.rebid %}checked{% endif %}>
                            <label class="form-check-label" for="rebid">Rebid / Revision?</label>
                        </div>
                        <div class="mb-3">
                            <label for="last_contacted" class="form-label">Last Contacted</label>
                            <input type="date" class="form-control" id="last_contacted" name="last_contacted"
                                   value="{{ opportunity.last_contacted.strftime('%Y-%m-%d') if opportunity.last_contacted else '' }}">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Assignment</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="owner_id" class="form-label">Sales Owner <span class="text-danger">*</span></label>
                            <select class="form-select" id="owner_id" name="owner_id" required>
                                <option value="">Unassigned</option>
                                {% for u in sales_users %}
                                <option value="{{ u.id }}" {% if opportunity.owner_id == u.id %}selected{% endif %}>
                                    {{ u.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="assigned_estimator_id" class="form-label">Estimator</label>
                            <select class="form-select" id="assigned_estimator_id" name="assigned_estimator_id">
                                <option value="">Unassigned</option>
                                {% for u in estimators %}
                                <option value="{{ u.id }}" {% if opportunity.assigned_estimator_id == u.id %}selected{% endif %}>
                                    {{ u.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Bid Instructions</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bid_type" class="form-label">Bid Type</label>
                                <select class="form-select" id="bid_type" name="bid_type">
                                    <option value="">Select</option>
                                    <option value="Hard Bid" {% if opportunity.bid_type == 'Hard Bid' %}selected{% endif %}>Hard Bid</option>
                                    <option value="Budgetary" {% if opportunity.bid_type == 'Budgetary' %}selected{% endif %}>Budgetary</option>
                                    <option value="Design-Assist" {% if opportunity.bid_type == 'Design-Assist' %}selected{% endif %}>Design-Assist</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="submission_method" class="form-label">Submission Method</label>
                                <select class="form-select" id="submission_method" name="submission_method">
                                    <option value="">Select</option>
                                    <option value="Email" {% if opportunity.submission_method == 'Email' %}selected{% endif %}>Email</option>
                                    <option value="GC Portal" {% if opportunity.submission_method == 'GC Portal' %}selected{% endif %}>GC Portal</option>
                                    <option value="Public Portal" {% if opportunity.submission_method == 'Public Portal' %}selected{% endif %}>Public Portal</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_date" class="form-label">Bid Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="bid_date" name="bid_date"
                                    value="{{ form_bid_date if form_bid_date is defined else (opportunity.bid_date.strftime('%Y-%m-%d') if opportunity.bid_date else '') }}">
                                <small class="text-muted">Required unless "TBD" is checked</small>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_time" class="form-label">Bid Time</label>
                                <input type="time" class="form-control" id="bid_time" name="bid_time" value="{{ opportunity.bid_time.strftime('%H:%M') if opportunity.bid_time else '' }}">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="bid_date_tbd" name="bid_date_tbd" value="true"
                                        {% if form_bid_date_tbd is defined and form_bid_date_tbd %}checked{% elif opportunity.bid_date_tbd %}checked{% endif %}>
                                    <label class="form-check-label" for="bid_date_tbd">Bid date TBD</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bid Form Required?</label>
                                <select class="form-select" id="bid_form_required" name="bid_form_required">
                                    <option value="">Select</option>
                                    <option value="true" {% if opportunity.bid_form_required %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if not opportunity.bid_form_required %}selected{% endif %}>No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bond Required?</label>
                                <select class="form-select" id="bond_required" name="bond_required">
                                    <option value="">Select</option>
                                    <option value="true" {% if opportunity.bond_required %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if not opportunity.bond_required %}selected{% endif %}>No</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="prevailing_wage" class="form-label">Prevailing Wage</label>
                                <select class="form-select" id="prevailing_wage" name="prevailing_wage">
                                    <option value="">Select</option>
                                    <option value="Yes" {% if opportunity.prevailing_wage == 'Yes' %}selected{% endif %}>Yes</option>
                                    <option value="No" {% if opportunity.prevailing_wage == 'No' %}selected{% endif %}>No</option>
                                    <option value="Unknown" {% if opportunity.prevailing_wage == 'Unknown' %}selected{% endif %}>Unknown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Help sidebar -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle me-1"></i> Required Fields</h6>
                        <p class="card-text small text-muted mb-0">
                            Fields marked with <span class="text-danger">*</span> are required:
                        </p>
                        <ul class="small text-muted mt-2 mb-0">
                            <li>Stage</li>
                            <li>Account</li>
                            <li>Opportunity Name</li>
                            <li>Bid Date (or check "TBD")</li>
                            <li>Sales Owner</li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    {% if warnings %}
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i>
                        Save Anyway
                    </button>
                    <a href="/opportunities/{{ opportunity.id }}" class="btn btn-outline-secondary">Cancel</a>
                    {% else %}
                    <!-- Auto-save mode: no Save button, just Done -->
                    <a href="/opportunities/{{ opportunity.id }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i> Done
                    </a>
                    <span class="text-muted small text-center">
                        <i class="bi bi-cloud-check me-1"></i>Changes save automatically
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{% if not warnings %}
<script>
(function() {
    const form = document.getElementById('opportunityForm');
    const endpoint = form.dataset.autoSave;
    if (form && endpoint) {
        AutoSave.init(form, endpoint);
    }
})();
</script>
{% endif %}
{% endblock %}
