{% extends "base.html" %}

{% block title %}Edit {{ opportunity.name }} - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/opportunities">Opportunities</a></li>
                <li class="breadcrumb-item"><a href="/opportunities/{{ opportunity.id }}">{{ opportunity.name }}</a></li>
                <li class="breadcrumb-item active">Edit</li>
            </ol>
        </nav>
        <h1>Edit Opportunity</h1>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-danger mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- Warning Alert with Override -->
    {% if warnings %}
    <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-circle me-2"></i><strong>Warning:</strong>
        <ul class="mb-2 mt-2">
            {% for w in warnings %}
            <li>{{ w }}</li>
            {% endfor %}
        </ul>
        <small>Click "Save Anyway" to proceed despite warnings.</small>
    </div>
    {% endif %}

    <form method="post" action="/opportunities/{{ opportunity.id }}/edit" id="opportunityForm" {% if not warnings %}data-auto-save="/opportunities/{{ opportunity.id }}/auto-save"{% endif %}>
        <!-- Hidden field for warning override -->
        {% if warnings %}
        <input type="hidden" name="confirm_warnings" value="true">
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Opportunity Name - TOP -->
                <div class="card mb-4">
                    <div class="card-header">Opportunity Name</div>
                    <div class="card-body">
                        <input type="text" class="form-control form-control-lg" id="name" name="name"
                            value="{{ form_name if form_name is defined else opportunity.name }}"
                            required placeholder="e.g., Office Building Renovation - Main Campus">
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Project Details</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="stage" class="form-label">Stage</label>
                                <select class="form-select" id="stage" name="stage">
                                    {% for stg, prob in stages %}
                                    <option value="{{ stg }}" {% if opportunity.stage == stg %}selected{% endif %}>{{ stg }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="project_type" class="form-label">Project Type</label>
                                <select class="form-select" id="project_type" name="project_type">
                                    <option value="">Select</option>
                                    {% for pt in ['Education / ISD','Healthcare','Office','Religious','Industrial','Multi-Family','Government','Other'] %}
                                    <option value="{{ pt }}" {% if opportunity.project_type == pt %}selected{% endif %}>{{ pt }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Accounts Multi-Select -->
                            <div class="col-12">
                                <label class="form-label">Accounts <span class="text-danger">*</span></label>
                                <div class="position-relative">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="account_search"
                                            placeholder="Search accounts..."
                                            autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <div id="account_results" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <!-- Selected Accounts displayed as pills -->
                                <div id="selected_accounts" class="mt-2 d-flex flex-wrap gap-1"></div>
                                <!-- Hidden inputs for selected Account IDs (dynamically added) -->
                                <div id="account_hidden_inputs"></div>
                                <div class="form-text">Select one or more accounts associated with this opportunity.</div>
                            </div>

                            <!-- Primary Account Selector -->
                            <div class="col-md-6">
                                <label for="primary_account_id" class="form-label">Primary Account <span class="text-danger">*</span></label>
                                <select class="form-select" id="primary_account_id" name="primary_account_id" disabled>
                                    <option value="">Select accounts first</option>
                                </select>
                                <div class="form-text text-muted" id="primary_account_hint">
                                    Select accounts above first.
                                </div>
                            </div>

                            <!-- Primary Contact Selector -->
                            <div class="col-md-6">
                                <label for="primary_contact_id" class="form-label">Primary Contact</label>
                                <div class="input-group">
                                    <select class="form-select" id="primary_contact_id" name="primary_contact_id" disabled>
                                        <option value="">Select accounts first</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="addContactBtn" data-bs-toggle="modal" data-bs-target="#addContactModal" disabled>
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                <div class="form-text text-muted" id="primary_contact_hint">
                                    Select accounts to see available contacts.
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="rebid" name="rebid" value="true" {% if opportunity.rebid %}checked{% endif %}>
                                    <label class="form-check-label" for="rebid">Rebid / Revision</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{{ form_description if form_description is defined else (opportunity.description or '') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Bid Information</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bid_type" class="form-label">Bid Type</label>
                                <select class="form-select" id="bid_type" name="bid_type">
                                    <option value="">Select</option>
                                    <option value="Hard Bid" {% if opportunity.bid_type == 'Hard Bid' %}selected{% endif %}>Hard Bid</option>
                                    <option value="Budgetary" {% if opportunity.bid_type == 'Budgetary' %}selected{% endif %}>Budgetary</option>
                                    <option value="Design-Assist" {% if opportunity.bid_type == 'Design-Assist' %}selected{% endif %}>Design-Assist</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="submission_method" class="form-label">Submission Method</label>
                                <select class="form-select" id="submission_method" name="submission_method">
                                    <option value="">Select</option>
                                    <option value="Email" {% if opportunity.submission_method == 'Email' %}selected{% endif %}>Email</option>
                                    <option value="GC Portal" {% if opportunity.submission_method == 'GC Portal' %}selected{% endif %}>GC Portal</option>
                                    <option value="Public Portal" {% if opportunity.submission_method == 'Public Portal' %}selected{% endif %}>Public Portal</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_date" class="form-label">Bid Date</label>
                                <input type="date" class="form-control" id="bid_date" name="bid_date"
                                    value="{{ form_bid_date if form_bid_date is defined else (opportunity.bid_date.strftime('%Y-%m-%d') if opportunity.bid_date else '') }}">
                            </div>
                            <div class="col-md-6">
                                <label for="bid_time" class="form-label">Bid Time</label>
                                <input type="time" class="form-control" id="bid_time" name="bid_time" value="{{ opportunity.bid_time.strftime('%H:%M') if opportunity.bid_time else '' }}">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="prevailing_wage" name="prevailing_wage" value="Yes"
                                        {% if opportunity.prevailing_wage == 'Yes' %}checked{% endif %}>
                                    <label class="form-check-label" for="prevailing_wage">Prevailing Wage</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="bond_required" name="bond_required" value="true"
                                        {% if opportunity.bond_required %}checked{% endif %}>
                                    <label class="form-check-label" for="bond_required">Bond Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bid Form Required?</label>
                                <select class="form-select" id="bid_form_required" name="bid_form_required">
                                    <option value="">Select</option>
                                    <option value="true" {% if opportunity.bid_form_required %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if opportunity.bid_form_required == False %}selected{% endif %}>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Job Walk / Pre-Bid Meeting Section -->
                <div class="card mb-4">
                    <div class="card-header">Job Walk / Pre-Bid Meeting</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="job_walk_required" name="job_walk_required" value="true"
                                        {% if opportunity.job_walk_required %}checked{% endif %}>
                                    <label class="form-check-label" for="job_walk_required">Job Walk Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="job_walk_date" name="job_walk_date"
                                    value="{{ opportunity.job_walk_date.strftime('%Y-%m-%d') if opportunity.job_walk_date else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_time" class="form-label">Time</label>
                                <input type="time" class="form-control" id="job_walk_time" name="job_walk_time"
                                    value="{{ opportunity.job_walk_time.strftime('%H:%M') if opportunity.job_walk_time else '' }}">
                            </div>
                            <div class="col-12">
                                <label for="job_walk_notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="job_walk_notes" name="job_walk_notes" rows="2"
                                    placeholder="Location, parking instructions, contact person...">{{ opportunity.job_walk_notes or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Job Notes & Risks</div>
                    <div class="card-body">
                        <p class="text-muted small">Include project description, known risks, constraints, special notes, internal notes, etc.</p>
                        <textarea class="form-control" id="known_risks" name="known_risks" rows="4"
                            placeholder="Project details, tight schedule, partial design, union site, history, owner-furnished equipment...">{{ form_known_risks if form_known_risks is defined else (opportunity.known_risks or '') }}</textarea>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Related Contacts & Quick Links</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="related_contact_ids" class="form-label">Related Contacts</label>
                            <select class="form-select" id="related_contact_ids" name="related_contact_ids" multiple>
                                {% for c in contacts %}
                                <option value="{{ c.id }}" {% if opportunity.related_contact_ids and (c.id in opportunity.related_contact_ids) %}selected{% endif %}>{{ c.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Contacts relevant to this project.</div>
                        </div>
                        <div>
                            <label for="quick_links_text" class="form-label">Quick Links (one per line)</label>
                            <textarea class="form-control" id="quick_links_text" name="quick_links_text" rows="3">{% if opportunity.quick_links %}{{ '\n'.join(opportunity.quick_links) }}{% endif %}</textarea>
                            <div class="form-text">Add URLs to bid pages or shared folders.</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Additional Details</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="source" class="form-label">Lead Source</label>
                                <select class="form-select" id="source" name="source">
                                    <option value="">Select Source</option>
                                    {% for src in sources %}
                                    <option value="{{ src }}" {% if opportunity.source == src %}selected{% endif %}>{{ src }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="stalled_reason" class="form-label">Stalled Reason</label>
                                <select class="form-select" id="stalled_reason" name="stalled_reason">
                                    <option value="">Not Stalled</option>
                                    {% for reason in stalled_reasons %}
                                    <option value="{{ reason }}" {% if opportunity.stalled_reason == reason %}selected{% endif %}>{{ reason }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="notes" class="form-label">Internal Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2">{{ form_notes if form_notes is defined else (opportunity.notes or '') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">Dates & Value</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="lv_value" class="form-label">Estimated LV Contract Value ($)</label>
                            <input type="text" class="form-control currency-input" id="lv_value" name="lv_value"
                                value="{{ form_lv_value if form_lv_value is defined else (opportunity.lv_value or '') }}">
                            <small class="text-muted">Can be filled after estimating</small>
                        </div>
                        <div class="mb-3">
                            <label for="hdd_value" class="form-label">Estimated HDD / Underground Value ($)</label>
                            <input type="text" class="form-control currency-input" id="hdd_value" name="hdd_value"
                                value="{{ form_hdd_value if form_hdd_value is defined else (opportunity.hdd_value or '') }}">
                            <small class="text-muted">Can be filled after estimating</small>
                        </div>
                        <div class="mb-3">
                            <label for="last_contacted" class="form-label">Last Contacted</label>
                            <input type="date" class="form-control" id="last_contacted" name="last_contacted"
                                   value="{{ opportunity.last_contacted.strftime('%Y-%m-%d') if opportunity.last_contacted else '' }}">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Assignment</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="owner_id" class="form-label">Sales Owner <span class="text-danger">*</span></label>
                            <select class="form-select" id="owner_id" name="owner_id" required>
                                <option value="">Unassigned</option>
                                {% for u in sales_users %}
                                <option value="{{ u.id }}" {% if opportunity.owner_id == u.id %}selected{% endif %}>
                                    {{ u.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="assigned_estimator_id" class="form-label">Estimator</label>
                            <select class="form-select" id="assigned_estimator_id" name="assigned_estimator_id">
                                <option value="">Unassigned</option>
                                {% for u in estimators %}
                                <option value="{{ u.id }}" {% if opportunity.assigned_estimator_id == u.id %}selected{% endif %}>
                                    {{ u.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Help sidebar -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle me-1"></i> Required Fields</h6>
                        <p class="card-text small text-muted mb-0">
                            Fields marked with <span class="text-danger">*</span> are required:
                        </p>
                        <ul class="small text-muted mt-2 mb-0">
                            <li>Opportunity Name</li>
                            <li>At least one Account</li>
                            <li>Primary Account</li>
                            <li>Bid Date (or check "TBD")</li>
                            <li>Sales Owner</li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    {% if warnings %}
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i>
                        Save Anyway
                    </button>
                    <a href="/opportunities/{{ opportunity.id }}" class="btn btn-outline-secondary">Cancel</a>
                    {% else %}
                    <!-- Auto-save mode: no Save button, just Done -->
                    <a href="/opportunities/{{ opportunity.id }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i> Done
                    </a>
                    <span class="text-muted small text-center">
                        <i class="bi bi-cloud-check me-1"></i>Changes save automatically
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Add New Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAccountModalLabel">
                    <i class="bi bi-building-add me-2"></i>Add New Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_account_name" class="form-label">Account Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="new_account_name" required>
                </div>
                <div class="mb-3">
                    <label for="new_account_phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="new_account_phone">
                </div>
                <div class="mb-3">
                    <label for="new_account_address" class="form-label">Address</label>
                    <textarea class="form-control" id="new_account_address" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewAccountBtn">
                    <i class="bi bi-check-lg me-1"></i>Save & Add
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addContactModalLabel">
                    <i class="bi bi-person-add me-2"></i>Add New Contact
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_contact_account_id" class="form-label">Account <span class="text-danger">*</span></label>
                    <select class="form-select" id="new_contact_account_id" required>
                        <option value="">Select Account</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="new_contact_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="new_contact_first_name" required>
                </div>
                <div class="mb-3">
                    <label for="new_contact_last_name" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="new_contact_last_name">
                </div>
                <div class="mb-3">
                    <label for="new_contact_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="new_contact_email">
                </div>
                <div class="mb-3">
                    <label for="new_contact_phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="new_contact_phone">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewContactBtn">
                    <i class="bi bi-check-lg me-1"></i>Save Contact
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // ========================================
    // SHARED: Accounts data from server
    // ========================================
    const accounts = [
        {% for acc in accounts %}
        { id: {{ acc.id }}, name: "{{ acc.name | replace('"', '\\"') }}" },
        {% endfor %}
    ];

    // Pre-selected account IDs from opportunity
    const preSelectedAccountIds = [{% for aid in opportunity.account_ids %}{{ aid }}{% if not loop.last %}, {% endif %}{% endfor %}];
    const preSelectedPrimaryAccountId = {{ opportunity.primary_account_id or 'null' }};
    const preSelectedPrimaryContactId = {{ opportunity.primary_contact_id or 'null' }};

    // ========================================
    // ACCOUNTS MULTI-SELECT
    // ========================================
    const accountSearch = document.getElementById('account_search');
    const accountResults = document.getElementById('account_results');
    const selectedAccountsDiv = document.getElementById('selected_accounts');
    const accountHiddenInputs = document.getElementById('account_hidden_inputs');
    const primaryAccountSelect = document.getElementById('primary_account_id');
    const primaryAccountHint = document.getElementById('primary_account_hint');
    const primaryContactSelect = document.getElementById('primary_contact_id');
    const primaryContactHint = document.getElementById('primary_contact_hint');
    const addContactBtn = document.getElementById('addContactBtn');
    const newContactAccountSelect = document.getElementById('new_contact_account_id');

    // Track selected Account IDs
    const selectedAccountIds = new Set(preSelectedAccountIds);

    // Track current primary contact to preserve across refreshes
    let currentPrimaryContactId = preSelectedPrimaryContactId ? preSelectedPrimaryContactId.toString() : '';

    // Render selected Accounts as pills
    function renderSelectedAccounts() {
        selectedAccountsDiv.innerHTML = '';
        accountHiddenInputs.innerHTML = '';

        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                // Create pill
                const pill = document.createElement('span');
                pill.className = 'badge bg-primary d-inline-flex align-items-center gap-1';
                pill.innerHTML = `
                    ${account.name}
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" data-account-id="${id}" aria-label="Remove"></button>
                `;
                selectedAccountsDiv.appendChild(pill);

                // Create hidden input
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'account_ids';
                hidden.value = id;
                accountHiddenInputs.appendChild(hidden);
            }
        });

        // Update Primary Account dropdown
        updatePrimaryAccountOptions();
        // Update Primary Contact dropdown
        updatePrimaryContactOptions();
        // Update Add Contact modal account dropdown
        updateContactModalAccounts();
    }

    // Update Primary Account dropdown with selected accounts
    function updatePrimaryAccountOptions() {
        const currentValue = primaryAccountSelect.value || (preSelectedPrimaryAccountId ? preSelectedPrimaryAccountId.toString() : '');
        primaryAccountSelect.innerHTML = '';

        if (selectedAccountIds.size === 0) {
            primaryAccountSelect.innerHTML = '<option value="">Select accounts first</option>';
            primaryAccountSelect.disabled = true;
            primaryAccountHint.textContent = 'Select accounts above first.';
            primaryAccountHint.classList.remove('d-none');
            return;
        }

        primaryAccountSelect.innerHTML = '<option value="">Select Primary Account</option>';
        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                if (account.id.toString() === currentValue) {
                    option.selected = true;
                }
                primaryAccountSelect.appendChild(option);
            }
        });

        primaryAccountSelect.disabled = false;
        primaryAccountHint.classList.add('d-none');

        // Auto-select if only one account
        if (selectedAccountIds.size === 1 && !primaryAccountSelect.value) {
            primaryAccountSelect.value = Array.from(selectedAccountIds)[0];
        }
    }

    // Update Primary Contact dropdown from ALL selected accounts
    async function updatePrimaryContactOptions() {
        const accountIds = Array.from(selectedAccountIds);

        if (accountIds.length === 0) {
            primaryContactSelect.innerHTML = '<option value="">Select accounts first</option>';
            primaryContactSelect.disabled = true;
            addContactBtn.disabled = true;
            primaryContactHint.textContent = 'Select accounts to see available contacts.';
            primaryContactHint.classList.remove('d-none');
            return;
        }

        // Fetch contacts for all selected accounts
        try {
            const response = await fetch('/accounts/api/contacts-for-accounts?account_ids=' + accountIds.join(','));
            if (!response.ok) {
                throw new Error('Failed to fetch contacts');
            }

            const contacts = await response.json();

            primaryContactSelect.innerHTML = '<option value="">Select Contact</option>';

            if (contacts.length === 0) {
                primaryContactHint.textContent = 'No contacts found for selected accounts.';
                primaryContactHint.classList.remove('d-none');
            } else {
                primaryContactHint.classList.add('d-none');
                contacts.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.display_name;
                    if (c.id.toString() === currentPrimaryContactId) {
                        option.selected = true;
                    }
                    primaryContactSelect.appendChild(option);
                });
            }

            primaryContactSelect.disabled = false;
            addContactBtn.disabled = false;

            // If previous selection is no longer valid, clear it and trigger auto-save
            if (currentPrimaryContactId && !contacts.find(c => c.id.toString() === currentPrimaryContactId)) {
                primaryContactSelect.value = '';
                currentPrimaryContactId = '';
                triggerAutoSave();
            }

        } catch (err) {
            console.error('Failed to load contacts:', err);
            primaryContactHint.textContent = 'Error loading contacts.';
            primaryContactHint.classList.remove('d-none');
        }
    }

    // Update Add Contact modal account dropdown
    function updateContactModalAccounts() {
        newContactAccountSelect.innerHTML = '<option value="">Select Account</option>';
        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                newContactAccountSelect.appendChild(option);
            }
        });
    }

    // Add Account to selection
    function addAccount(id) {
        if (!selectedAccountIds.has(id)) {
            selectedAccountIds.add(id);
            renderSelectedAccounts();
            triggerAutoSave();
        }
        accountSearch.value = '';
        accountResults.style.display = 'none';
    }

    // Remove Account from selection
    function removeAccount(id) {
        selectedAccountIds.delete(id);
        renderSelectedAccounts();
        triggerAutoSave();
    }

    // Trigger auto-save
    function triggerAutoSave() {
        const form = document.getElementById('opportunityForm');
        if (form && form.dataset.autoSave) {
            const event = new Event('change', { bubbles: true });
            accountHiddenInputs.dispatchEvent(event);
        }
    }

    // Search functionality for Accounts
    accountSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 1) {
            accountResults.style.display = 'none';
            return;
        }

        // Filter accounts not already selected
        const matches = accounts
            .filter(a => a.name.toLowerCase().includes(query) && !selectedAccountIds.has(a.id))
            .slice(0, 10);

        if (matches.length === 0) {
            accountResults.innerHTML = '<div class="list-group-item text-muted">No matches found</div>';
        } else {
            accountResults.innerHTML = matches.map(a =>
                `<button type="button" class="list-group-item list-group-item-action" data-account-select-id="${a.id}">${a.name}</button>`
            ).join('');
        }
        accountResults.style.display = 'block';
    });

    // Select Account from dropdown
    accountResults.addEventListener('click', function(e) {
        const item = e.target.closest('[data-account-select-id]');
        if (item) {
            const id = parseInt(item.dataset.accountSelectId, 10);
            addAccount(id);
        }
    });

    // Remove Account pill click handler
    selectedAccountsDiv.addEventListener('click', function(e) {
        const closeBtn = e.target.closest('[data-account-id]');
        if (closeBtn) {
            const id = parseInt(closeBtn.dataset.accountId, 10);
            removeAccount(id);
        }
    });

    // Track Primary Contact changes
    primaryContactSelect.addEventListener('change', function() {
        currentPrimaryContactId = this.value;
    });

    // Save new Account
    document.getElementById('saveNewAccountBtn').addEventListener('click', async function() {
        const name = document.getElementById('new_account_name').value.trim();
        const phone = document.getElementById('new_account_phone').value.trim();
        const address = document.getElementById('new_account_address').value.trim();

        if (!name) {
            alert('Account name is required');
            return;
        }

        try {
            const response = await fetch('/accounts/api/quick-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, address })
            });

            if (response.ok) {
                const newAccount = await response.json();

                // Add to shared accounts list
                accounts.push({ id: newAccount.id, name: newAccount.name });

                // Add to selection
                addAccount(newAccount.id);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();

                // Clear form
                document.getElementById('new_account_name').value = '';
                document.getElementById('new_account_phone').value = '';
                document.getElementById('new_account_address').value = '';
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create account'));
            }
        } catch (err) {
            console.error('Failed to create account:', err);
            alert('Failed to create account');
        }
    });

    // Save new Contact
    document.getElementById('saveNewContactBtn').addEventListener('click', async function() {
        const accountId = document.getElementById('new_contact_account_id').value;
        const firstName = document.getElementById('new_contact_first_name').value.trim();
        const lastName = document.getElementById('new_contact_last_name').value.trim();
        const email = document.getElementById('new_contact_email').value.trim();
        const phone = document.getElementById('new_contact_phone').value.trim();

        if (!accountId) {
            alert('Account is required');
            return;
        }
        if (!firstName) {
            alert('First name is required');
            return;
        }
        if (!email && !phone) {
            alert('Email or phone is required');
            return;
        }

        try {
            const response = await fetch('/contacts/api/quick-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_id: parseInt(accountId, 10),
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    phone: phone
                })
            });

            if (response.ok) {
                const newContact = await response.json();

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();

                // Clear form
                document.getElementById('new_contact_account_id').value = '';
                document.getElementById('new_contact_first_name').value = '';
                document.getElementById('new_contact_last_name').value = '';
                document.getElementById('new_contact_email').value = '';
                document.getElementById('new_contact_phone').value = '';

                // Set current contact to new one
                currentPrimaryContactId = newContact.id.toString();

                // Refresh contacts dropdown
                await updatePrimaryContactOptions();

                // Select the new contact
                primaryContactSelect.value = newContact.id;

                // Trigger auto-save
                triggerAutoSave();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create contact'));
            }
        } catch (err) {
            console.error('Failed to create contact:', err);
            alert('Failed to create contact');
        }
    });

    // ========================================
    // SHARED: Hide dropdowns on outside click
    // ========================================
    document.addEventListener('click', function(e) {
        if (!accountSearch.contains(e.target) && !accountResults.contains(e.target)) {
            accountResults.style.display = 'none';
        }
    });

    // Initialize: render existing accounts
    renderSelectedAccounts();

    // Auto-save integration
    const form = document.getElementById('opportunityForm');
    const endpoint = form.dataset.autoSave;
    if (form && endpoint) {
        AutoSave.init(form, endpoint);
    }
})();
</script>
{% endblock %}
