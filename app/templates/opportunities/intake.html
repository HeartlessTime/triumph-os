{% extends "base.html" %}

{% block title %}New Opportunity - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/opportunities">Opportunities</a></li>
                <li class="breadcrumb-item active">New Opportunity</li>
            </ol>
        </nav>
        <h1>Opportunity Intake</h1>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-danger mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- Warning Alert with Override -->
    {% if warnings %}
    <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-circle me-2"></i><strong>Warning:</strong>
        <ul class="mb-2 mt-2">
            {% for w in warnings %}
            <li>{{ w }}</li>
            {% endfor %}
        </ul>
        <small>Click "Create Anyway" to proceed despite warnings.</small>
    </div>
    {% endif %}

    <form method="post" action="/opportunities/intake" enctype="multipart/form-data">
        <!-- Hidden field for warning override -->
        {% if warnings %}
        <input type="hidden" name="confirm_warnings" value="true">
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Opportunity Name - TOP -->
                <div class="card mb-4">
                    <div class="card-header">Opportunity Name</div>
                    <div class="card-body">
                        <input type="text" class="form-control form-control-lg" id="name" name="name"
                            value="{{ form_name if form_name is defined else '' }}"
                            required placeholder="e.g., Office Building Renovation - Main Campus">
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Basic Information</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="stage" class="form-label">Stage <span class="text-danger">*</span></label>
                                <select class="form-select" id="stage" name="stage" required>
                                    {% for stg, prob in stages %}
                                    <option value="{{ stg }}" {% if form_stage is defined and form_stage == stg %}selected{% elif stg == 'Prospecting' %}selected{% endif %}>{{ stg }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="project_type" class="form-label">Project Type</label>
                                <select class="form-select" id="project_type" name="project_type">
                                    <option value="">Select</option>
                                    <option value="Education / ISD">Education / ISD</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Office">Office</option>
                                    <option value="Religious">Religious</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Multi-Family">Multi-Family</option>
                                    <option value="Government">Government</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="account_id" class="form-label">End-User / Client <span class="text-danger">*</span></label>
                                <div class="position-relative">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="account_search"
                                            placeholder="Search or type to add..."
                                            autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="addClientBtn" data-bs-toggle="modal" data-bs-target="#addClientModal">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" id="account_id" name="account_id" value="{{ selected_account_id if selected_account_id else '' }}" required>
                                    <div id="account_results" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <div id="selected_account" class="mt-2 small text-success" style="display: none;">
                                    <i class="bi bi-check-circle me-1"></i><span></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="primary_contact_id" class="form-label">Primary Contact</label>
                                <select class="form-select" id="primary_contact_id" name="primary_contact_id">
                                    <option value="">Select Contact</option>
                                    {% for contact in contacts %}
                                    <option value="{{ contact.id }}">{{ contact.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Clients (GCs / Contractors)</label>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% for acc in accounts %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="gc_ids" value="{{ acc.id }}" id="gc_{{ acc.id }}">
                                        <label class="form-check-label" for="gc_{{ acc.id }}">{{ acc.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text">Select one or more clients bidding on this project.</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="rebid" name="rebid" value="true">
                                    <label class="form-check-label" for="rebid">Rebid / Revision</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Bid Instructions</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bid_type" class="form-label">Bid Type</label>
                                <select class="form-select" id="bid_type" name="bid_type">
                                    <option value="">Select</option>
                                    <option value="Hard Bid">Hard Bid</option>
                                    <option value="Budgetary">Budgetary</option>
                                    <option value="Design-Assist">Design-Assist</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="submission_method" class="form-label">Submission Method</label>
                                <select class="form-select" id="submission_method" name="submission_method">
                                    <option value="">Select</option>
                                    <option value="Email">Email</option>
                                    <option value="GC Portal">GC Portal</option>
                                    <option value="Public Portal">Public Portal</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_date" class="form-label">Bid Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="bid_date" name="bid_date"
                                    value="{{ form_bid_date if form_bid_date is defined else '' }}">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="bid_date_tbd" name="bid_date_tbd" value="true"
                                        {% if form_bid_date_tbd is defined and form_bid_date_tbd %}checked{% endif %}>
                                    <label class="form-check-label" for="bid_date_tbd">Bid date TBD</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_time" class="form-label">Bid Time</label>
                                <input type="time" class="form-control" id="bid_time" name="bid_time">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="prevailing_wage" name="prevailing_wage" value="Yes">
                                    <label class="form-check-label" for="prevailing_wage">Prevailing Wage</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="bond_required" name="bond_required" value="true">
                                    <label class="form-check-label" for="bond_required">Bond Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bid Form Required?</label>
                                <select class="form-select" id="bid_form_required" name="bid_form_required">
                                    <option value="">Select</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Job Walk / Pre-Bid Meeting Section -->
                <div class="card mb-4">
                    <div class="card-header">Job Walk / Pre-Bid Meeting</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="job_walk_required" name="job_walk_required" value="true">
                                    <label class="form-check-label" for="job_walk_required">Job Walk Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="job_walk_date" name="job_walk_date">
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_time" class="form-label">Time</label>
                                <input type="time" class="form-control" id="job_walk_time" name="job_walk_time">
                            </div>
                            <div class="col-12">
                                <label for="job_walk_notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="job_walk_notes" name="job_walk_notes" rows="2"
                                    placeholder="Location, parking instructions, contact person..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Plans & Documents</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="plans" class="form-label">Upload Plans / Specs / RFP</label>
                            <input type="file" class="form-control" id="plans" name="plans">
                        </div>
                        <div class="mb-3">
                            <label for="addenda" class="form-label">Upload Addenda</label>
                            <input type="file" class="form-control" id="addenda" name="addenda">
                        </div>
                        <div class="mb-3">
                            <label for="previous_estimate_file" class="form-label">Upload Previous Estimate (optional)</label>
                            <input type="file" class="form-control" id="previous_estimate_file" name="previous_estimate_file">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">Job Notes</div>
                    <div class="card-body">
                        <p class="text-muted small">Include project description, known risks, constraints, special notes, internal notes, etc.</p>
                        <textarea class="form-control" id="job_notes" name="job_notes" rows="5"
                            placeholder="Project details, tight schedule, partial design, union site, GC history, owner-furnished equipment...">{{ form_job_notes if form_job_notes is defined else '' }}</textarea>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Additional Details</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="source" class="form-label">Lead Source</label>
                                <select class="form-select" id="source" name="source">
                                    <option value="">Select Source</option>
                                    {% for src in sources %}
                                    <option value="{{ src }}">{{ src }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="quick_links_text" class="form-label">Quick Links (one per line)</label>
                                <textarea class="form-control" id="quick_links_text" name="quick_links_text" rows="2" placeholder="https://...
..."></textarea>
                                <div class="form-text">Links to bid portals or shared folders.</div>
                            </div>
                            <div class="col-12">
                                <label for="related_contact_ids" class="form-label">Related Contacts</label>
                                <select class="form-select" id="related_contact_ids" name="related_contact_ids" multiple>
                                    {% for c in contacts %}
                                    <option value="{{ c.id }}">{{ c.full_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select other contacts relevant to this project.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">Assignment</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="owner_id" class="form-label">Sales Owner <span class="text-danger">*</span></label>
                            <select class="form-select" id="owner_id" name="owner_id">
                                <option value="">Assign to me</option>
                                {% for u in sales_users %}
                                <option value="{{ u.id }}">{{ u.full_name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Leave blank to assign to yourself</small>
                        </div>
                    </div>
                </div>

                <!-- Help sidebar -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle me-1"></i> Required Fields</h6>
                        <p class="card-text small text-muted mb-0">
                            Fields marked with <span class="text-danger">*</span> are required:
                        </p>
                        <ul class="small text-muted mt-2 mb-0">
                            <li>Opportunity Name</li>
                            <li>Stage</li>
                            <li>End-User / Client</li>
                            <li>Bid Date (or check "TBD")</li>
                            <li>Sales Owner (defaults to you)</li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg me-1"></i>
                        {% if warnings %}Create Anyway{% else %}Create Opportunity{% endif %}
                    </button>
                    <a href="/opportunities" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Add New Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">
                    <i class="bi bi-building-add me-2"></i>Add New Client
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_client_name" class="form-label">Client Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="new_client_name" required>
                </div>
                <div class="mb-3">
                    <label for="new_client_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="new_client_email">
                </div>
                <div class="mb-3">
                    <label for="new_client_phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="new_client_phone">
                </div>
                <div class="mb-3">
                    <label for="new_client_address" class="form-label">Address</label>
                    <textarea class="form-control" id="new_client_address" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewClientBtn">
                    <i class="bi bi-check-lg me-1"></i>Save Client
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const accountSearch = document.getElementById('account_search');
    const accountIdInput = document.getElementById('account_id');
    const accountResults = document.getElementById('account_results');
    const selectedAccountDiv = document.getElementById('selected_account');
    const contactSelect = document.getElementById('primary_contact_id');

    // Store accounts data from server
    const accounts = [
        {% for acc in accounts %}
        { id: {{ acc.id }}, name: "{{ acc.name | replace('"', '\\"') }}" },
        {% endfor %}
    ];

    // Pre-populate if account already selected
    {% if selected_account_id %}
    const preselected = accounts.find(a => a.id === {{ selected_account_id }});
    if (preselected) {
        accountSearch.value = preselected.name;
        selectedAccountDiv.querySelector('span').textContent = preselected.name;
        selectedAccountDiv.style.display = 'block';
    }
    {% endif %}

    // Search functionality
    accountSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 1) {
            accountResults.style.display = 'none';
            return;
        }

        const matches = accounts.filter(a => a.name.toLowerCase().includes(query)).slice(0, 10);

        if (matches.length === 0) {
            accountResults.innerHTML = '<div class="list-group-item text-muted">No matches found</div>';
        } else {
            accountResults.innerHTML = matches.map(a =>
                `<button type="button" class="list-group-item list-group-item-action" data-id="${a.id}" data-name="${a.name}">${a.name}</button>`
            ).join('');
        }
        accountResults.style.display = 'block';
    });

    // Select account from dropdown
    accountResults.addEventListener('click', function(e) {
        const item = e.target.closest('[data-id]');
        if (item) {
            const id = item.dataset.id;
            const name = item.dataset.name;
            accountIdInput.value = id;
            accountSearch.value = name;
            selectedAccountDiv.querySelector('span').textContent = name;
            selectedAccountDiv.style.display = 'block';
            accountResults.style.display = 'none';

            // Load contacts for this account
            loadContactsForAccount(id);
        }
    });

    // Hide dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!accountSearch.contains(e.target) && !accountResults.contains(e.target)) {
            accountResults.style.display = 'none';
        }
    });

    // Load contacts for selected account
    async function loadContactsForAccount(accountId) {
        try {
            const response = await fetch(`/accounts/api/${accountId}/contacts`);
            if (response.ok) {
                const contacts = await response.json();
                contactSelect.innerHTML = '<option value="">Select Contact</option>';
                contacts.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.full_name;
                    contactSelect.appendChild(option);
                });
            }
        } catch (err) {
            console.error('Failed to load contacts:', err);
        }
    }

    // Save new client
    document.getElementById('saveNewClientBtn').addEventListener('click', async function() {
        const name = document.getElementById('new_client_name').value.trim();
        const email = document.getElementById('new_client_email').value.trim();
        const phone = document.getElementById('new_client_phone').value.trim();
        const address = document.getElementById('new_client_address').value.trim();

        if (!name) {
            alert('Client name is required');
            return;
        }

        try {
            const response = await fetch('/accounts/api/quick-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phone, address })
            });

            if (response.ok) {
                const newAccount = await response.json();

                // Add to local accounts list
                accounts.push({ id: newAccount.id, name: newAccount.name });

                // Select the new account
                accountIdInput.value = newAccount.id;
                accountSearch.value = newAccount.name;
                selectedAccountDiv.querySelector('span').textContent = newAccount.name;
                selectedAccountDiv.style.display = 'block';

                // Also add to GC checkbox list
                const gcList = document.querySelector('[name="gc_ids"]').closest('.border');
                const newCheckbox = document.createElement('div');
                newCheckbox.className = 'form-check';
                newCheckbox.innerHTML = `
                    <input class="form-check-input" type="checkbox" name="gc_ids" value="${newAccount.id}" id="gc_${newAccount.id}">
                    <label class="form-check-label" for="gc_${newAccount.id}">${newAccount.name}</label>
                `;
                gcList.appendChild(newCheckbox);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();

                // Clear form
                document.getElementById('new_client_name').value = '';
                document.getElementById('new_client_email').value = '';
                document.getElementById('new_client_phone').value = '';
                document.getElementById('new_client_address').value = '';
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create client'));
            }
        } catch (err) {
            console.error('Failed to create client:', err);
            alert('Failed to create client');
        }
    });
})();
</script>
{% endblock %}
