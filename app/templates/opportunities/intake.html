{% extends "base.html" %}

{% block title %}New Opportunity - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="tos-page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/opportunities">Opportunities</a></li>
                <li class="breadcrumb-item active">New Opportunity</li>
            </ol>
        </nav>
        <h1>Opportunity Intake</h1>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-danger mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- Warning Alert with Override -->
    {% if warnings %}
    <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-circle me-2"></i><strong>Warning:</strong>
        <ul class="mb-2 mt-2">
            {% for w in warnings %}
            <li>{{ w }}</li>
            {% endfor %}
        </ul>
        <small>Click "Create Anyway" to proceed despite warnings.</small>
    </div>
    {% endif %}

    <form method="post" action="/opportunities/intake">
        <!-- Hidden field for warning override -->
        {% if warnings %}
        <input type="hidden" name="confirm_warnings" value="true">
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Opportunity Name - TOP -->
                <div class="tos-card mb-3">
                    <div class="tos-section-header">Opportunity Name</div>
                    <div class="p-3">
                        <input type="text" class="form-control" id="name" name="name"
                            value="{{ form_name if form_name is defined else '' }}"
                            required placeholder="e.g., Office Building Renovation - Main Campus">
                    </div>
                </div>

                <div class="tos-card mb-3">
                    <div class="tos-section-header">Project Details</div>
                    <div class="p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="stage" class="form-label">Stage</label>
                                <select class="form-select" id="stage" name="stage">
                                    {% for stg, prob in stages %}
                                    <option value="{{ stg }}" {% if form_stage is defined and form_stage == stg %}selected{% elif stg == 'Prospecting' %}selected{% endif %}>{{ stg }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="project_type" class="form-label">Project Type</label>
                                <select class="form-select" id="project_type" name="project_type">
                                    <option value="">Select</option>
                                    <option value="Education / ISD">Education / ISD</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Office">Office</option>
                                    <option value="Religious">Religious</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Multi-Family">Multi-Family</option>
                                    <option value="Government">Government</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <!-- Accounts Multi-Select -->
                            <div class="col-12">
                                <label class="form-label">Accounts <span class="text-danger">*</span></label>
                                <div class="position-relative">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="account_search"
                                            placeholder="Search accounts..."
                                            autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <div id="account_results" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <!-- Selected Accounts displayed as pills -->
                                <div id="selected_accounts" class="mt-2 d-flex flex-wrap gap-1"></div>
                                <!-- Hidden inputs for selected Account IDs (dynamically added) -->
                                <div id="account_hidden_inputs"></div>
                                <div class="form-text">Select one or more accounts associated with this opportunity.</div>
                            </div>

                            <!-- Primary Account Selector -->
                            <div class="col-md-6">
                                <label for="primary_account_id" class="form-label">Primary Account <span class="text-danger">*</span></label>
                                <select class="form-select" id="primary_account_id" name="primary_account_id" disabled>
                                    <option value="">Select accounts first</option>
                                </select>
                                <div class="form-text text-muted" id="primary_account_hint">
                                    Select accounts above first.
                                </div>
                            </div>

                            <!-- Primary Contact Selector -->
                            <div class="col-md-6">
                                <label for="primary_contact_id" class="form-label">Primary Contact</label>
                                <div class="input-group">
                                    <select class="form-select" id="primary_contact_id" name="primary_contact_id" disabled>
                                        <option value="">Select accounts first</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="addContactBtn" data-bs-toggle="modal" data-bs-target="#addContactModal" disabled>
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                                <div class="form-text text-muted" id="primary_contact_hint">
                                    Select accounts to see available contacts.
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="rebid" name="rebid" value="true">
                                    <label class="form-check-label" for="rebid">Rebid / Revision</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tos-card mb-3">
                    <div class="tos-section-header">Bid Information</div>
                    <div class="p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="bid_type" class="form-label">Bid Type</label>
                                <select class="form-select" id="bid_type" name="bid_type">
                                    <option value="">Select</option>
                                    <option value="Hard Bid">Hard Bid</option>
                                    <option value="Budgetary">Budgetary</option>
                                    <option value="Design-Assist">Design-Assist</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="submission_method" class="form-label">Submission Method</label>
                                <select class="form-select" id="submission_method" name="submission_method">
                                    <option value="">Select</option>
                                    <option value="Email">Email</option>
                                    <option value="GC Portal">GC Portal</option>
                                    <option value="Public Portal">Public Portal</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="bid_date" class="form-label">Bid Date</label>
                                <input type="date" class="form-control" id="bid_date" name="bid_date"
                                    value="{{ form_bid_date if form_bid_date is defined else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="bid_time" class="form-label">Bid Time</label>
                                <input type="time" class="form-control" id="bid_time" name="bid_time">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="prevailing_wage" name="prevailing_wage" value="Yes">
                                    <label class="form-check-label" for="prevailing_wage">Prevailing Wage</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="bond_required" name="bond_required" value="true">
                                    <label class="form-check-label" for="bond_required">Bond Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bid Form Required?</label>
                                <select class="form-select" id="bid_form_required" name="bid_form_required">
                                    <option value="">Select</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Job Walk / Pre-Bid Meeting Section -->
                <div class="tos-card mb-3">
                    <div class="tos-section-header">Job Walk / Pre-Bid Meeting</div>
                    <div class="p-3">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="job_walk_required" name="job_walk_required" value="true">
                                    <label class="form-check-label" for="job_walk_required">Job Walk Required</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="job_walk_date" name="job_walk_date">
                            </div>
                            <div class="col-md-6">
                                <label for="job_walk_time" class="form-label">Time</label>
                                <input type="time" class="form-control" id="job_walk_time" name="job_walk_time">
                            </div>
                            <div class="col-12">
                                <label for="job_walk_notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="job_walk_notes" name="job_walk_notes" rows="2"
                                    placeholder="Location, parking instructions, contact person..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tos-card mb-3">
                    <div class="tos-section-header">Job Notes</div>
                    <div class="p-3">
                        <p class="tos-entity-sub mb-2">Include project description, known risks, constraints, special notes, internal notes, etc.</p>
                        <textarea class="form-control" id="job_notes" name="job_notes" rows="5"
                            placeholder="Project details, tight schedule, partial design, union site, history, owner-furnished equipment...">{{ form_job_notes if form_job_notes is defined else '' }}</textarea>
                    </div>
                </div>

                <div class="tos-card mb-3">
                    <div class="tos-section-header">Additional Details</div>
                    <div class="p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="source" class="form-label">Lead Source</label>
                                <select class="form-select" id="source" name="source">
                                    <option value="">Select Source</option>
                                    {% for src in sources %}
                                    <option value="{{ src }}">{{ src }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="quick_links_text" class="form-label">Quick Links (one per line)</label>
                                <textarea class="form-control" id="quick_links_text" name="quick_links_text" rows="2" placeholder="https://...
..."></textarea>
                                <div class="form-text">Links to bid portals or shared folders.</div>
                            </div>
                            <div class="col-12">
                                <label for="related_contact_ids" class="form-label">Related Contacts</label>
                                <select class="form-select" id="related_contact_ids" name="related_contact_ids" multiple>
                                    {% for c in contacts %}
                                    <option value="{{ c.id }}">{{ c.full_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select other contacts relevant to this project.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="tos-card mb-3">
                    <div class="tos-section-header">Assignment</div>
                    <div class="p-3">
                        <div class="mb-2">
                            <label for="owner_id" class="form-label">Sales Owner <span class="text-danger">*</span></label>
                            <select class="form-select" id="owner_id" name="owner_id">
                                <option value="">Assign to me</option>
                                {% for u in sales_users %}
                                <option value="{{ u.id }}">{{ u.full_name }}</option>
                                {% endfor %}
                            </select>
                            <small class="tos-entity-sub">Leave blank to assign to yourself</small>
                        </div>
                    </div>
                </div>

                <!-- Help sidebar -->
                <div class="tos-card mb-3" style="background: #f8fafc;">
                    <div class="p-3">
                        <h6 class="mb-2" style="font-size: 0.85rem;"><i class="bi bi-info-circle me-1"></i> Required Fields</h6>
                        <p class="tos-entity-sub mb-0">
                            Fields marked with <span class="text-danger">*</span> are required:
                        </p>
                        <ul class="tos-entity-sub mt-2 mb-0" style="padding-left: 1.25rem;">
                            <li>Opportunity Name</li>
                            <li>At least one Account</li>
                            <li>Primary Account</li>
                            <li>Bid Date (or check "TBD")</li>
                            <li>Sales Owner (defaults to you)</li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="tos-btn tos-btn-primary" style="padding: 0.75rem 1rem;">
                        <i class="bi bi-check-lg me-1"></i>
                        {% if warnings %}Create Anyway{% else %}Create Opportunity{% endif %}
                    </button>
                    <a href="/opportunities" class="tos-btn tos-btn-secondary" style="padding: 0.5rem 1rem; text-align: center;">Cancel</a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Add New Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAccountModalLabel">
                    <i class="bi bi-building-add me-2"></i>Add New Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_account_name" class="form-label">Account Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="new_account_name" required>
                </div>
                <div class="mb-3">
                    <label for="new_account_phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="new_account_phone">
                </div>
                <div class="mb-3">
                    <label for="new_account_address" class="form-label">Address</label>
                    <textarea class="form-control" id="new_account_address" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewAccountBtn">
                    <i class="bi bi-check-lg me-1"></i>Save & Add
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addContactModalLabel">
                    <i class="bi bi-person-add me-2"></i>Add New Contact
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new_contact_account_id" class="form-label">Account <span class="text-danger">*</span></label>
                    <select class="form-select" id="new_contact_account_id" required>
                        <option value="">Select Account</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="new_contact_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="new_contact_first_name" required>
                </div>
                <div class="mb-3">
                    <label for="new_contact_last_name" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="new_contact_last_name">
                </div>
                <div class="mb-3">
                    <label for="new_contact_email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="new_contact_email">
                </div>
                <div class="mb-3">
                    <label for="new_contact_phone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="new_contact_phone">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewContactBtn">
                    <i class="bi bi-check-lg me-1"></i>Save Contact
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // ========================================
    // SHARED: Accounts data from server
    // ========================================
    const accounts = [
        {% for acc in accounts %}
        { id: {{ acc.id }}, name: "{{ acc.name | replace('"', '\\"') }}" },
        {% endfor %}
    ];

    // ========================================
    // ACCOUNTS MULTI-SELECT
    // ========================================
    const accountSearch = document.getElementById('account_search');
    const accountResults = document.getElementById('account_results');
    const selectedAccountsDiv = document.getElementById('selected_accounts');
    const accountHiddenInputs = document.getElementById('account_hidden_inputs');
    const primaryAccountSelect = document.getElementById('primary_account_id');
    const primaryAccountHint = document.getElementById('primary_account_hint');
    const primaryContactSelect = document.getElementById('primary_contact_id');
    const primaryContactHint = document.getElementById('primary_contact_hint');
    const addContactBtn = document.getElementById('addContactBtn');
    const newContactAccountSelect = document.getElementById('new_contact_account_id');

    // Track selected Account IDs
    const selectedAccountIds = new Set();

    // Render selected Accounts as pills
    function renderSelectedAccounts() {
        selectedAccountsDiv.innerHTML = '';
        accountHiddenInputs.innerHTML = '';

        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                // Create pill
                const pill = document.createElement('span');
                pill.className = 'badge bg-primary d-inline-flex align-items-center gap-1';
                pill.innerHTML = `
                    ${account.name}
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" data-account-id="${id}" aria-label="Remove"></button>
                `;
                selectedAccountsDiv.appendChild(pill);

                // Create hidden input
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'account_ids';
                hidden.value = id;
                accountHiddenInputs.appendChild(hidden);
            }
        });

        // Update Primary Account dropdown
        updatePrimaryAccountOptions();
        // Update Primary Contact dropdown
        updatePrimaryContactOptions();
        // Update Add Contact modal account dropdown
        updateContactModalAccounts();
    }

    // Update Primary Account dropdown with selected accounts
    function updatePrimaryAccountOptions() {
        const currentValue = primaryAccountSelect.value;
        primaryAccountSelect.innerHTML = '';

        if (selectedAccountIds.size === 0) {
            primaryAccountSelect.innerHTML = '<option value="">Select accounts first</option>';
            primaryAccountSelect.disabled = true;
            primaryAccountHint.textContent = 'Select accounts above first.';
            primaryAccountHint.classList.remove('d-none');
            return;
        }

        primaryAccountSelect.innerHTML = '<option value="">Select Primary Account</option>';
        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                if (account.id.toString() === currentValue) {
                    option.selected = true;
                }
                primaryAccountSelect.appendChild(option);
            }
        });

        primaryAccountSelect.disabled = false;
        primaryAccountHint.classList.add('d-none');

        // Auto-select if only one account
        if (selectedAccountIds.size === 1) {
            primaryAccountSelect.value = Array.from(selectedAccountIds)[0];
        }
    }

    // Update Primary Contact dropdown from ALL selected accounts
    async function updatePrimaryContactOptions() {
        const accountIds = Array.from(selectedAccountIds);

        if (accountIds.length === 0) {
            primaryContactSelect.innerHTML = '<option value="">Select accounts first</option>';
            primaryContactSelect.disabled = true;
            addContactBtn.disabled = true;
            primaryContactHint.textContent = 'Select accounts to see available contacts.';
            primaryContactHint.classList.remove('d-none');
            return;
        }

        // Fetch contacts for all selected accounts
        try {
            const response = await fetch('/accounts/api/contacts-for-accounts?account_ids=' + accountIds.join(','));
            if (!response.ok) {
                throw new Error('Failed to fetch contacts');
            }

            const contacts = await response.json();
            const currentValue = primaryContactSelect.value;

            primaryContactSelect.innerHTML = '<option value="">Select Contact</option>';

            if (contacts.length === 0) {
                primaryContactHint.textContent = 'No contacts found for selected accounts.';
                primaryContactHint.classList.remove('d-none');
            } else {
                primaryContactHint.classList.add('d-none');
                contacts.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.display_name;
                    if (c.id.toString() === currentValue) {
                        option.selected = true;
                    }
                    primaryContactSelect.appendChild(option);
                });
            }

            primaryContactSelect.disabled = false;
            addContactBtn.disabled = false;

        } catch (err) {
            console.error('Failed to load contacts:', err);
            primaryContactHint.textContent = 'Error loading contacts.';
            primaryContactHint.classList.remove('d-none');
        }
    }

    // Update Add Contact modal account dropdown
    function updateContactModalAccounts() {
        newContactAccountSelect.innerHTML = '<option value="">Select Account</option>';
        selectedAccountIds.forEach(id => {
            const account = accounts.find(a => a.id === id);
            if (account) {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                newContactAccountSelect.appendChild(option);
            }
        });
    }

    // Add Account to selection
    function addAccount(id) {
        if (!selectedAccountIds.has(id)) {
            selectedAccountIds.add(id);
            renderSelectedAccounts();
        }
        accountSearch.value = '';
        accountResults.style.display = 'none';
    }

    // Remove Account from selection
    function removeAccount(id) {
        selectedAccountIds.delete(id);
        renderSelectedAccounts();
    }

    // Search functionality for Accounts
    accountSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 1) {
            accountResults.style.display = 'none';
            return;
        }

        // Filter accounts not already selected
        const matches = accounts
            .filter(a => a.name.toLowerCase().includes(query) && !selectedAccountIds.has(a.id))
            .slice(0, 10);

        if (matches.length === 0) {
            accountResults.innerHTML = '<div class="list-group-item text-muted">No matches found</div>';
        } else {
            accountResults.innerHTML = matches.map(a =>
                `<button type="button" class="list-group-item list-group-item-action" data-account-select-id="${a.id}">${a.name}</button>`
            ).join('');
        }
        accountResults.style.display = 'block';
    });

    // Select Account from dropdown
    accountResults.addEventListener('click', function(e) {
        const item = e.target.closest('[data-account-select-id]');
        if (item) {
            const id = parseInt(item.dataset.accountSelectId, 10);
            addAccount(id);
        }
    });

    // Remove Account pill click handler
    selectedAccountsDiv.addEventListener('click', function(e) {
        const closeBtn = e.target.closest('[data-account-id]');
        if (closeBtn) {
            const id = parseInt(closeBtn.dataset.accountId, 10);
            removeAccount(id);
        }
    });

    // Save new Account
    document.getElementById('saveNewAccountBtn').addEventListener('click', async function() {
        const name = document.getElementById('new_account_name').value.trim();
        const phone = document.getElementById('new_account_phone').value.trim();
        const address = document.getElementById('new_account_address').value.trim();

        if (!name) {
            alert('Account name is required');
            return;
        }

        try {
            const response = await fetch('/accounts/api/quick-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, address })
            });

            if (response.ok) {
                const newAccount = await response.json();

                // Add to shared accounts list
                accounts.push({ id: newAccount.id, name: newAccount.name });

                // Add to selection
                addAccount(newAccount.id);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();

                // Clear form
                document.getElementById('new_account_name').value = '';
                document.getElementById('new_account_phone').value = '';
                document.getElementById('new_account_address').value = '';
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create account'));
            }
        } catch (err) {
            console.error('Failed to create account:', err);
            alert('Failed to create account');
        }
    });

    // Save new Contact
    document.getElementById('saveNewContactBtn').addEventListener('click', async function() {
        const accountId = document.getElementById('new_contact_account_id').value;
        const firstName = document.getElementById('new_contact_first_name').value.trim();
        const lastName = document.getElementById('new_contact_last_name').value.trim();
        const email = document.getElementById('new_contact_email').value.trim();
        const phone = document.getElementById('new_contact_phone').value.trim();

        if (!accountId) {
            alert('Account is required');
            return;
        }
        if (!firstName) {
            alert('First name is required');
            return;
        }
        if (!email && !phone) {
            alert('Email or phone is required');
            return;
        }

        try {
            const response = await fetch('/contacts/api/quick-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_id: parseInt(accountId, 10),
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    phone: phone
                })
            });

            if (response.ok) {
                const newContact = await response.json();

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();

                // Clear form
                document.getElementById('new_contact_account_id').value = '';
                document.getElementById('new_contact_first_name').value = '';
                document.getElementById('new_contact_last_name').value = '';
                document.getElementById('new_contact_email').value = '';
                document.getElementById('new_contact_phone').value = '';

                // Refresh contacts dropdown
                await updatePrimaryContactOptions();

                // Select the new contact
                primaryContactSelect.value = newContact.id;
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create contact'));
            }
        } catch (err) {
            console.error('Failed to create contact:', err);
            alert('Failed to create contact');
        }
    });

    // ========================================
    // SHARED: Hide dropdowns on outside click
    // ========================================
    document.addEventListener('click', function(e) {
        if (!accountSearch.contains(e.target) && !accountResults.contains(e.target)) {
            accountResults.style.display = 'none';
        }
    });

    // Initialize
    renderSelectedAccounts();
})();
</script>
{% endblock %}
