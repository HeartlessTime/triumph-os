{% extends "base.html" %}

{% block title %}Weekly Summary - Triumph OS{% endblock %}

{% block extra_css %}
<style>
    /* Scrollable summary card body */
    .summary-card-body {
        max-height: 280px;
        overflow-y: auto;
    }
    .summary-card-body::-webkit-scrollbar {
        width: 6px;
    }
    .summary-card-body::-webkit-scrollbar-track {
        background: var(--bg-elevated);
        border-radius: 3px;
    }
    .summary-card-body::-webkit-scrollbar-thumb {
        background: var(--border-default);
        border-radius: 3px;
    }
    .summary-card-body::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }
    /* Clickable rows - hover styling */
    tr[data-href] {
        cursor: pointer;
    }
    tr[data-href]:hover td {
        background-color: rgba(0, 123, 255, 0.08);
    }
    /* Activity items - clickable styling */
    .activity-item[data-href] {
        cursor: pointer;
        transition: background-color 0.15s ease;
        padding: 0.5rem;
        margin: -0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
    }
    .activity-item[data-href]:hover {
        background-color: rgba(0, 123, 255, 0.08);
    }
    /* Pastel section header backgrounds */
    .section--summary .tos-section-header { background: var(--tint-summary); }
    .section--outreach .tos-section-header { background: var(--tint-outreach); }
    .section--pipeline .tos-section-header { background: var(--tint-pipeline); }
    .section--tasks .tos-section-header { background: var(--tint-tasks); }
    .section--site-visits .tos-section-header { background: var(--tint-activity); }
    .section--meetings .tos-section-header { background: var(--tint-meetings); }
    .section--activity .tos-section-header { background: var(--tint-meetings); }
    .section--notes .tos-section-header { background: var(--tint-notes); }
</style>
{% endblock %}

{% block content %}
<div class="content-area">
    <div class="tos-page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h1><i class="bi bi-clipboard-data me-2"></i>Weekly Summary</h1>
            <p>
                Week of {{ start_date.strftime('%B %d') }} – {{ end_date.strftime('%B %d, %Y') }}
                {% if is_current_week %}<span class="tos-badge-pending ms-2">Current Week</span>{% endif %}
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <button type="button" class="tos-btn tos-btn-success" id="copyToClipboard">
                <i class="bi bi-clipboard"></i> Copy to Clipboard
            </button>
            <a href="/summary/weekly?week_start={{ prev_week }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-chevron-left"></i> Prev
            </a>
            {% if not is_current_week %}
            <a href="/summary/weekly" class="tos-btn tos-btn-primary">
                <i class="bi bi-calendar-check"></i> Today
            </a>
            {% endif %}
            <a href="/summary/weekly?week_start={{ next_week }}" class="tos-btn tos-btn-secondary">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="tos-card mb-3 section--summary">
        <div class="tos-section-header">
            <i class="bi bi-bar-chart-line me-2"></i>Executive Summary
        </div>
        <div style="padding: 1rem;">
            <p class="mb-3" style="font-size: 0.95rem;">{{ summary_sentence }}</p>

            <div class="tos-quick-stats">
                <div class="tos-quick-stat">
                    <strong>{{ contacts_logged_count }}</strong>
                    <span>Contacts Logged</span>
                </div>
                <div class="tos-quick-stat">
                    <strong>{{ new_contacts_count }}</strong>
                    <span>New Contacts</span>
                </div>
                <div class="tos-quick-stat">
                    <strong>{{ new_accounts_count }}</strong>
                    <span>New Accounts</span>
                </div>
                <div class="tos-quick-stat">
                    <strong>{{ opportunities_touched_count }}</strong>
                    <span>Opps Touched</span>
                </div>
                <div class="tos-quick-stat">
                    <strong>{{ tasks_completed_count }}</strong>
                    <span>Tasks Done</span>
                </div>
                <div class="tos-quick-stat">
                    <strong>{{ activities_logged_count }}</strong>
                    <span>Activities</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- ROW 1: Outreach & Meetings -->
        <!-- Outreach & Follow-ups -->
        <div class="col-lg-6 d-flex">
            <div class="tos-card w-100 d-flex flex-column section--outreach">
                <div class="tos-section-header">
                    <i class="bi bi-telephone me-2"></i>Outreach & Follow-ups ({{ outreach_count }})
                </div>
                <div class="summary-card-body flex-grow-1" style="overflow-y: auto;">
                    {% if outreach_activities %}
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Contact</th>
                                <th>Account</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in outreach_activities %}
                            <tr data-href="/activities/{{ activity.id }}?from=/summary/weekly%3Fweek_start%3D{{ week_start }}">
                                <td>
                                    <span class="me-1">{{ activity.icon }}</span>
                                    {% if activity.contact %}
                                    <a href="/contacts/{{ activity.contact.id }}" class="tos-row-link tos-entity-name">
                                        {{ activity.contact.full_name }}
                                    </a>
                                    {% if activity.description %}
                                    <div class="tos-entity-sub text-truncate" style="max-width: 500px; font-style: italic;">{{ activity.description[:120] }}{% if activity.description|length > 120 %}...{% endif %}</div>
                                    {% endif %}
                                    {% else %}
                                    <span class="tos-entity-sub">{{ activity.subject }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if activity.contact and activity.contact.account %}
                                    <a href="/accounts/{{ activity.contact.account.id }}" class="tos-row-link tos-entity-sub">
                                        {{ activity.contact.account.name }}
                                    </a>
                                    {% else %}
                                    <span class="tos-entity-sub">-</span>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ activity.activity_date.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-telephone-x"></i>
                        <p>No outreach logged this period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Meetings This Week -->
        <div class="col-lg-6 d-flex">
            <div class="tos-card w-100 d-flex flex-column section--meetings">
                <div class="tos-section-header">
                    <i class="bi bi-calendar-check me-2"></i>Meetings This Week ({{ meetings|length }})
                </div>
                <div class="summary-card-body flex-grow-1" style="overflow-y: auto;">
                    {% if meetings %}
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Contact</th>
                                <th>Account</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meeting in meetings %}
                            <tr data-href="/activities/{{ meeting.id }}?from=/summary/weekly%3Fweek_start%3D{{ week_start }}">
                                <td>
                                    <span class="tos-entity-name">{{ meeting.attendees_display or meeting.subject }}</span>
                                    {% if meeting.description %}
                                    <div class="tos-entity-sub text-truncate" style="max-width: 200px; font-style: italic;">{{ meeting.description[:60] }}{% if meeting.description|length > 60 %}...{% endif %}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if meeting.contact and meeting.contact.account %}
                                    <a href="/accounts/{{ meeting.contact.account.id }}" class="tos-row-link tos-entity-sub">
                                        {{ meeting.contact.account.name }}
                                    </a>
                                    {% else %}
                                    <span class="tos-entity-sub">-</span>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ meeting.activity_date.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-calendar-x"></i>
                        <p>No meetings this period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ROW 2: Site Visits & Pipeline -->
        <!-- Site Visits This Week -->
        <div class="col-lg-6">
            <div class="tos-card h-100 d-flex flex-column section--site-visits">
                <div class="tos-section-header">
                    <i class="bi bi-geo-alt me-2"></i>Site Visits This Week ({{ site_visits|length }})
                </div>
                <div class="summary-card-body flex-grow-1" style="overflow-y: auto;">
                    {% if site_visits %}
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Purpose</th>
                                <th>Account / Opp</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in site_visits %}
                            <tr data-href="/activities/{{ visit.id }}?from=/summary/weekly%3Fweek_start%3D{{ week_start }}">
                                <td>
                                    <span class="tos-entity-name">{{ visit.subject or 'Site Visit' }}</span>
                                    {% if visit.contact %}
                                    <div class="tos-entity-sub">{{ visit.contact.full_name }}</div>
                                    {% endif %}
                                    {% if visit.description %}
                                    <div class="tos-entity-sub text-truncate" style="max-width: 180px; font-style: italic;">{{ visit.description[:50] }}{% if visit.description|length > 50 %}...{% endif %}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visit.opportunity %}
                                    <a href="/opportunities/{{ visit.opportunity.id }}" class="tos-row-link tos-entity-sub">
                                        {{ visit.opportunity.name }}
                                    </a>
                                    {% elif visit.contact and visit.contact.account %}
                                    <a href="/accounts/{{ visit.contact.account.id }}" class="tos-row-link tos-entity-sub">
                                        {{ visit.contact.account.name }}
                                    </a>
                                    {% else %}
                                    <span class="tos-entity-sub">—</span>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ visit.activity_date.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-geo-alt"></i>
                        <p>No site visits this period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pipeline Movement -->
        <div class="col-lg-6">
            <div class="tos-card h-100 d-flex flex-column section--pipeline">
                <div class="tos-section-header">
                    <i class="bi bi-arrow-left-right me-2"></i>Pipeline Movement
                </div>
                <div class="summary-card-body flex-grow-1" style="overflow-y: auto;">
                    {% if pipeline_changes %}
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Opportunity</th>
                                <th>Stage</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for opp in pipeline_changes %}
                            <tr>
                                <td>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-row-link tos-entity-name">
                                        {{ opp.name }}
                                    </a>
                                    <div class="tos-entity-sub">{{ opp.primary_account.name if opp.primary_account else 'No Account' }}</div>
                                </td>
                                <td>
                                    <span class="badge badge-stage badge-{{ opp.stage|lower|replace(' ', '-') }}">
                                        {{ opp.stage }}
                                    </span>
                                </td>
                                <td class="tos-entity-sub">{{ opp.updated_at.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No pipeline changes this period</p>
                    </div>
                    {% endif %}
                </div>
                <div style="padding: 0.5rem 0.75rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                    <textarea class="form-control form-control-sm auto-save-note" rows="2"
                        data-section="pipeline" data-note-type="team"
                        placeholder="Add notes about pipeline...">{{ section_notes.get('pipeline', '') }}</textarea>
                </div>
            </div>
        </div>

        <!-- ROW 3: Tasks & New Records -->
        <!-- Tasks Completed -->
        <div class="col-lg-6">
            <div class="tos-card h-100 d-flex flex-column section--tasks">
                <div class="tos-section-header">
                    <i class="bi bi-check2-square me-2"></i>Tasks Completed
                </div>
                <div class="summary-card-body flex-grow-1" style="overflow-y: auto;">
                    {% if tasks_completed %}
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Opportunity</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks_completed %}
                            <tr data-href="/tasks/{{ task.id }}/edit?from=/summary/weekly%3Fweek_start%3D{{ week_start }}">
                                <td>
                                    <span class="tos-entity-name">{{ task.title }}</span>
                                    {% if task.description %}
                                    <div class="tos-entity-sub text-truncate" style="max-width: 200px;">{{ task.description }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.opportunity %}
                                    <a href="/opportunities/{{ task.opportunity.id }}" class="tos-row-link tos-entity-sub">
                                        {{ task.opportunity.name }}
                                    </a>
                                    {% else %}
                                    <span class="tos-entity-sub">-</span>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ task.updated_at.strftime('%b %d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-list-task"></i>
                        <p>No tasks completed this period</p>
                    </div>
                    {% endif %}
                </div>
                <div style="padding: 0.5rem 0.75rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                    <textarea class="form-control form-control-sm auto-save-note" rows="2"
                        data-section="tasks" data-note-type="team"
                        placeholder="Add notes about tasks...">{{ section_notes.get('tasks', '') }}</textarea>
                </div>
            </div>
        </div>

        <!-- New Records Created -->
        <div class="col-lg-6">
            <div class="tos-card h-100 d-flex flex-column section--activity">
                <div class="tos-section-header">
                    <i class="bi bi-plus-circle me-2"></i>New Records Created
                </div>
                <div class="summary-card-body flex-grow-1" style="padding: 0.75rem; overflow-y: auto;">
                    <!-- New Accounts -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-building me-1"></i> Accounts ({{ new_accounts|length }})
                    </h6>
                    {% if new_accounts %}
                    <ul class="list-unstyled mb-3">
                        {% for acc in new_accounts %}
                        <li class="mb-1">
                            <a href="/accounts/{{ acc.id }}" class="text-decoration-none">{{ acc.name }}</a>
                            <span class="text-muted small">- {{ acc.created_at.strftime('%b %d') }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-3">None</p>
                    {% endif %}

                    <!-- New Contacts -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-person me-1"></i> Contacts ({{ new_contacts|length }})
                    </h6>
                    {% if new_contacts %}
                    <ul class="list-unstyled mb-3">
                        {% for contact in new_contacts %}
                        <li class="mb-1">
                            <a href="/contacts/{{ contact.id }}" class="text-decoration-none">{{ contact.full_name }}</a>
                            <span class="text-muted small">@ {{ contact.account.name }} - {{ contact.created_at.strftime('%b %d') }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-3">None</p>
                    {% endif %}

                    <!-- New Opportunities -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-bullseye me-1"></i> Opportunities ({{ new_opportunities|length }})
                    </h6>
                    {% if new_opportunities %}
                    <ul class="list-unstyled mb-0">
                        {% for opp in new_opportunities %}
                        <li class="mb-1">
                            <a href="/opportunities/{{ opp.id }}" class="text-decoration-none">{{ opp.name }}</a>
                            <span class="text-muted small">- {{ opp.created_at.strftime('%b %d') }}</span>
                            {% if opp.value %}
                            <span class="badge bg-success bg-opacity-10 text-success ms-1 currency">{{ opp.value }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="tos-entity-sub mb-0">None</p>
                    {% endif %}
                </div>
                <div style="padding: 0.5rem 0.75rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                    <textarea class="form-control form-control-sm auto-save-note" rows="2"
                        data-section="new_records" data-note-type="team"
                        placeholder="Add notes about new records...">{{ section_notes.get('new_records', '') }}</textarea>
                </div>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="col-12">
            <div class="tos-card section--activity">
                <div class="tos-section-header">
                    <i class="bi bi-clock-history me-2"></i>Recent Activity Timeline
                </div>
                <div class="summary-card-body" style="max-height: 320px; padding: 0.75rem; overflow-y: auto;">
                    {% if activities_logged %}
                    <div class="activity-timeline">
                        {% for activity in activities_logged %}
                        <div class="activity-item" data-href="/activities/{{ activity.id }}?from=/summary/weekly%3Fweek_start%3D{{ week_start }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="me-2">{{ activity.icon }}</span>
                                    <strong>{{ activity.subject }}</strong>
                                    {% if activity.contact %}
                                    <span class="text-muted">with
                                        <a href="/contacts/{{ activity.contact.id }}" class="text-decoration-none">{{ activity.contact.full_name }}</a>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ activity.activity_date | localtime('%b %d, %I:%M %p') }}</small>
                                </div>
                            </div>
                            {% if activity.opportunity %}
                            <div class="mt-1">
                                <a href="/opportunities/{{ activity.opportunity_id }}" class="text-muted small text-decoration-none">
                                    <i class="bi bi-bullseye me-1"></i>{{ activity.opportunity.name }}
                                </a>
                            </div>
                            {% endif %}
                            {% if activity.description %}
                            <p class="text-muted small mb-0 mt-1" style="max-width: 600px;">{{ activity.description[:150] }}{% if activity.description|length > 150 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="tos-empty-state">
                        <i class="bi bi-journal-x"></i>
                        <p>No activities logged this period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Other Notes -->
        <div class="col-12">
            <div class="tos-card section--notes">
                <div class="tos-section-header">
                    <i class="bi bi-journal-text me-2"></i>Other Notes
                </div>
                <div style="padding: 0.75rem;">
                    <textarea class="form-control form-control-sm auto-save-note" rows="3"
                        data-section="other" data-note-type="team"
                        placeholder="Add any other notes, observations, or highlights for this week...">{{ section_notes.get('other', '') }}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden summary data for clipboard -->
<div id="summaryData" style="display: none;">
    <div id="weekRange">{{ start_date.strftime('%B %d') }} – {{ end_date.strftime('%B %d, %Y') }}</div>

    <div id="outreachData">{% for activity in outreach_activities %}
- {{ activity.contact.full_name if activity.contact else activity.subject }} ({{ activity.contact.account.name if activity.contact and activity.contact.account else 'N/A' }}) - {{ activity.activity_date.strftime('%b %d') }}{% endfor %}</div>

    <div id="pipelineData">{% for opp in pipeline_changes %}
- {{ opp.name }} ({{ opp.primary_account.name if opp.primary_account else 'No Account' }}) - {{ opp.stage }}{% endfor %}</div>

    <div id="tasksData">{% for task in tasks_completed %}
- {{ task.title }}{% if task.opportunity %} ({{ task.opportunity.name }}){% endif %}{% endfor %}</div>

    <div id="newRecordsData">
Accounts: {% for acc in new_accounts %}{{ acc.name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}
Contacts: {% for contact in new_contacts %}{{ contact.full_name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}
Opportunities: {% for opp in new_opportunities %}{{ opp.name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}</div>

    <div id="outreachNotes">{{ section_notes.get('outreach', '') }}</div>
    <div id="pipelineNotes">{{ section_notes.get('pipeline', '') }}</div>
    <div id="tasksNotes">{{ section_notes.get('tasks', '') }}</div>
    <div id="newRecordsNotes">{{ section_notes.get('new_records', '') }}</div>
    <div id="otherNotes">{{ section_notes.get('other', '') }}</div>
</div>

<script>
// Build the current page URL for "back" navigation
const currentPageUrl = window.location.pathname + window.location.search;
const fromParam = '?from=' + encodeURIComponent(currentPageUrl);

// Clickable rows handler - navigates to edit page when row is clicked
// GUARDRAILS:
// - Does not interfere with links, buttons, or form elements inside the row
// - Only triggers on elements with data-href attribute
// - Single handler for both table rows and activity-item divs
// - Appends ?from= param for back navigation
document.addEventListener('click', function(e) {
    // Find the clickable element (row or activity-item)
    const clickable = e.target.closest('[data-href]');
    if (!clickable) return;

    // Ignore clicks on interactive elements inside the row
    // Also ignore modal triggers to let Bootstrap handle them
    if (e.target.closest('a, button, input, textarea, select, form, [data-bs-toggle]')) return;

    // Navigate with from param for back navigation
    const href = clickable.dataset.href;
    if (href.includes('from=')) {
        window.location.href = href;
    } else {
        const separator = href.includes('?') ? '&' : '?';
        window.location.href = href + separator + 'from=' + encodeURIComponent(currentPageUrl);
    }
});

// Add from param to all internal links on this page
document.querySelectorAll('a[href^="/"]').forEach(function(link) {
    // Skip links that already have a from param or are navigation links
    if (link.href.includes('from=') || link.href.includes('/summary/')) return;
    const href = link.getAttribute('href');
    const separator = href.includes('?') ? '&' : '?';
    link.setAttribute('href', href + separator + 'from=' + encodeURIComponent(currentPageUrl));
});

document.getElementById('copyToClipboard').addEventListener('click', function() {
    const weekRange = document.getElementById('weekRange').textContent.trim();
    const outreach = document.getElementById('outreachData').textContent.trim();
    const pipeline = document.getElementById('pipelineData').textContent.trim();
    const tasks = document.getElementById('tasksData').textContent.trim();
    const newRecords = document.getElementById('newRecordsData').textContent.trim();

    const outreachNotes = document.getElementById('outreachNotes').textContent.trim();
    const pipelineNotes = document.getElementById('pipelineNotes').textContent.trim();
    const tasksNotes = document.getElementById('tasksNotes').textContent.trim();
    const newRecordsNotes = document.getElementById('newRecordsNotes').textContent.trim();
    const otherNotes = document.getElementById('otherNotes').textContent.trim();

    let summary = `WEEKLY SUMMARY: ${weekRange}\n`;
    summary += '='.repeat(50) + '\n\n';

    summary += `OUTREACH & FOLLOW-UPS\n`;
    summary += '-'.repeat(30) + '\n';
    summary += outreach || 'No outreach logged this period';
    summary += '\n';
    if (outreachNotes) {
        summary += `\nNotes: ${outreachNotes}\n`;
    }
    summary += '\n';

    summary += `PIPELINE MOVEMENT\n`;
    summary += '-'.repeat(30) + '\n';
    summary += pipeline || 'No pipeline changes this period';
    summary += '\n';
    if (pipelineNotes) {
        summary += `\nNotes: ${pipelineNotes}\n`;
    }
    summary += '\n';

    summary += `TASKS COMPLETED\n`;
    summary += '-'.repeat(30) + '\n';
    summary += tasks || 'No tasks completed this period';
    summary += '\n';
    if (tasksNotes) {
        summary += `\nNotes: ${tasksNotes}\n`;
    }
    summary += '\n';

    summary += `NEW RECORDS CREATED\n`;
    summary += '-'.repeat(30) + '\n';
    summary += newRecords;
    summary += '\n';
    if (newRecordsNotes) {
        summary += `\nNotes: ${newRecordsNotes}\n`;
    }
    summary += '\n';

    if (otherNotes) {
        summary += `OTHER NOTES\n`;
        summary += '-'.repeat(30) + '\n';
        summary += otherNotes + '\n';
    }

    navigator.clipboard.writeText(summary).then(function() {
        const btn = document.getElementById('copyToClipboard');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i> Copied!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard');
    });
});
</script>

<!-- Auto-save notes script -->
<script>
(function() {
    const weekStart = '{{ week_start }}';
    let saveTimers = {};

    function flashBorder(el, success) {
        const color = success ? '#28a745' : '#dc3545';
        el.style.transition = 'border-color 0.15s ease';
        el.style.borderColor = color;
        setTimeout(function() {
            el.style.borderColor = '';
            setTimeout(function() { el.style.transition = ''; }, 150);
        }, 800);
    }

    function saveNote(textarea) {
        const section = textarea.dataset.section;
        const noteType = textarea.dataset.noteType;
        const notes = textarea.value;

        fetch('/summary/notes/auto-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week_start: weekStart,
                section: section,
                notes: notes,
                note_type: noteType
            })
        })
        .then(function(res) {
            if (res.ok) {
                flashBorder(textarea, true);
            } else {
                console.error('Auto-save failed:', res.status);
                flashBorder(textarea, false);
            }
        })
        .catch(function(err) {
            console.error('Auto-save error:', err);
            flashBorder(textarea, false);
        });
    }

    function debounce(textarea) {
        const key = textarea.dataset.section;
        if (saveTimers[key]) {
            clearTimeout(saveTimers[key]);
        }
        saveTimers[key] = setTimeout(function() {
            saveNote(textarea);
        }, 400);
    }

    document.querySelectorAll('.auto-save-note').forEach(function(textarea) {
        // Stop row click propagation
        textarea.addEventListener('click', function(e) { e.stopPropagation(); });
        textarea.addEventListener('mousedown', function(e) { e.stopPropagation(); });

        // Save on blur
        textarea.addEventListener('blur', function() {
            const key = textarea.dataset.section;
            if (saveTimers[key]) {
                clearTimeout(saveTimers[key]);
                delete saveTimers[key];
            }
            saveNote(textarea);
        });

        // Debounced save on input
        textarea.addEventListener('input', function() {
            debounce(textarea);
        });

        // Save on Enter (prevent newline, save immediately)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                textarea.blur();
            }
        });
    });
})();
</script>
{% endblock %}
