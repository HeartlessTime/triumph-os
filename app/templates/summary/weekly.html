{% extends "base.html" %}

{% block title %}Weekly Summary - Triumph OS{% endblock %}

{% block extra_css %}
<style>
    /* Scrollable summary card body */
    .summary-card-body {
        max-height: 280px;
        overflow-y: auto;
    }
    .summary-card-body::-webkit-scrollbar {
        width: 6px;
    }
    .summary-card-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .summary-card-body::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
    .summary-card-body::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }
    /* Clickable rows - hover styling */
    tr[data-href] {
        cursor: pointer;
    }
    tr[data-href]:hover td {
        background-color: rgba(0, 123, 255, 0.08);
    }
    /* Activity items - clickable styling */
    .activity-item[data-href] {
        cursor: pointer;
        transition: background-color 0.15s ease;
        padding: 0.5rem;
        margin: -0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
    }
    .activity-item[data-href]:hover {
        background-color: rgba(0, 123, 255, 0.08);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-area">
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-clipboard-data me-2"></i>Weekly Summary</h1>
            <p class="text-muted mb-0">
                Week of {{ start_date.strftime('%B %d') }} – {{ end_date.strftime('%B %d, %Y') }}
                {% if is_current_week %}<span class="badge bg-primary ms-2">Current Week</span>{% endif %}
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-success" id="copyToClipboard">
                <i class="bi bi-clipboard me-1"></i> Copy Summary to Clipboard
            </button>
            <a href="/summary/weekly?week_start={{ prev_week }}" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> Previous Week
            </a>
            {% if not is_current_week %}
            <a href="/summary/weekly" class="btn btn-outline-primary">
                <i class="bi bi-calendar-check"></i> Today
            </a>
            {% endif %}
            <a href="/summary/weekly?week_start={{ next_week }}" class="btn btn-outline-secondary">
                Next Week <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>Executive Summary</h5>
        </div>
        <div class="card-body">
            <p class="lead mb-4">{{ summary_sentence }}</p>

            <div class="row g-3">
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-primary">{{ contacts_logged_count }}</div>
                        <div class="text-muted small">Contacts Logged</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-success">{{ new_contacts_count }}</div>
                        <div class="text-muted small">New Contacts</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-info">{{ new_accounts_count }}</div>
                        <div class="text-muted small">New Accounts</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-warning">{{ opportunities_touched_count }}</div>
                        <div class="text-muted small">Opps Touched</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-danger">{{ tasks_completed_count }}</div>
                        <div class="text-muted small">Tasks Done</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2">
                    <div class="text-center p-3 border rounded">
                        <div class="h2 mb-0 text-secondary">{{ activities_logged_count }}</div>
                        <div class="text-muted small">Activities</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Outreach & Follow-ups -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-telephone me-2"></i>Outreach & Follow-ups ({{ outreach_count }})</h5>
                </div>
                <div class="card-body p-0 summary-card-body">
                    {% if outreach_activities %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Contact</th>
                                    <th>Account</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in outreach_activities %}
                                <tr data-href="/activities/{{ activity.id }}/edit">
                                    <td>
                                        <span class="me-1">{{ activity.icon }}</span>
                                        {% if activity.contact %}
                                        <a href="/contacts/{{ activity.contact.id }}" class="text-decoration-none">
                                            {{ activity.contact.full_name }}
                                        </a>
                                        {% if activity.contact.title %}
                                        <div class="text-muted small">{{ activity.contact.title }}</div>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">{{ activity.subject }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if activity.contact and activity.contact.account %}
                                        <a href="/accounts/{{ activity.contact.account.id }}" class="text-decoration-none text-muted">
                                            {{ activity.contact.account.name }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted small">{{ activity.activity_date.strftime('%b %d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-telephone-x h1"></i>
                        <p class="mb-0">No outreach logged this period</p>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <form action="/summary/weekly/notes" method="post" class="note-form">
                        <input type="hidden" name="week_start" value="{{ week_start }}">
                        <input type="hidden" name="section" value="outreach">
                        <input type="hidden" name="note_type" value="team">
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                            <textarea name="notes" class="form-control form-control-sm" rows="2" placeholder="Add notes about outreach...">{{ section_notes.get('outreach', '') }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-success">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pipeline Movement -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-arrow-left-right me-2"></i>Pipeline Movement</h5>
                </div>
                <div class="card-body p-0 summary-card-body">
                    {% if pipeline_changes %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Opportunity</th>
                                    <th>Stage</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for opp in pipeline_changes %}
                                <tr>
                                    <td>
                                        <a href="/opportunities/{{ opp.id }}" class="text-decoration-none">
                                            {{ opp.name }}
                                        </a>
                                        <div class="text-muted small">{{ opp.account.name }}</div>
                                    </td>
                                    <td>
                                        <span class="badge badge-stage badge-{{ opp.stage|lower|replace(' ', '-') }}">
                                            {{ opp.stage }}
                                        </span>
                                    </td>
                                    <td class="text-muted small">{{ opp.updated_at.strftime('%b %d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox h1"></i>
                        <p class="mb-0">No pipeline changes this period</p>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <form action="/summary/weekly/notes" method="post" class="note-form">
                        <input type="hidden" name="week_start" value="{{ week_start }}">
                        <input type="hidden" name="section" value="pipeline">
                        <input type="hidden" name="note_type" value="team">
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                            <textarea name="notes" class="form-control form-control-sm" rows="2" placeholder="Add notes about pipeline...">{{ section_notes.get('pipeline', '') }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-warning">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tasks Completed -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Tasks Completed</h5>
                </div>
                <div class="card-body p-0 summary-card-body">
                    {% if tasks_completed %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Task</th>
                                    <th>Opportunity</th>
                                    <th>Completed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks_completed %}
                                <tr data-href="/tasks/{{ task.id }}/edit">
                                    <td>
                                        {{ task.title }}
                                        {% if task.description %}
                                        <div class="text-muted small text-truncate" style="max-width: 200px;">{{ task.description }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.opportunity %}
                                        <a href="/opportunities/{{ task.opportunity.id }}" class="text-decoration-none text-muted">
                                            {{ task.opportunity.name }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted small">{{ task.updated_at.strftime('%b %d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-list-task h1"></i>
                        <p class="mb-0">No tasks completed this period</p>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <form action="/summary/weekly/notes" method="post" class="note-form">
                        <input type="hidden" name="week_start" value="{{ week_start }}">
                        <input type="hidden" name="section" value="tasks">
                        <input type="hidden" name="note_type" value="team">
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                            <textarea name="notes" class="form-control form-control-sm" rows="2" placeholder="Add notes about tasks...">{{ section_notes.get('tasks', '') }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-danger">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- New Records Created -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>New Records Created</h5>
                </div>
                <div class="card-body summary-card-body">
                    <!-- New Accounts -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-building me-1"></i> Accounts ({{ new_accounts|length }})
                    </h6>
                    {% if new_accounts %}
                    <ul class="list-unstyled mb-3">
                        {% for acc in new_accounts %}
                        <li class="mb-1">
                            <a href="/accounts/{{ acc.id }}" class="text-decoration-none">{{ acc.name }}</a>
                            <span class="text-muted small">- {{ acc.created_at.strftime('%b %d') }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-3">None</p>
                    {% endif %}

                    <!-- New Contacts -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-person me-1"></i> Contacts ({{ new_contacts|length }})
                    </h6>
                    {% if new_contacts %}
                    <ul class="list-unstyled mb-3">
                        {% for contact in new_contacts %}
                        <li class="mb-1">
                            <a href="/contacts/{{ contact.id }}" class="text-decoration-none">{{ contact.full_name }}</a>
                            <span class="text-muted small">@ {{ contact.account.name }} - {{ contact.created_at.strftime('%b %d') }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-3">None</p>
                    {% endif %}

                    <!-- New Opportunities -->
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-bullseye me-1"></i> Opportunities ({{ new_opportunities|length }})
                    </h6>
                    {% if new_opportunities %}
                    <ul class="list-unstyled mb-0">
                        {% for opp in new_opportunities %}
                        <li class="mb-1">
                            <a href="/opportunities/{{ opp.id }}" class="text-decoration-none">{{ opp.name }}</a>
                            <span class="text-muted small">- {{ opp.created_at.strftime('%b %d') }}</span>
                            {% if opp.value %}
                            <span class="badge bg-success bg-opacity-10 text-success ms-1 currency">{{ opp.value }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-0">None</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <form action="/summary/weekly/notes" method="post" class="note-form">
                        <input type="hidden" name="week_start" value="{{ week_start }}">
                        <input type="hidden" name="section" value="new_records">
                        <input type="hidden" name="note_type" value="team">
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-1"><i class="bi bi-pencil me-1"></i>Notes</label>
                            <textarea name="notes" class="form-control form-control-sm" rows="2" placeholder="Add notes about new records...">{{ section_notes.get('new_records', '') }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-info">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity Timeline</h5>
                </div>
                <div class="card-body summary-card-body" style="max-height: 320px;">
                    {% if activities_logged %}
                    <div class="activity-timeline">
                        {% for activity in activities_logged %}
                        <div class="activity-item" data-href="/activities/{{ activity.id }}/edit">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="me-2">{{ activity.icon }}</span>
                                    <strong>{{ activity.subject }}</strong>
                                    {% if activity.contact %}
                                    <span class="text-muted">with
                                        <a href="/contacts/{{ activity.contact.id }}" class="text-decoration-none">{{ activity.contact.full_name }}</a>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ activity.activity_date.strftime('%b %d, %I:%M %p') }}</small>
                                </div>
                            </div>
                            {% if activity.opportunity %}
                            <div class="mt-1">
                                <a href="/opportunities/{{ activity.opportunity_id }}" class="text-muted small text-decoration-none">
                                    <i class="bi bi-bullseye me-1"></i>{{ activity.opportunity.name }}
                                </a>
                            </div>
                            {% endif %}
                            {% if activity.description %}
                            <p class="text-muted small mb-0 mt-1" style="max-width: 600px;">{{ activity.description[:150] }}{% if activity.description|length > 150 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-journal-x h1"></i>
                        <p class="mb-0">No activities logged this period</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Other Notes -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Other Notes</h5>
                </div>
                <div class="card-body">
                    <form action="/summary/weekly/notes" method="post" class="note-form">
                        <input type="hidden" name="week_start" value="{{ week_start }}">
                        <input type="hidden" name="section" value="other">
                        <input type="hidden" name="note_type" value="team">
                        <div class="mb-3">
                            <textarea name="notes" class="form-control" rows="4" placeholder="Add any other notes, observations, or highlights for this week...">{{ section_notes.get('other', '') }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-outline-dark">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden summary data for clipboard -->
<div id="summaryData" style="display: none;">
    <div id="weekRange">{{ start_date.strftime('%B %d') }} – {{ end_date.strftime('%B %d, %Y') }}</div>

    <div id="outreachData">{% for activity in outreach_activities %}
- {{ activity.contact.full_name if activity.contact else activity.subject }} ({{ activity.contact.account.name if activity.contact and activity.contact.account else 'N/A' }}) - {{ activity.activity_date.strftime('%b %d') }}{% endfor %}</div>

    <div id="pipelineData">{% for opp in pipeline_changes %}
- {{ opp.name }} ({{ opp.account.name }}) - {{ opp.stage }}{% endfor %}</div>

    <div id="tasksData">{% for task in tasks_completed %}
- {{ task.title }}{% if task.opportunity %} ({{ task.opportunity.name }}){% endif %}{% endfor %}</div>

    <div id="newRecordsData">
Accounts: {% for acc in new_accounts %}{{ acc.name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}
Contacts: {% for contact in new_contacts %}{{ contact.full_name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}
Opportunities: {% for opp in new_opportunities %}{{ opp.name }}{% if not loop.last %}, {% endif %}{% else %}None{% endfor %}</div>

    <div id="outreachNotes">{{ section_notes.get('outreach', '') }}</div>
    <div id="pipelineNotes">{{ section_notes.get('pipeline', '') }}</div>
    <div id="tasksNotes">{{ section_notes.get('tasks', '') }}</div>
    <div id="newRecordsNotes">{{ section_notes.get('new_records', '') }}</div>
    <div id="otherNotes">{{ section_notes.get('other', '') }}</div>
</div>

<script>
// Build the current page URL for "back" navigation
const currentPageUrl = window.location.pathname + window.location.search;
const fromParam = '?from=' + encodeURIComponent(currentPageUrl);

// Clickable rows handler - navigates to edit page when row is clicked
// GUARDRAILS:
// - Does not interfere with links, buttons, or form elements inside the row
// - Only triggers on elements with data-href attribute
// - Single handler for both table rows and activity-item divs
// - Appends ?from= param for back navigation
document.addEventListener('click', function(e) {
    // Find the clickable element (row or activity-item)
    const clickable = e.target.closest('[data-href]');
    if (!clickable) return;

    // Ignore clicks on interactive elements inside the row
    // Also ignore modal triggers to let Bootstrap handle them
    if (e.target.closest('a, button, input, textarea, select, form, [data-bs-toggle]')) return;

    // Navigate to the edit page with from param for back navigation
    const href = clickable.dataset.href;
    const separator = href.includes('?') ? '&' : '?';
    window.location.href = href + separator + 'from=' + encodeURIComponent(currentPageUrl);
});

// Add from param to all internal links on this page
document.querySelectorAll('a[href^="/"]').forEach(function(link) {
    // Skip links that already have a from param or are navigation links
    if (link.href.includes('from=') || link.href.includes('/summary/')) return;
    const href = link.getAttribute('href');
    const separator = href.includes('?') ? '&' : '?';
    link.setAttribute('href', href + separator + 'from=' + encodeURIComponent(currentPageUrl));
});

document.getElementById('copyToClipboard').addEventListener('click', function() {
    const weekRange = document.getElementById('weekRange').textContent.trim();
    const outreach = document.getElementById('outreachData').textContent.trim();
    const pipeline = document.getElementById('pipelineData').textContent.trim();
    const tasks = document.getElementById('tasksData').textContent.trim();
    const newRecords = document.getElementById('newRecordsData').textContent.trim();

    const outreachNotes = document.getElementById('outreachNotes').textContent.trim();
    const pipelineNotes = document.getElementById('pipelineNotes').textContent.trim();
    const tasksNotes = document.getElementById('tasksNotes').textContent.trim();
    const newRecordsNotes = document.getElementById('newRecordsNotes').textContent.trim();
    const otherNotes = document.getElementById('otherNotes').textContent.trim();

    let summary = `WEEKLY SUMMARY: ${weekRange}\n`;
    summary += '='.repeat(50) + '\n\n';

    summary += `OUTREACH & FOLLOW-UPS\n`;
    summary += '-'.repeat(30) + '\n';
    summary += outreach || 'No outreach logged this period';
    summary += '\n';
    if (outreachNotes) {
        summary += `\nNotes: ${outreachNotes}\n`;
    }
    summary += '\n';

    summary += `PIPELINE MOVEMENT\n`;
    summary += '-'.repeat(30) + '\n';
    summary += pipeline || 'No pipeline changes this period';
    summary += '\n';
    if (pipelineNotes) {
        summary += `\nNotes: ${pipelineNotes}\n`;
    }
    summary += '\n';

    summary += `TASKS COMPLETED\n`;
    summary += '-'.repeat(30) + '\n';
    summary += tasks || 'No tasks completed this period';
    summary += '\n';
    if (tasksNotes) {
        summary += `\nNotes: ${tasksNotes}\n`;
    }
    summary += '\n';

    summary += `NEW RECORDS CREATED\n`;
    summary += '-'.repeat(30) + '\n';
    summary += newRecords;
    summary += '\n';
    if (newRecordsNotes) {
        summary += `\nNotes: ${newRecordsNotes}\n`;
    }
    summary += '\n';

    if (otherNotes) {
        summary += `OTHER NOTES\n`;
        summary += '-'.repeat(30) + '\n';
        summary += otherNotes + '\n';
    }

    navigator.clipboard.writeText(summary).then(function() {
        const btn = document.getElementById('copyToClipboard');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i> Copied!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard');
    });
});
</script>
{% endblock %}
