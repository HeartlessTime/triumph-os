{% extends "base.html" %}

{% set return_to = request.query_params.get('from') %}

{% block title %}{{ activity.subject }} - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="page-header">
        {% if return_to %}
        <div class="mb-2">
            <a href="{{ return_to }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
        </div>
        {% endif %}

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                {% if activity.opportunity %}
                <li class="breadcrumb-item"><a href="/opportunities">Opportunities</a></li>
                <li class="breadcrumb-item"><a href="/opportunities/{{ activity.opportunity_id }}">{{ activity.opportunity.name }}</a></li>
                {% elif activity.contact %}
                <li class="breadcrumb-item"><a href="/contacts">Contacts</a></li>
                <li class="breadcrumb-item"><a href="/contacts/{{ activity.contact_id }}">{{ activity.contact.full_name }}</a></li>
                {% else %}
                <li class="breadcrumb-item"><a href="/summary/my-weekly">Summary</a></li>
                {% endif %}
                <li class="breadcrumb-item active">{{ activity.subject }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h1>{{ activity.subject }}</h1>
            <div class="d-flex gap-2">
                <a href="/activities/{{ activity.id }}/edit{% if return_to %}?from={{ return_to | urlencode }}{% endif %}" class="tos-btn tos-btn-primary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <form method="post" action="/activities/{{ activity.id }}/delete{% if return_to %}?from={{ return_to | urlencode }}{% endif %}" class="d-inline" onsubmit="return confirm('Delete this activity? This cannot be undone.');">
                    <button type="submit" class="tos-btn tos-btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-info-circle me-1"></i>Details
                </div>
                <div class="p-3">
                    <dl class="mb-0" style="font-size: 0.9rem;">
                        <dt class="tos-entity-sub">Type</dt>
                        <dd class="mb-3">{{ activity.type_display }}</dd>

                        <dt class="tos-entity-sub">Date & Time</dt>
                        <dd class="mb-3">{{ activity.activity_date.strftime('%A, %B %d, %Y at %I:%M %p') }}</dd>

                        {% if activity.contact and activity.activity_type != 'meeting' %}
                        <dt class="tos-entity-sub">Contact</dt>
                        <dd class="mb-3">
                            <a href="/contacts/{{ activity.contact_id }}" class="tos-row-link">{{ activity.contact.full_name }}</a>
                            {% if activity.contact.account %}
                            <span class="tos-entity-sub ms-1">
                                (<a href="/accounts/{{ activity.contact.account_id }}" class="tos-row-link">{{ activity.contact.account.name }}</a>)
                            </span>
                            {% endif %}
                        </dd>
                        {% endif %}

                        {% if activity.opportunity %}
                        <dt class="tos-entity-sub">Opportunity</dt>
                        <dd class="mb-3">
                            <a href="/opportunities/{{ activity.opportunity_id }}" class="tos-row-link">{{ activity.opportunity.name }}</a>
                        </dd>
                        {% endif %}

                        {% if activity.description %}
                        <dt class="tos-entity-sub">{% if activity.activity_type == 'meeting' %}Meeting Summary{% else %}Notes{% endif %}</dt>
                        <dd class="mb-3" style="white-space: pre-line;">{{ activity.description }}</dd>
                        {% endif %}

                        {% if activity.requires_estimate %}
                        <dt class="tos-entity-sub" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-default);">
                            <i class="bi bi-clipboard-check me-1"></i>Estimating Details
                        </dt>
                        <dd class="mb-2">
                            <span class="badge {% if activity.estimate_status in ('overdue', 'due_today') %}bg-danger{% elif activity.estimate_status == 'completed' %}bg-success{% elif activity.estimate_status == 'due_soon' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                {% if activity.estimate_status == 'overdue' %}Overdue{% elif activity.estimate_status == 'due_today' %}Due Today{% elif activity.estimate_status == 'completed' %}Estimate Completed{% elif activity.estimate_status == 'due_soon' %}Due Soon{% else %}Pending Estimate{% endif %}
                            </span>
                        </dd>

                        {% if activity.scope_summary %}
                        <dt class="tos-entity-sub">Scope Summary</dt>
                        <dd class="mb-2" style="white-space: pre-line;">{{ activity.scope_summary }}</dd>
                        {% endif %}

                        {% if activity.complexity_notes %}
                        <dt class="tos-entity-sub">Complexity Notes</dt>
                        <dd class="mb-2" style="white-space: pre-line;">{{ activity.complexity_notes }}</dd>
                        {% endif %}

                        {% if activity.estimate_needed_by %}
                        <dt class="tos-entity-sub">Estimate Needed By</dt>
                        <dd class="mb-2">
                            <span class="{% if activity.estimate_status in ('overdue', 'due_today') %}text-danger fw-bold{% elif activity.estimate_status == 'due_soon' %}text-warning{% endif %}">
                                {{ activity.estimate_needed_by.strftime('%b %d, %Y') }}
                            </span>
                            {% if activity.days_until_estimate_needed is not none and not activity.estimate_completed %}
                            <span class="text-muted small ms-1">
                                ({% if activity.days_until_estimate_needed < 0 %}{{ activity.days_until_estimate_needed|abs }}d overdue{% elif activity.days_until_estimate_needed == 0 %}due today{% else %}in {{ activity.days_until_estimate_needed }}d{% endif %})
                            </span>
                            {% endif %}
                        </dd>
                        {% endif %}

                        {% if activity.estimate_completed_at %}
                        <dt class="tos-entity-sub">Estimate Received</dt>
                        <dd class="mb-2 text-success">{{ activity.estimate_completed_at.strftime('%b %d, %Y') }}</dd>
                        {% endif %}

                        {% if activity.assigned_estimator %}
                        <dt class="tos-entity-sub">Assigned Estimator</dt>
                        <dd class="mb-0">{{ activity.assigned_estimator.full_name }}</dd>
                        {% endif %}
                        {% endif %}

                        {% if activity.activity_type == 'job_walk' %}
                        <dt class="tos-entity-sub" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-default);">
                            <i class="bi bi-signpost-2 me-1"></i>Areas ({{ activity.walk_segments|length }})
                        </dt>
                        {% if activity.walk_segments %}
                        <dd class="mb-2">
                            {% for seg in activity.walk_segments %}
                            <div style="padding: 0.35rem 0; {% if not loop.last %}border-bottom: 1px solid var(--border-subtle);{% endif %}">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">{{ loop.index }}.</span>
                                <strong style="font-size: 0.85rem;">{{ seg.location_name }}</strong>
                                {% if seg.quantity_label %}<span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.25rem;">{{ seg.quantity_label }}</span>{% endif %}
                                {% if seg.estimated_cable_length %}<span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.25rem;">Â· {{ seg.estimated_cable_length }} ft</span>{% endif %}
                                {% if seg.description %}<div style="font-size: 0.8rem; color: var(--text-muted);">{{ seg.description }}</div>{% endif %}
                            </div>
                            {% endfor %}
                        </dd>
                        {% endif %}
                        <dd>
                            <a href="/job-walks/{{ activity.id }}?from=/activities/{{ activity.id }}" class="tos-btn tos-btn-sm tos-btn-secondary">
                                <i class="bi bi-signpost-2 me-1"></i>Open Job Walk
                            </a>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>

        {% if activity.activity_type == 'meeting' and activity.attendees %}
        <div class="col-lg-4">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-people me-1"></i>Attendees
                </div>
                <div class="p-3">
                    {% for contact in activity.attendees %}
                    <div class="{% if not loop.last %}mb-2 pb-2 border-bottom{% endif %}">
                        <a href="/contacts/{{ contact.id }}" class="tos-row-link tos-entity-name">{{ contact.full_name }}</a>
                        {% if contact.title %}
                        <div class="tos-entity-sub">{{ contact.title }}</div>
                        {% endif %}
                        {% if contact.account %}
                        <div class="tos-entity-sub">
                            <a href="/accounts/{{ contact.account_id }}" class="tos-row-link">{{ contact.account.name }}</a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
