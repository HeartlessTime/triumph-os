{% extends "base.html" %}

{% block title %}Commissions - Triumph OS{% endblock %}

{% block extra_css %}
<style>
    .month-nav { display: flex; align-items: center; gap: 0.5rem; }
    .commission-total { font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
    .search-wrap { position: relative; }
    .search-results {
        position: absolute; z-index: 1055; top: 100%; left: 0; right: 0;
        max-height: 200px; overflow-y: auto;
        background: var(--bg-surface); border: 1px solid var(--border-default);
        border-radius: 6px; display: none;
    }
    .search-results.show { display: block; }
    .search-results .sr-item {
        cursor: pointer; padding: 0.35rem 0.65rem; font-size: 0.85rem;
        background: var(--bg-surface); color: var(--text-primary);
        border-bottom: 1px solid var(--border-default);
    }
    .search-results .sr-item:hover { background: var(--bg-hover); }
    .search-results .sr-item:last-child { border-bottom: none; }

    /* Job status badges – theme-aware */
    .job-status-badge {
        display: inline-block; padding: 0.2em 0.55em; border-radius: 4px;
        font-size: 0.75rem; font-weight: 500; cursor: pointer; user-select: none;
        position: relative;
    }
    .job-status-badge:hover { filter: brightness(1.15); }
    .job-status-badge[data-status="Won"]          { background: var(--success-bg); color: var(--success-text); }
    .job-status-badge[data-status="Pending"]       { background: var(--warning-bg); color: var(--warning-text); }
    .job-status-badge[data-status="Did Not Win"]   { background: var(--danger-bg);  color: var(--danger-text); }

    /* Inline status picker – fixed to viewport so it can't be clipped */
    .status-picker {
        position: fixed; z-index: 9999;
        background: var(--bg-surface); border: 1px solid var(--border-default);
        border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,.25);
        min-width: 130px; display: none;
    }
    .status-picker.show { display: block; }
    .status-picker-item {
        padding: 0.35rem 0.65rem; font-size: 0.82rem; cursor: pointer;
        color: var(--text-primary); border-bottom: 1px solid var(--border-default);
    }
    .status-picker-item:last-child { border-bottom: none; }
    .status-picker-item:hover { background: var(--bg-hover); }
</style>
{% endblock %}

{% block content %}
<div class="content-area">
    <div class="tos-page-header d-flex justify-content-between align-items-center">
        <div>
            <h1>Commission Tracker</h1>
            <p>Track commission entries</p>
        </div>
        <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#commissionModal" onclick="openAddModal()">
            <i class="bi bi-plus-lg"></i> Add Entry
        </button>
    </div>

    {# Macro to build sort URLs preserving month + search #}
    {% set _base = "/commissions?month=" ~ selected_month %}
    {% if search %}{% set _base = _base ~ "&search=" ~ search %}{% endif %}

    <!-- Controls -->
    <div class="tos-controls">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="month-nav">
                <a href="/commissions?month={{ prev_month }}" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <span class="fw-semibold">{{ month_label }}</span>
                <a href="/commissions?month={{ next_month }}" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>

            <!-- Search -->
            <div class="input-group" style="max-width:260px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control form-control-sm" id="commissionSearch"
                       placeholder="Search jobs..." value="{{ search }}">
            </div>

            <div class="ms-auto d-flex align-items-center gap-3">
                {% if entries %}
                <span class="commission-total commission-total-pending" style="color: var(--warning-text);">Total (Pending): ${{ "{:,.2f}".format(pending_commission | float) }}</span>
                <span class="commission-total commission-total-won">Total (Won): ${{ "{:,.2f}".format(total_commission | float) }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Sort Controls -->
        <div class="d-flex gap-2 align-items-center mt-2">
            <span class="text-muted small me-1">Sort:</span>
            {% set acct_dir = 'desc' if sort == 'account' and dir == 'asc' else 'asc' %}
            <a href="{{ _base }}&sort=account&dir={{ acct_dir }}"
               class="tos-sort-btn {% if sort == 'account' or not sort %}active{% endif %}">
                Account <i class="bi {% if sort == 'account' and dir == 'desc' %}bi-sort-alpha-up{% else %}bi-sort-alpha-down{% endif %} sort-icon"></i>
            </a>
            {% set lc_dir = 'asc' if sort == 'last_contacted' and dir == 'desc' else 'desc' %}
            <a href="{{ _base }}&sort=last_contacted&dir={{ lc_dir }}"
               class="tos-sort-btn {% if sort == 'last_contacted' %}active{% endif %}">
                Last Contacted <i class="bi {% if sort == 'last_contacted' and dir == 'asc' %}bi-sort-up{% else %}bi-sort-down{% endif %} sort-icon"></i>
            </a>
            {% set amt_dir = 'asc' if sort == 'job_amount' and dir == 'desc' else 'desc' %}
            <a href="{{ _base }}&sort=job_amount&dir={{ amt_dir }}"
               class="tos-sort-btn {% if sort == 'job_amount' %}active{% endif %}">
                Job Amount <i class="bi {% if sort == 'job_amount' and dir == 'asc' %}bi-sort-up{% else %}bi-sort-down{% endif %} sort-icon"></i>
            </a>
            {% set st_dir = 'desc' if sort == 'status' and dir == 'asc' else 'asc' %}
            <a href="{{ _base }}&sort=status&dir={{ st_dir }}"
               class="tos-sort-btn {% if sort == 'status' %}active{% endif %}">
                Status <i class="bi {% if sort == 'status' and dir == 'desc' %}bi-sort-alpha-up{% else %}bi-sort-alpha-down{% endif %} sort-icon"></i>
            </a>
        </div>
    </div>

    <!-- Commissions Table -->
    <div class="tos-card">
        {% if entries %}
        <div class="table-responsive">
            <table class="tos-table">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Job Name</th>
                        <th>Last Contacted</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th style="text-align:right;">Job Amount</th>
                        <th style="text-align:right;">Commission (1%)</th>
                        <th>Notes</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    <tr class="entry-row" style="cursor:pointer;"
                        data-id="{{ entry.id }}"
                        data-month="{{ entry.month }}"
                        data-account="{{ entry.account_name }}"
                        data-job-name="{{ entry.job_name }}"
                        data-job-number="{{ entry.job_number or '' }}"
                        data-contact="{{ entry.contact or '' }}"
                        data-job-status="{{ entry.job_status }}"
                        data-job-amount="{{ entry.job_amount if entry.job_amount is not none else '' }}"
                        data-commission="{{ entry.commission_amount if entry.commission_amount is not none else '' }}"
                        data-notes="{{ entry.notes or '' }}">
                        <td><span class="tos-entity-name">{{ entry.account_name }}</span></td>
                        <td>{{ entry.job_name }}</td>
                        <td class="tos-entity-sub">
                            {% set lc = account_last_contacted.get(entry.account_name) %}
                            {{ lc.strftime('%m/%d/%Y') if lc else '—' }}
                        </td>
                        <td class="tos-entity-sub">{{ entry.contact or '—' }}</td>
                        <td style="position:relative;">
                            <span class="job-status-badge" data-entry-id="{{ entry.id }}" data-status="{{ entry.job_status }}">{{ entry.job_status }}</span>
                        </td>
                        <td style="text-align:right;">
                            {% if entry.job_amount is not none %}<span class="currency">{{ entry.job_amount }}</span>{% else %}—{% endif %}
                        </td>
                        <td style="text-align:right;">
                            {% if entry.commission_amount is not none %}<span class="currency">{{ entry.commission_amount }}</span>{% else %}—{% endif %}
                        </td>
                        <td class="tos-entity-sub" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="{{ entry.notes or '' }}">
                            {{ entry.notes or '—' }}
                        </td>
                        <td class="text-end" style="white-space:nowrap;">
                            <button type="button" class="tos-btn tos-btn-secondary edit-btn" title="Edit"
                                data-id="{{ entry.id }}"
                                data-month="{{ entry.month }}"
                                data-account="{{ entry.account_name }}"
                                data-job-name="{{ entry.job_name }}"
                                data-job-number="{{ entry.job_number or '' }}"
                                data-contact="{{ entry.contact or '' }}"
                                data-job-status="{{ entry.job_status }}"
                                data-job-amount="{{ entry.job_amount if entry.job_amount is not none else '' }}"
                                data-commission="{{ entry.commission_amount if entry.commission_amount is not none else '' }}"
                                data-notes="{{ entry.notes or '' }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form action="/commissions/{{ entry.id }}/delete" method="post" style="display:inline;" onsubmit="return confirm('Delete this entry?')">
                                <button type="submit" class="tos-btn tos-btn-secondary" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="tos-empty-state">
            <i class="bi bi-cash-coin"></i>
            <p>No commission entries for this month</p>
            <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#commissionModal" onclick="openAddModal()">
                <i class="bi bi-plus-lg"></i> Add Entry
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Commission Modal -->
<div class="modal fade" id="commissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="commissionForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="commissionModalTitle">Add Commission Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Month <span style="color:#dc2626;">*</span></label>
                            <input type="month" class="form-control form-control-sm" name="month" id="entryMonth" value="{{ selected_month }}" required>
                        </div>
                        <!-- Account: searchable dropdown with fallback free-text -->
                        <div class="col-12">
                            <label class="form-label">Account Name <span style="color:#dc2626;">*</span></label>
                            <div class="search-wrap">
                                <input type="text" class="form-control form-control-sm" id="accountSearchInput" placeholder="Search accounts..." autocomplete="off" required>
                                <input type="hidden" name="account_name" id="hiddenAccountName">
                                <div class="search-results" id="accountResults"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Job Name <span style="color:#dc2626;">*</span></label>
                            <input type="text" class="form-control form-control-sm" name="job_name" id="entryJobName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Job Number</label>
                            <input type="text" class="form-control form-control-sm" name="job_number" id="entryJobNumber">
                        </div>
                        <!-- Contact: disabled until account selected, filtered by account -->
                        <div class="col-md-6">
                            <label class="form-label">Contact</label>
                            <select class="form-select form-select-sm" id="contactSelect" disabled>
                                <option value="">Select account first</option>
                            </select>
                            <input type="text" class="form-control form-control-sm mt-1" id="contactManual" placeholder="Or type manually..." style="display:none;">
                            <!-- The actual submitted value -->
                            <input type="hidden" name="contact" id="hiddenContact" value="">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Job Amount</label>
                            <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="job_amount" id="entryJobAmount">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Commission (1%)</label>
                            <input type="text" class="form-control form-control-sm" id="commissionDisplay" readonly tabindex="-1" style="background:var(--bg-elevated); cursor:default;">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control form-control-sm" name="notes" id="entryNotes" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Job Status</label>
                            <select class="form-select form-select-sm" name="job_status" id="entryJobStatus">
                                {% for s in job_statuses %}
                                <option value="{{ s }}">{{ s }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="tos-btn tos-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="tos-btn tos-btn-primary" id="commissionSubmitBtn">Add Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Commission Modal (read-only) -->
<div class="modal fade" id="viewCommissionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalTitle">Commission Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Account</label>
                        <div class="fw-semibold" id="viewAccount"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Month</label>
                        <div class="fw-semibold" id="viewMonth"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Job Name</label>
                        <div class="fw-semibold" id="viewJobName"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Job Number</label>
                        <div id="viewJobNumber"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Contact</label>
                        <div id="viewContact"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small mb-0">Status</label>
                        <div id="viewJobStatus"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small mb-0">Job Amount</label>
                        <div id="viewJobAmount"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small mb-0">Commission (1%)</label>
                        <div id="viewCommission"></div>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-muted small mb-0">Notes</label>
                        <div id="viewNotes" style="white-space:pre-wrap;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="tos-btn tos-btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    /* ---- server data ---- */
    var accountList = [
        {% for acct in accounts %}
        {id: {{ acct.id }}, name: {{ acct.name | tojson }}}{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    var accountNameToId = {};
    accountList.forEach(function(a) { accountNameToId[a.name] = a.id; });

    /* ---- DOM refs ---- */
    var searchInput    = document.getElementById('accountSearchInput');
    var hiddenAcctName = document.getElementById('hiddenAccountName');
    var resultsDiv     = document.getElementById('accountResults');
    var contactSelect  = document.getElementById('contactSelect');
    var contactManual  = document.getElementById('contactManual');
    var hiddenContact  = document.getElementById('hiddenContact');
    var jobAmountInput = document.getElementById('entryJobAmount');
    var commDisplay    = document.getElementById('commissionDisplay');

    var selectedAccountId = null;

    /* ==== Account search ==== */
    searchInput.addEventListener('input', function() {
        var term = this.value.toLowerCase().trim();
        hiddenAcctName.value = this.value.trim();
        selectedAccountId = null;
        resetContacts();
        resultsDiv.innerHTML = '';

        if (!term) { resultsDiv.classList.remove('show'); return; }

        var matches = accountList.filter(function(a) {
            return a.name.toLowerCase().indexOf(term) !== -1;
        });
        if (!matches.length) { resultsDiv.classList.remove('show'); return; }

        matches.forEach(function(m) {
            var div = document.createElement('div');
            div.className = 'sr-item';
            div.textContent = m.name;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                pickAccount(m.id, m.name);
            });
            resultsDiv.appendChild(div);
        });
        resultsDiv.classList.add('show');
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-wrap')) resultsDiv.classList.remove('show');
    });

    function pickAccount(id, name) {
        searchInput.value = name;
        hiddenAcctName.value = name;
        selectedAccountId = id;
        resultsDiv.classList.remove('show');
        loadContacts(id);
    }

    /* ==== Contacts ==== */
    function resetContacts() {
        contactSelect.innerHTML = '<option value="">Select account first</option>';
        contactSelect.disabled = true;
        contactManual.style.display = 'none';
        contactManual.value = '';
        hiddenContact.value = '';
    }

    function loadContacts(accountId, preselect) {
        fetch('/commissions/api/contacts/' + accountId, { headers: {'Accept':'application/json'} })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            contactSelect.innerHTML = '<option value="">— None —</option>';
            data.forEach(function(c) {
                var opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = c.name;
                contactSelect.appendChild(opt);
            });
            var manOpt = document.createElement('option');
            manOpt.value = '__manual__';
            manOpt.textContent = '— Type manually —';
            contactSelect.appendChild(manOpt);
            contactSelect.disabled = false;

            if (preselect) {
                var found = data.some(function(c) { return c.name === preselect; });
                if (found) {
                    contactSelect.value = preselect;
                    hiddenContact.value = preselect;
                } else {
                    contactSelect.value = '__manual__';
                    contactManual.style.display = '';
                    contactManual.value = preselect;
                    hiddenContact.value = preselect;
                }
            }
        });
    }

    contactSelect.addEventListener('change', function() {
        if (this.value === '__manual__') {
            contactManual.style.display = '';
            contactManual.focus();
            hiddenContact.value = contactManual.value;
        } else {
            contactManual.style.display = 'none';
            contactManual.value = '';
            hiddenContact.value = this.value;
        }
    });

    contactManual.addEventListener('input', function() {
        hiddenContact.value = this.value;
    });

    /* ==== Commission auto-calc ==== */
    function updateCommission() {
        var val = parseFloat(jobAmountInput.value);
        if (isNaN(val) || val <= 0) {
            commDisplay.value = '';
        } else {
            commDisplay.value = '$' + (val * 0.01).toFixed(2);
        }
    }
    jobAmountInput.addEventListener('input', updateCommission);

    /* ==== Open Add modal ==== */
    window.openAddModal = function() {
        document.getElementById('commissionForm').action = '/commissions/add';
        document.getElementById('commissionModalTitle').textContent = 'Add Commission Entry';
        document.getElementById('commissionSubmitBtn').textContent = 'Add Entry';
        document.getElementById('entryMonth').value = '{{ selected_month }}';
        searchInput.value = '';
        hiddenAcctName.value = '';
        selectedAccountId = null;
        document.getElementById('entryJobName').value = '';
        document.getElementById('entryJobNumber').value = '';
        resetContacts();
        jobAmountInput.value = '';
        commDisplay.value = '';
        document.getElementById('entryNotes').value = '';
        document.getElementById('entryJobStatus').value = 'Pending';
    };

    /* ==== Row click to view (read-only) ==== */
    document.querySelectorAll('.entry-row').forEach(function(row) {
        row.addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('form') || e.target.closest('.job-status-badge') || e.target.closest('.status-picker')) return;

            var d = this.dataset;
            document.getElementById('viewAccount').textContent = d.account || '—';
            document.getElementById('viewMonth').textContent = d.month || '—';
            document.getElementById('viewJobName').textContent = d.jobName || '—';
            document.getElementById('viewJobNumber').textContent = d.jobNumber || '—';
            document.getElementById('viewContact').textContent = d.contact || '—';
            document.getElementById('viewJobStatus').textContent = d.jobStatus || 'Pending';
            document.getElementById('viewJobAmount').textContent = d.jobAmount ? ('$' + parseFloat(d.jobAmount).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})) : '—';
            document.getElementById('viewCommission').textContent = d.commission ? ('$' + parseFloat(d.commission).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})) : '—';
            document.getElementById('viewNotes').textContent = d.notes || '—';

            var modal = new bootstrap.Modal(document.getElementById('viewCommissionModal'));
            modal.show();
        });
    });

    /* ==== Edit buttons ==== */
    document.querySelectorAll('.edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var d = this.dataset;
            document.getElementById('commissionForm').action = '/commissions/' + d.id + '/edit';
            document.getElementById('commissionModalTitle').textContent = 'Edit Commission Entry';
            document.getElementById('commissionSubmitBtn').textContent = 'Save Changes';
            document.getElementById('entryMonth').value = d.month;
            searchInput.value = d.account;
            hiddenAcctName.value = d.account;
            document.getElementById('entryJobName').value = d.jobName;
            document.getElementById('entryJobNumber').value = d.jobNumber;
            jobAmountInput.value = d.jobAmount;
            commDisplay.value = d.commission ? ('$' + parseFloat(d.commission).toFixed(2)) : '';
            document.getElementById('entryNotes').value = d.notes;
            document.getElementById('entryJobStatus').value = d.jobStatus || 'Pending';

            var acctId = accountNameToId[d.account];
            if (acctId) {
                selectedAccountId = acctId;
                loadContacts(acctId, d.contact);
            } else {
                resetContacts();
                if (d.contact) {
                    contactManual.style.display = '';
                    contactManual.value = d.contact;
                    hiddenContact.value = d.contact;
                }
            }

            var modal = new bootstrap.Modal(document.getElementById('commissionModal'));
            modal.show();
        });
    });

    /* ==== Reset on close ==== */
    document.getElementById('commissionModal').addEventListener('hidden.bs.modal', function() {
        openAddModal();
    });

    /* ==== Inline status picker ==== */
    var JOB_STATUSES = {{ job_statuses | tojson }};
    var activePicker = null;

    function closePicker() {
        if (activePicker) { activePicker.remove(); activePicker = null; }
    }

    document.querySelectorAll('.job-status-badge').forEach(function(badge) {
        badge.addEventListener('click', function(e) {
            e.stopPropagation();
            closePicker();

            var entryId = this.dataset.entryId;
            var current = this.dataset.status;
            var badgeEl = this;
            var td = this.parentElement;

            var rect = badgeEl.getBoundingClientRect();
            var picker = document.createElement('div');
            picker.className = 'status-picker show';
            picker.style.top = rect.bottom + 4 + 'px';
            picker.style.left = rect.left + 'px';
            JOB_STATUSES.forEach(function(s) {
                var item = document.createElement('div');
                item.className = 'status-picker-item';
                item.textContent = s;
                if (s === current) item.style.fontWeight = '600';
                item.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    closePicker();
                    if (s === current) return;

                    fetch('/commissions/' + entryId + '/status', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({job_status: s})
                    })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (!data.ok) return;
                        badgeEl.textContent = data.job_status;
                        badgeEl.dataset.status = data.job_status;
                        // Update the row data attribute too
                        var row = badgeEl.closest('tr');
                        if (row) row.dataset.jobStatus = data.job_status;
                        // Update the edit button data attribute
                        var editBtn = row && row.querySelector('.edit-btn');
                        if (editBtn) editBtn.dataset.jobStatus = data.job_status;
                        // Update the total displays
                        var wonEl = document.querySelector('.commission-total-won');
                        if (wonEl) {
                            wonEl.textContent = 'Total (Won): $' + data.total_commission.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
                        }
                        var pendingEl = document.querySelector('.commission-total-pending');
                        if (pendingEl) {
                            pendingEl.textContent = 'Total (Pending): $' + data.pending_commission.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
                        }
                    });
                });
                picker.appendChild(item);
            });
            document.body.appendChild(picker);
            activePicker = picker;
        });
    });

    document.addEventListener('click', function() { closePicker(); });

    /* ==== Search ==== */
    var commSearchInput = document.getElementById('commissionSearch');
    if (commSearchInput) {
        var searchTimer = null;
        function doSearch() {
            var term = commSearchInput.value.trim();
            var url = '/commissions?month={{ selected_month }}';
            if (term) url += '&search=' + encodeURIComponent(term);
            {% if sort %} url += '&sort={{ sort }}'; {% endif %}
            {% if dir %} url += '&dir={{ dir }}'; {% endif %}
            window.location.href = url;
        }
        commSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
        });
        commSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(doSearch, 500);
        });
    }
})();
</script>
{% endblock %}
