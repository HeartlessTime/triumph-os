{% extends "base.html" %}

{% set return_to = request.query_params.get('from') %}
{% set from_account_id = request.query_params.get('from_account') %}

{% block title %}{{ contact.full_name }} - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="tos-page-header">
        <!-- Back link: context-aware for account-centric navigation -->
        {% if from_account_id and contact.account and contact.account.id|string == from_account_id %}
        <div class="mb-2">
            <a href="/accounts/{{ from_account_id }}"
               class="tos-btn tos-btn-secondary"
               data-restore-account-scroll="{{ from_account_id }}">
                <i class="bi bi-arrow-left me-1"></i> Back to Account: {{ contact.account.name }}
            </a>
        </div>
        {% elif return_to %}
        <div class="mb-2">
            <a href="{{ return_to }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
        </div>
        {% endif %}

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                {% if from_account_id and contact.account and contact.account.id|string == from_account_id %}
                <li class="breadcrumb-item"><a href="/accounts">Accounts</a></li>
                <li class="breadcrumb-item"><a href="/accounts/{{ from_account_id }}">{{ contact.account.name }}</a></li>
                <li class="breadcrumb-item active">{{ contact.full_name }}</li>
                {% else %}
                <li class="breadcrumb-item"><a href="/contacts">Contacts</a></li>
                <li class="breadcrumb-item active">{{ contact.full_name }}</li>
                {% endif %}
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>{{ contact.full_name }}</h1>
                <a href="/accounts/{{ contact.account.id }}" class="tos-row-link tos-entity-sub">
                    <i class="bi bi-building me-1"></i>{{ contact.account.name }}
                </a>
            </div>
            <div class="d-flex gap-2">
                <a href="/contacts/{{ contact.id }}/edit" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logContactModal">
                    <i class="bi bi-telephone me-1"></i> Log Contact
                </button>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logMeetingModal">
                    <i class="bi bi-calendar-event me-1"></i> Log Meeting
                </button>
                <form method="post" action="/contacts/{{ contact.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this contact? This cannot be undone.');">
                    <button type="submit" class="tos-btn" style="background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <!-- Follow-up Status Card -->
            <div class="tos-card mb-3">
                <div class="tos-section-header">Follow-up Status</div>
                <div class="p-3">
                    <div class="tos-quick-stats">
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Last Contacted</div>
                            <div style="font-size: 0.9rem;">{{ contact.last_contacted.strftime('%b %d, %Y') if contact.last_contacted else '—' }}</div>
                        </div>
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Next Follow-up</div>
                            {% if contact.next_followup %}
                            <span class="{% if contact.next_followup < today %}tos-badge-overdue{% elif contact.next_followup == today %}tos-badge-today{% endif %}" style="font-size: 0.9rem;">
                                {{ contact.next_followup.strftime('%b %d, %Y') }}
                            </span>
                            {% else %}
                            <span class="tos-entity-sub">—</span>
                            {% endif %}
                        </div>
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Response</div>
                            <form method="post" action="/contacts/{{ contact.id }}/toggle-has-responded?from=/contacts/{{ contact.id }}" class="d-inline">
                                {% if contact.has_responded %}
                                <button type="submit" style="background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; border-radius: 4px; padding: 0.15rem 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                    <i class="bi bi-check-circle-fill me-1"></i>Responded
                                </button>
                                {% else %}
                                <button type="submit" style="background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; border-radius: 4px; padding: 0.15rem 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                    <i class="bi bi-x-circle me-1"></i>No Response
                                </button>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="tos-card">
                <div class="tos-section-header">Contact Information</div>
                <div class="p-3" style="font-size: 0.85rem;">
                    <div class="row g-2">
                        <div class="col-12">
                            <div class="tos-entity-sub">Title</div>
                            <div>{{ contact.title or '—' }}</div>
                        </div>
                        <div class="col-12 mt-2">
                            <div class="tos-entity-sub">Email</div>
                            {% if contact.email %}
                            <a href="mailto:{{ contact.email }}" class="tos-row-link">{{ contact.email }}</a>
                            {% else %}
                            <span class="tos-entity-sub">—</span>
                            {% endif %}
                        </div>
                        <div class="col-6 mt-2">
                            <div class="tos-entity-sub">Office Phone</div>
                            {% if contact.phone %}
                            <a href="tel:{{ contact.phone }}" class="tos-row-link">{{ contact.phone }}</a>
                            {% else %}
                            <span class="tos-entity-sub">—</span>
                            {% endif %}
                        </div>
                        <div class="col-6 mt-2">
                            <div class="tos-entity-sub">Mobile</div>
                            {% if contact.mobile %}
                            <a href="tel:{{ contact.mobile }}" class="tos-row-link">{{ contact.mobile }}</a>
                            {% else %}
                            <span class="tos-entity-sub">—</span>
                            {% endif %}
                        </div>
                        <div class="col-12 mt-2">
                            <div class="tos-entity-sub">Notes</div>
                            <div>{{ contact.notes or '—' }}</div>
                        </div>
                    </div>

                    {% if contact.is_primary %}
                    <div class="mt-3">
                        <span class="tos-badge-pending">Primary Contact</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Contact Modal -->
<!-- For non-meeting interactions: calls, emails, other -->
<!-- Use "Log Meeting" for meeting-related activities -->
<div class="modal fade" id="logContactModal" tabindex="-1" aria-labelledby="logContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/contacts/{{ contact.id }}/log-contact{% if return_to %}?from={{ return_to }}{% endif %}">
                <div class="modal-header">
                    <h5 class="modal-title" id="logContactModalLabel">
                        <i class="bi bi-telephone me-2"></i>Log Contact with {{ contact.full_name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="activity_type" class="form-label">Activity Type</label>
                        <select class="form-select" id="activity_type" name="activity_type">
                            <option value="call" selected>Phone Call</option>
                            <option value="email">Email</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Follow-up In</label>
                        <div class="d-flex gap-2 flex-wrap mb-2" id="followupPresets">
                            <button type="button" class="btn btn-outline-secondary followup-preset" data-days="3">3 days</button>
                            <button type="button" class="btn btn-outline-secondary followup-preset" data-days="7">7 days</button>
                            <button type="button" class="btn btn-outline-primary followup-preset active" data-days="30">30 days</button>
                            <button type="button" class="btn btn-outline-secondary followup-preset" data-days="60">60 days</button>
                        </div>
                        <input type="date" class="form-control" name="next_followup" id="next_followup_input" style="max-width: 200px;">
                        <div class="form-text" id="followupDatePreview"></div>
                    </div>
                    <div class="mb-3">
                        <label for="contact_notes" class="form-label">Notes <span class="text-muted">(optional)</span></label>
                        <textarea class="form-control" id="contact_notes" name="notes" rows="3"
                            placeholder="Add notes about this contact..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Log Contact
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Log Meeting Modal -->
<!-- Two options:
     - "Meeting Requested": Meeting discussed but not yet scheduled (2 business day follow-up)
     - "Meeting": Meeting that already happened (standard 30-day follow-up)
     Note: Outlook is the source of truth for scheduled meetings. This app only tracks reminders. -->
<div class="modal fade" id="logMeetingModal" tabindex="-1" aria-labelledby="logMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/contacts/{{ contact.id }}/log-contact{% if return_to %}?from={{ return_to }}{% endif %}" id="logMeetingForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="logMeetingModalLabel">
                        <i class="bi bi-calendar-event me-2"></i>Log Meeting with {{ contact.full_name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="meeting_type" class="form-label">Meeting Status</label>
                        <select class="form-select" id="meeting_type" name="activity_type">
                            <option value="meeting_requested">Meeting Requested (not yet scheduled)</option>
                            <option value="meeting">Meeting Occurred</option>
                        </select>
                        <div class="form-text" id="meetingTypeHelp">
                            <span id="meetingRequestedInfo">
                                <i class="bi bi-info-circle me-1"></i>
                                Creates a 2 business day follow-up to check if meeting was scheduled.
                            </span>
                            <span id="meetingOccurredInfo" style="display: none;">
                                <i class="bi bi-info-circle me-1"></i>
                                Logs that a meeting happened. Standard 30-day follow-up.
                            </span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="meeting_notes" class="form-label">Notes <span class="text-muted">(optional)</span></label>
                        <textarea class="form-control" id="meeting_notes" name="notes" rows="3"
                            placeholder="Meeting notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>Log Meeting
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-open modal if URL hash matches a modal ID
(function() {
    const hash = window.location.hash;
    if (hash === '#logContactModal' || hash === '#logMeetingModal') {
        const modalEl = document.querySelector(hash);
        if (modalEl && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            // Clear hash after opening so refresh doesn't re-trigger
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
    }
})();

// Toggle help text for meeting type selection
document.getElementById('meeting_type').addEventListener('change', function() {
    document.getElementById('meetingRequestedInfo').style.display = this.value === 'meeting_requested' ? 'inline' : 'none';
    document.getElementById('meetingOccurredInfo').style.display = this.value === 'meeting' ? 'inline' : 'none';
});

// Follow-up preset buttons and date picker
(function() {
    const presets = document.querySelectorAll('.followup-preset');
    const dateInput = document.getElementById('next_followup_input');
    const preview = document.getElementById('followupDatePreview');

    // Calculate follow-up date, skipping weekends
    function calculateFollowupDate(days) {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return normalizeToBusinessDay(d);
    }

    // Skip weekends: Saturday -> Monday, Sunday -> Monday
    function normalizeToBusinessDay(d) {
        const dayOfWeek = d.getDay();
        if (dayOfWeek === 6) d.setDate(d.getDate() + 2); // Saturday -> Monday
        if (dayOfWeek === 0) d.setDate(d.getDate() + 1); // Sunday -> Monday
        return d;
    }

    // Format date as YYYY-MM-DD for form/input
    function formatDateISO(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Format date for display (e.g., "Mon, Jan 27")
    function formatDateDisplay(d) {
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // Update preview text from current date input value
    function updatePreview() {
        if (dateInput.value) {
            const d = new Date(dateInput.value + 'T12:00:00'); // Noon to avoid timezone issues
            preview.textContent = 'Follow-up: ' + formatDateDisplay(d);
        } else {
            preview.textContent = '';
        }
    }

    // Clear all preset active states
    function clearPresetSelection() {
        presets.forEach(function(p) {
            p.classList.remove('active', 'btn-outline-primary');
            p.classList.add('btn-outline-secondary');
        });
    }

    // Set follow-up date from preset button
    function setFollowupFromPreset(days, btn) {
        const followupDate = calculateFollowupDate(days);
        dateInput.value = formatDateISO(followupDate);
        updatePreview();

        // Update active state
        clearPresetSelection();
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('active', 'btn-outline-primary');
    }

    // Handle manual date input change
    dateInput.addEventListener('change', function() {
        if (this.value) {
            // Normalize to business day if weekend selected
            const selected = new Date(this.value + 'T12:00:00');
            const normalized = normalizeToBusinessDay(new Date(selected));
            const normalizedISO = formatDateISO(normalized);

            if (this.value !== normalizedISO) {
                // Date was moved to avoid weekend
                this.value = normalizedISO;
                preview.textContent = 'Follow-up: ' + formatDateDisplay(normalized) + ' (moved from weekend)';
            } else {
                updatePreview();
            }
        }
        // Clear preset selection when manually editing
        clearPresetSelection();
    });

    // Initialize with 30-day default
    const defaultBtn = document.querySelector('.followup-preset[data-days="30"]');
    if (defaultBtn) {
        setFollowupFromPreset(30, defaultBtn);
    }

    // Handle preset clicks
    presets.forEach(function(btn) {
        btn.addEventListener('click', function() {
            const days = parseInt(this.dataset.days, 10);
            setFollowupFromPreset(days, this);
        });
    });

    // Reset to default when modal opens
    const modal = document.getElementById('logContactModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', function() {
            if (defaultBtn) setFollowupFromPreset(30, defaultBtn);
        });
    }
})();
</script>
{% endblock %}
