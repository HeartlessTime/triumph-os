{% extends "base.html" %}

{% block title %}{{ account.name }} - Triumph OS{% endblock %}

{% block content %}
{% set from_list = request.query_params.get('from') %}
<div class="content-area">
    <div class="tos-page-header">
        <div class="mb-2">
            {% if from_list and from_list.startswith('/accounts') %}
            <a href="{{ from_list }}" class="tos-btn tos-btn-secondary" data-restore-accounts-list>
                <i class="bi bi-arrow-left me-1"></i> Back to Accounts
            </a>
            {% elif return_to %}
            <a href="{{ return_to }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
            {% else %}
            <a href="/accounts" class="tos-btn tos-btn-secondary" data-restore-accounts-list>
                <i class="bi bi-arrow-left me-1"></i> Back to Accounts
            </a>
            {% endif %}
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/accounts">Accounts</a></li>
                <li class="breadcrumb-item active">{{ account.name }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">
                    {{ account.name }}
                    {% if account.is_hot %}
                    <i class="bi bi-fire ms-2" style="color: #dc2626; font-size: 0.7em;" title="Hot Account"></i>
                    {% endif %}
                    {% if account.awaiting_response %}
                    <i class="bi bi-hourglass-split ms-2" style="color: #92400e; font-size: 0.7em;" title="Awaiting Response"></i>
                    {% endif %}
                </h1>
                <span class="tos-entity-sub">{{ account.account_type_display }}</span>
            </div>
            <div class="d-flex gap-2">
                <a href="/accounts/{{ account.id }}/edit" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logMeetingModal">
                    <i class="bi bi-calendar-check me-1"></i> Meeting
                </button>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logSiteVisitModal">
                    <i class="bi bi-geo-alt me-1"></i> Site Visit
                </button>
                <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> New Opportunity
                </a>
                <form method="post" action="/accounts/{{ account.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this account and all its contacts? This cannot be undone.');">
                    <button type="submit" class="tos-btn tos-btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>

        <!-- Account Status Toggles -->
        <div class="mt-3 d-flex gap-2">
            <form method="post" action="/accounts/{{ account.id }}/toggle-hot?from=/accounts/{{ account.id }}" class="d-inline">
                {% if account.is_hot %}
                <button type="submit" class="tos-btn tos-btn-danger">
                    <i class="bi bi-fire me-1"></i> Hot
                </button>
                {% else %}
                <button type="submit" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-fire me-1"></i> Mark Hot
                </button>
                {% endif %}
            </form>
            <form method="post" action="/accounts/{{ account.id }}/toggle-awaiting-response?from=/accounts/{{ account.id }}" class="d-inline">
                {% if account.awaiting_response %}
                <button type="submit" class="tos-btn tos-btn-warning">
                    <i class="bi bi-hourglass-split me-1"></i> Awaiting Response
                </button>
                {% else %}
                <button type="submit" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-hourglass me-1"></i> Mark Awaiting Response
                </button>
                {% endif %}
            </form>
        </div>
    </div>

    <div class="row g-3">
        <!-- Account Details -->
        <div class="col-lg-4">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-building me-1"></i>Account Details
                </div>
                <div class="p-3">
                    <dl class="mb-0" style="font-size: 0.85rem;">
                        {% if account.industry %}
                        <dt class="tos-entity-sub">Industry</dt>
                        <dd class="mb-2">{{ account.industry }}</dd>
                        {% endif %}

                        {% if account.phone %}
                        <dt class="tos-entity-sub">Phone</dt>
                        <dd class="mb-2"><a href="tel:{{ account.phone }}" class="tos-row-link">{{ account.phone }}</a></dd>
                        {% endif %}

                        {% if account.website %}
                        <dt class="tos-entity-sub">Website</dt>
                        <dd class="mb-2"><a href="{{ account.website }}" target="_blank" class="tos-row-link">{{ account.website }}</a></dd>
                        {% endif %}

                        {% if account.full_address %}
                        <dt class="tos-entity-sub">Address</dt>
                        <dd class="mb-2" style="white-space: pre-line;">{{ account.full_address }}</dd>
                        {% endif %}

                        {% if account.notes %}
                        <dt class="tos-entity-sub">Notes</dt>
                        <dd class="mb-0">{{ account.notes }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Pipeline Stats -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-graph-up me-1"></i>Pipeline
                </div>
                <div class="p-3">
                    <div class="tos-quick-stats">
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Open Opportunities</div>
                            <div style="font-size: 1.25rem; font-weight: 600;">{{ account.open_opportunities_count }}</div>
                        </div>
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Pipeline Value</div>
                            <div class="currency" style="font-size: 1.25rem; font-weight: 600;">{{ account.total_pipeline_value }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Next Action -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-lightning me-1"></i>Next Action
                </div>
                <div class="p-3">
                    <form id="nextActionForm" data-auto-save="/accounts/{{ account.id }}/auto-save">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" name="next_action"
                                value="{{ account.next_action or '' }}" placeholder="What's the next step?">
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label class="form-label mb-0 small text-muted">Due:</label>
                            <input type="date" class="form-control form-control-sm" name="next_action_due_date"
                                value="{{ account.next_action_due_date.strftime('%Y-%m-%d') if account.next_action_due_date else '' }}"
                                style="max-width: 160px;
                                {% if account.days_until_next_action is not none %}
                                    {% if account.days_until_next_action < 0 %}color: #dc2626; font-weight: 600;
                                    {% elif account.days_until_next_action <= 2 %}color: #d97706; font-weight: 600;
                                    {% else %}color: #059669;
                                    {% endif %}
                                {% endif %}">
                            {% if account.days_until_next_action is not none %}
                            <span class="small {% if account.days_until_next_action < 0 %}text-danger fw-bold{% elif account.days_until_next_action <= 2 %}text-warning{% else %}text-success{% endif %}">
                                {% if account.days_until_next_action < 0 %}{{ account.days_until_next_action|abs }}d overdue
                                {% elif account.days_until_next_action == 0 %}Due today
                                {% else %}In {{ account.days_until_next_action }}d
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </form>
                    <span class="text-muted small d-block mt-1"><i class="bi bi-cloud-check me-1"></i>Auto-saves</span>
                </div>
            </div>

            <!-- Meetings with this Account -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-calendar-check me-1"></i>Meetings
                </div>
                {% if account_meetings %}
                <div class="table-responsive">
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Attendees</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meeting in account_meetings[:7] %}
                            <tr data-href="/activities/{{ meeting.id }}?from=/accounts/{{ account.id }}">
                                <td>
                                    <a href="/activities/{{ meeting.id }}?from=/accounts/{{ account.id }}" class="tos-row-link tos-entity-name">{{ meeting.attendees_display or meeting.subject }}</a>
                                </td>
                                <td class="tos-entity-sub">{{ meeting.activity_date.strftime('%b %d, %Y') }}</td>
                                <td class="text-end">
                                    <a href="/activities/{{ meeting.id }}/edit?from=/accounts/{{ account.id }}" class="tos-btn tos-btn-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if account_meetings|length > 7 %}
                <div class="p-2 text-center">
                    <span class="tos-entity-sub">Showing 7 of {{ account_meetings|length }} meetings</span>
                </div>
                {% endif %}
                {% else %}
                <div class="tos-empty-state">
                    <i class="bi bi-calendar"></i>
                    <p>No meetings logged yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contacts -->
        <div class="col-lg-8">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-people me-1"></i>Contacts
                    <a href="/contacts/new?account_id={{ account.id }}" class="tos-btn tos-btn-secondary ms-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        <i class="bi bi-plus-lg me-1"></i> Add
                    </a>
                </div>
                {% if sorted_contacts %}
                <div class="table-responsive">
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Title</th>
                                <th>Last Contacted</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in sorted_contacts %}
                            <tr>
                                <td>
                                    <a href="/contacts/{{ contact.id }}?from_account={{ account.id }}"
                                       class="tos-row-link tos-entity-name"
                                       data-save-account-scroll>
                                        {{ contact.full_name }}
                                    </a>
                                    {% if contact.is_primary %}
                                    <span class="tos-badge-pending ms-1">Primary</span>
                                    {% endif %}
                                    {% if contact.has_responded %}
                                    <i class="bi bi-check-circle-fill ms-1" style="color: #059669;" title="Has Responded"></i>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ contact.title or '—' }}</td>
                                <td class="tos-entity-sub">{{ contact.last_contacted.strftime('%b %d, %Y') if contact.last_contacted else '—' }}</td>
                                <td>
                                    {% if contact.email %}
                                    <a href="mailto:{{ contact.email }}" class="tos-row-link">{{ contact.email }}</a>
                                    {% else %}<span class="tos-entity-sub">—</span>{% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ contact.best_phone or '—' }}</td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <button type="button" class="tos-btn tos-btn-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#logContactModal"
                                        data-contact-id="{{ contact.id }}"
                                        data-contact-name="{{ contact.full_name }}"
                                        title="Log Contact">
                                        <i class="bi bi-telephone"></i>
                                    </button>
                                    <a href="/contacts/{{ contact.id }}/edit?from=/accounts/{{ account.id }}" class="tos-btn tos-btn-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="tos-empty-state">
                    <i class="bi bi-person-plus"></i>
                    <p>No contacts yet</p>
                    <a href="/contacts/new?account_id={{ account.id }}" class="tos-btn tos-btn-primary">Add First Contact</a>
                </div>
                {% endif %}
            </div>

            <!-- Opportunities -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-bullseye me-1"></i>Opportunities
                    <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-secondary ms-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        <i class="bi bi-plus-lg me-1"></i> Add
                    </a>
                </div>
                {% if account.opportunities %}
                <div class="table-responsive">
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Opportunity</th>
                                <th>Stage</th>
                                <th>Value</th>
                                <th>Bid Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for opp in account.opportunities %}
                            <tr>
                                <td>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-row-link tos-entity-name">
                                        {{ opp.name }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-stage badge-{{ opp.stage|lower|replace(' ', '-') }}">
                                        {{ opp.stage }}
                                    </span>
                                </td>
                                <td class="currency">{{ opp.value or 0 }}</td>
                                <td class="tos-entity-sub">{{ opp.bid_date.strftime('%b %d, %Y') if opp.bid_date else '—' }}</td>
                                <td class="text-end">
                                    <a href="/opportunities/{{ opp.id }}" class="tos-btn tos-btn-secondary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="tos-empty-state">
                    <i class="bi bi-bullseye"></i>
                    <p>No opportunities yet</p>
                    <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-primary">Create First Opportunity</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Log Contact Modal -->
<div class="modal fade" id="logContactModal" tabindex="-1" aria-labelledby="logContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="logContactForm" method="post" action="">
                <div class="modal-header">
                    <h5 class="modal-title" id="logContactModalLabel">
                        <i class="bi bi-telephone me-2"></i>Log Contact
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="activity_type" class="form-label">Activity Type</label>
                        <select class="form-select" id="activity_type" name="activity_type">
                            <option value="call">Phone Call</option>
                            <option value="email" selected>Email</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Follow-up In</label>
                        <div class="d-flex gap-2 flex-wrap mb-2" id="followupPresets">
                            <button type="button" class="tos-btn tos-btn-secondary followup-preset" data-days="3">3 days</button>
                            <button type="button" class="tos-btn tos-btn-secondary followup-preset" data-days="7">7 days</button>
                            <button type="button" class="tos-btn tos-btn-primary followup-preset active" data-days="30">30 days</button>
                            <button type="button" class="tos-btn tos-btn-secondary followup-preset" data-days="60">60 days</button>
                        </div>
                        <input type="date" class="form-control" name="next_followup" id="next_followup_input" style="max-width: 200px;">
                        <div class="form-text" id="followupDatePreview"></div>
                    </div>
                    <div class="mb-3">
                        <label for="contact_notes" class="form-label">Notes <span class="text-muted">(optional)</span></label>
                        <textarea class="form-control" id="contact_notes" name="notes" rows="3"
                            placeholder="Add notes about this contact..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="tos-btn tos-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="tos-btn tos-btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Log Contact
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Log Meeting Modal -->
<div class="modal fade" id="logMeetingModal" tabindex="-1" aria-labelledby="logMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="meetingForm" action="/activities/log-meeting?from=/accounts/{{ account.id }}">
                <input type="hidden" name="account_id" value="{{ account.id }}">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="logMeetingModalLabel"><i class="bi bi-calendar-check me-2"></i>Log Meeting - {{ account.name }}</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2">
                    <div class="mb-2">
                        <label for="meetingDate" class="form-label small mb-1">Date & Time <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control form-control-sm" id="meetingDate" name="activity_date" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Attendees <span class="text-danger">*</span></label>
                        {% if sorted_contacts %}
                        <div class="d-flex flex-column gap-1" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem;">
                            {% for contact in sorted_contacts %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="contact_ids" value="{{ contact.id }}" id="meetingContact{{ contact.id }}">
                                <label class="form-check-label small" for="meetingContact{{ contact.id }}">
                                    {{ contact.full_name }}{% if contact.title %} <span class="text-muted">({{ contact.title }})</span>{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted small">No contacts on this account.</p>
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <label for="meetingSubject" class="form-label small mb-1">Subject</label>
                        <input type="text" class="form-control form-control-sm" id="meetingSubject" name="subject" placeholder="Meeting subject (optional)">
                    </div>
                    <div class="mb-0">
                        <label for="meetingNotes" class="form-label small mb-1">Notes</label>
                        <textarea class="form-control form-control-sm" id="meetingNotes" name="description" rows="2" placeholder="Meeting notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="tos-btn tos-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="tos-btn tos-btn-primary"><i class="bi bi-calendar-check me-1"></i>Log Meeting</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include "partials/site_visit_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Next Action auto-save
    const nextActionForm = document.getElementById('nextActionForm');
    if (nextActionForm) {
        const endpoint = nextActionForm.dataset.autoSave;
        AutoSave.init(nextActionForm, endpoint);
    }

    // Follow-up preset logic
    const presets = document.querySelectorAll('.followup-preset');
    const dateInput = document.getElementById('next_followup_input');
    const preview = document.getElementById('followupDatePreview');

    function calculateFollowupDate(days) {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return normalizeToBusinessDay(d);
    }
    function normalizeToBusinessDay(d) {
        const dayOfWeek = d.getDay();
        if (dayOfWeek === 6) d.setDate(d.getDate() + 2);
        if (dayOfWeek === 0) d.setDate(d.getDate() + 1);
        return d;
    }
    function formatDateISO(d) {
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function formatDateDisplay(d) {
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    function updatePreview() {
        if (dateInput.value) {
            const d = new Date(dateInput.value + 'T12:00:00');
            preview.textContent = 'Follow-up: ' + formatDateDisplay(d);
        } else {
            preview.textContent = '';
        }
    }
    function clearPresetSelection() {
        presets.forEach(function(p) {
            p.classList.remove('active', 'tos-btn-primary');
            p.classList.add('tos-btn-secondary');
        });
    }
    function setFollowupFromPreset(days, btn) {
        dateInput.value = formatDateISO(calculateFollowupDate(days));
        updatePreview();
        clearPresetSelection();
        btn.classList.remove('tos-btn-secondary');
        btn.classList.add('active', 'tos-btn-primary');
    }
    dateInput.addEventListener('change', function() {
        if (this.value) {
            const selected = new Date(this.value + 'T12:00:00');
            const normalized = normalizeToBusinessDay(new Date(selected));
            const normalizedISO = formatDateISO(normalized);
            if (this.value !== normalizedISO) {
                this.value = normalizedISO;
                preview.textContent = 'Follow-up: ' + formatDateDisplay(normalized) + ' (moved from weekend)';
            } else {
                updatePreview();
            }
        }
        clearPresetSelection();
    });
    presets.forEach(function(btn) {
        btn.addEventListener('click', function() {
            setFollowupFromPreset(parseInt(this.dataset.days, 10), this);
        });
    });
    // Initialize with 30-day default
    const defaultBtn = document.querySelector('.followup-preset[data-days="30"]');
    if (defaultBtn) setFollowupFromPreset(30, defaultBtn);

    const modal = document.getElementById('logContactModal');
    const form = document.getElementById('logContactForm');
    const modalTitle = document.getElementById('logContactModalLabel');

    modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const contactId = button.getAttribute('data-contact-id');
        const contactName = button.getAttribute('data-contact-name');

        // Update form action to post to the selected contact
        form.action = '/contacts/' + contactId + '/log-contact?from=/accounts/{{ account.id }}';

        // Update modal title with contact name
        modalTitle.innerHTML = '<i class="bi bi-telephone me-2"></i>Log Contact with ' + contactName;

        // Reset form fields
        document.getElementById('contact_notes').value = '';
        document.getElementById('activity_type').value = 'email';
        if (defaultBtn) setFollowupFromPreset(30, defaultBtn);
    });

    // Meeting Modal: set default date/time when modal opens
    const meetingModal = document.getElementById('logMeetingModal');
    if (meetingModal) {
        meetingModal.addEventListener('show.bs.modal', function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('meetingDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        });
    }

    // Site Visit Modal JS is handled by the shared partial
})();
</script>
{% endblock %}
