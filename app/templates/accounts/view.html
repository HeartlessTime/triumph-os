{% extends "base.html" %}

{% block title %}{{ account.name }} - Triumph OS{% endblock %}

{% block content %}
{% set from_list = request.query_params.get('from') %}
<div class="content-area">
    <div class="tos-page-header">
        {% if from_list and from_list.startswith('/accounts') %}
        <div class="mb-2">
            <a href="{{ from_list }}" class="tos-btn tos-btn-secondary" data-restore-accounts-list>
                <i class="bi bi-arrow-left me-1"></i> Back to Accounts
            </a>
        </div>
        {% elif return_to %}
        <div class="mb-2">
            <a href="{{ return_to }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
        </div>
        {% endif %}
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/accounts">Accounts</a></li>
                <li class="breadcrumb-item active">{{ account.name }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">{{ account.name }}</h1>
                <span class="tos-entity-sub">{{ account.account_type_display }}</span>
            </div>
            <div class="d-flex gap-2">
                <a href="/accounts/{{ account.id }}/edit" class="tos-btn tos-btn-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <button type="button" class="tos-btn tos-btn-primary" data-bs-toggle="modal" data-bs-target="#logSiteVisitModal">
                    <i class="bi bi-geo-alt me-1"></i> Site Visit
                </button>
                <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> New Opportunity
                </a>
                <form method="post" action="/accounts/{{ account.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this account and all its contacts? This cannot be undone.');">
                    <button type="submit" class="tos-btn" style="background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="row g-3">
        <!-- Account Details -->
        <div class="col-lg-4">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-building me-1"></i>Account Details
                </div>
                <div class="p-3">
                    <dl class="mb-0" style="font-size: 0.85rem;">
                        {% if account.industry %}
                        <dt class="tos-entity-sub">Industry</dt>
                        <dd class="mb-2">{{ account.industry }}</dd>
                        {% endif %}

                        {% if account.phone %}
                        <dt class="tos-entity-sub">Phone</dt>
                        <dd class="mb-2"><a href="tel:{{ account.phone }}" class="tos-row-link">{{ account.phone }}</a></dd>
                        {% endif %}

                        {% if account.website %}
                        <dt class="tos-entity-sub">Website</dt>
                        <dd class="mb-2"><a href="{{ account.website }}" target="_blank" class="tos-row-link">{{ account.website }}</a></dd>
                        {% endif %}

                        {% if account.full_address %}
                        <dt class="tos-entity-sub">Address</dt>
                        <dd class="mb-2" style="white-space: pre-line;">{{ account.full_address }}</dd>
                        {% endif %}

                        {% if account.notes %}
                        <dt class="tos-entity-sub">Notes</dt>
                        <dd class="mb-0">{{ account.notes }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Pipeline Stats -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-graph-up me-1"></i>Pipeline
                </div>
                <div class="p-3">
                    <div class="tos-quick-stats">
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Open Opportunities</div>
                            <div style="font-size: 1.25rem; font-weight: 600;">{{ account.open_opportunities_count }}</div>
                        </div>
                        <div class="tos-quick-stat">
                            <div class="tos-entity-sub">Pipeline Value</div>
                            <div class="currency" style="font-size: 1.25rem; font-weight: 600;">{{ account.total_pipeline_value }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contacts -->
        <div class="col-lg-8">
            <div class="tos-card">
                <div class="tos-section-header">
                    <i class="bi bi-people me-1"></i>Contacts
                    <a href="/contacts/new?account_id={{ account.id }}" class="tos-btn tos-btn-secondary ms-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        <i class="bi bi-plus-lg me-1"></i> Add
                    </a>
                </div>
                {% if sorted_contacts %}
                <div class="table-responsive">
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Title</th>
                                <th>Last Contacted</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in sorted_contacts %}
                            <tr>
                                <td>
                                    <a href="/contacts/{{ contact.id }}?from_account={{ account.id }}"
                                       class="tos-row-link tos-entity-name"
                                       data-save-account-scroll>
                                        {{ contact.full_name }}
                                    </a>
                                    {% if contact.is_primary %}
                                    <span class="tos-badge-pending ms-1">Primary</span>
                                    {% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ contact.title or '—' }}</td>
                                <td class="tos-entity-sub">{{ contact.last_contacted.strftime('%b %d, %Y') if contact.last_contacted else '—' }}</td>
                                <td>
                                    {% if contact.email %}
                                    <a href="mailto:{{ contact.email }}" class="tos-row-link">{{ contact.email }}</a>
                                    {% else %}<span class="tos-entity-sub">—</span>{% endif %}
                                </td>
                                <td class="tos-entity-sub">{{ contact.best_phone or '—' }}</td>
                                <td class="text-end" style="white-space: nowrap;">
                                    <button type="button" class="tos-btn tos-btn-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#logContactModal"
                                        data-contact-id="{{ contact.id }}"
                                        data-contact-name="{{ contact.full_name }}"
                                        title="Log Contact">
                                        <i class="bi bi-telephone"></i>
                                    </button>
                                    <a href="/contacts/{{ contact.id }}/edit?from=/accounts/{{ account.id }}" class="tos-btn tos-btn-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="tos-empty-state">
                    <i class="bi bi-person-plus"></i>
                    <p>No contacts yet</p>
                    <a href="/contacts/new?account_id={{ account.id }}" class="tos-btn tos-btn-primary">Add First Contact</a>
                </div>
                {% endif %}
            </div>

            <!-- Opportunities -->
            <div class="tos-card mt-3">
                <div class="tos-section-header">
                    <i class="bi bi-bullseye me-1"></i>Opportunities
                    <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-secondary ms-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        <i class="bi bi-plus-lg me-1"></i> Add
                    </a>
                </div>
                {% if account.opportunities %}
                <div class="table-responsive">
                    <table class="tos-table">
                        <thead>
                            <tr>
                                <th>Opportunity</th>
                                <th>Stage</th>
                                <th>Value</th>
                                <th>Bid Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for opp in account.opportunities %}
                            <tr>
                                <td>
                                    <a href="/opportunities/{{ opp.id }}" class="tos-row-link tos-entity-name">
                                        {{ opp.name }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-stage badge-{{ opp.stage|lower|replace(' ', '-') }}">
                                        {{ opp.stage }}
                                    </span>
                                </td>
                                <td class="currency">{{ opp.value or 0 }}</td>
                                <td class="tos-entity-sub">{{ opp.bid_date.strftime('%b %d, %Y') if opp.bid_date else '—' }}</td>
                                <td class="text-end">
                                    <a href="/opportunities/{{ opp.id }}" class="tos-btn tos-btn-secondary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="tos-empty-state">
                    <i class="bi bi-bullseye"></i>
                    <p>No opportunities yet</p>
                    <a href="/opportunities/intake?account_id={{ account.id }}" class="tos-btn tos-btn-primary">Create First Opportunity</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Log Contact Modal -->
<div class="modal fade" id="logContactModal" tabindex="-1" aria-labelledby="logContactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="logContactForm" method="post" action="">
                <div class="modal-header">
                    <h5 class="modal-title" id="logContactModalLabel">
                        <i class="bi bi-telephone me-2"></i>Log Contact
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="activity_type" class="form-label">Activity Type</label>
                        <select class="form-select" id="activity_type" name="activity_type">
                            <option value="call" selected>Phone Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="contact_notes" class="form-label">Notes <span class="text-muted">(optional)</span></label>
                        <textarea class="form-control" id="contact_notes" name="notes" rows="3"
                            placeholder="Add notes about this contact..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Log Contact
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Log Site Visit Modal -->
<div class="modal fade" id="logSiteVisitModal" tabindex="-1" aria-labelledby="logSiteVisitModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="siteVisitForm" action="/activities/add?from=/accounts/{{ account.id }}">
                <input type="hidden" name="activity_type" value="site_visit">
                <input type="hidden" name="update_last_contacted" value="">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="logSiteVisitModalLabel"><i class="bi bi-geo-alt me-2"></i>Log Site Visit - {{ account.name }}</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2">
                    <div class="mb-2">
                        <label for="siteVisitDate" class="form-label small mb-1">Date & Time <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control form-control-sm" id="siteVisitDate" name="activity_date" required>
                    </div>
                    <div class="mb-2">
                        <label for="siteVisitOpportunity" class="form-label small mb-1">Opportunity</label>
                        <select class="form-select form-select-sm" id="siteVisitOpportunity" name="opportunity_id">
                            <option value="">-- Select Opportunity --</option>
                            {% for opp in account.opportunities %}
                            {% if opp.stage not in ['Won', 'Lost'] %}
                            <option value="{{ opp.id }}">{{ opp.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="siteVisitSubject" class="form-label small mb-1">Purpose <span class="text-danger">*</span></label>
                        <select class="form-select form-select-sm" id="siteVisitSubject" name="subject" required>
                            <option value="Pre-bid walkthrough">Pre-bid walkthrough</option>
                            <option value="Existing site evaluation">Existing site evaluation</option>
                            <option value="Post-install check">Post-install check</option>
                            <option value="Relationship visit">Relationship visit</option>
                            <option value="Site Visit">Other</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="siteVisitContact" class="form-label small mb-1">Contact</label>
                        <select class="form-select form-select-sm" id="siteVisitContact" name="contact_id">
                            <option value="">-- Select Contact --</option>
                            {% for contact in sorted_contacts %}
                            <option value="{{ contact.id }}">{{ contact.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-0">
                        <label for="siteVisitNotes" class="form-label small mb-1">Notes</label>
                        <textarea class="form-control form-control-sm" id="siteVisitNotes" name="description" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-geo-alt me-1"></i>Log Site Visit</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const modal = document.getElementById('logContactModal');
    const form = document.getElementById('logContactForm');
    const modalTitle = document.getElementById('logContactModalLabel');

    modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const contactId = button.getAttribute('data-contact-id');
        const contactName = button.getAttribute('data-contact-name');

        // Update form action to post to the selected contact
        form.action = '/contacts/' + contactId + '/log-contact?from=/accounts/{{ account.id }}';

        // Update modal title with contact name
        modalTitle.innerHTML = '<i class="bi bi-telephone me-2"></i>Log Contact with ' + contactName;

        // Clear previous notes
        document.getElementById('contact_notes').value = '';
        document.getElementById('activity_type').value = 'call';
    });

    // Site Visit Modal: set default date/time when modal opens
    const siteVisitModal = document.getElementById('logSiteVisitModal');

    if (siteVisitModal) {
        siteVisitModal.addEventListener('show.bs.modal', function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('siteVisitDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        });
    }
})();
</script>
{% endblock %}
