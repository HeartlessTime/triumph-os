{% extends "base.html" %}

{% block title %}{% if is_new %}New Account{% else %}Edit {{ account.name }}{% endif %} - Triumph OS{% endblock %}

{% block content %}
<div class="content-area">
    <div class="tos-page-header">
        <div class="mb-2">
            <a href="{{ request.query_params.get('from', '/accounts/' ~ account.id if not is_new else '/accounts') }}" class="tos-btn tos-btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to {% if is_new %}Accounts{% else %}{{ account.name }}{% endif %}
            </a>
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/accounts">Accounts</a></li>
                <li class="breadcrumb-item active">{% if is_new %}New Account{% else %}Edit{% endif %}</li>
            </ol>
        </nav>
        <h1>{% if is_new %}New Account{% else %}Edit Account{% endif %}</h1>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="tos-card">
                <div class="p-3">
                    <!-- Error Alert -->
                    {% if error %}
                    <div class="alert alert-danger mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
                    </div>
                    {% endif %}

                    <!-- Warning Alert with Override -->
                    {% if warnings %}
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-circle me-2"></i><strong>Warning:</strong>
                        <ul class="mb-2 mt-2">
                            {% for w in warnings %}
                            <li>{{ w }}</li>
                            {% endfor %}
                        </ul>
                        <small>Click "Save Anyway" to proceed despite warnings.</small>
                    </div>
                    {% endif %}

                    <form method="post" action="{% if is_new %}/accounts/new{% else %}/accounts/{{ account.id }}/edit{% endif %}" id="accountForm" {% if not is_new %}data-auto-save="/accounts/{{ account.id }}/auto-save"{% endif %}>
                        <!-- Hidden field for warning override -->
                        {% if warnings %}
                        <input type="hidden" name="confirm_warnings" value="true">
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-12">
                                <label for="name" class="form-label">Account Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name"
                                    value="{{ form_name if form_name is defined else (account.name or '' if account else '') }}"
                                    required placeholder="e.g., Acme Corporation">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Account Type</label>
                                {% set selected_type = form_account_type if form_account_type is defined else (account.account_type if account else 'end_user') %}
                                <div class="d-flex gap-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="account_type" id="type_end_user" value="end_user" {% if selected_type == 'end_user' %}checked{% endif %}>
                                        <label class="form-check-label" for="type_end_user">End User</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="account_type" id="type_gc" value="gc" {% if selected_type == 'gc' %}checked{% endif %}>
                                        <label class="form-check-label" for="type_gc">General Contractor</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="industry" class="form-label">Industry</label>
                                <select class="form-select" id="industry" name="industry">
                                    <option value="">Select Industry</option>
                                    {% set selected_industry = form_industry if form_industry is defined else (account.industry or '' if account else '') %}
                                    {% for ind in industries %}
                                    <option value="{{ ind }}" {% if selected_industry == ind %}selected{% endif %}>{{ ind }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                    value="{{ form_phone if form_phone is defined else (account.phone or '' if account else '') }}"
                                    placeholder="(512) 555-1234">
                            </div>

                            <div class="col-12">
                                <label for="website" class="form-label">Website</label>
                                <input type="url" class="form-control" id="website" name="website"
                                    value="{{ form_website if form_website is defined else (display_website or '' if display_website else (account.website or '' if account else '')) }}"
                                    placeholder="https://example.com">
                            </div>

                            <div class="col-12">
                                <hr class="my-2">
                                <h6 class="text-muted mb-3">Address</h6>
                            </div>

                            <div class="col-12">
                                <label for="address" class="form-label">Street Address</label>
                                <input type="text" class="form-control" id="address" name="address"
                                    value="{{ form_address if form_address is defined else (account.address or '' if account else '') }}"
                                    placeholder="123 Main St">
                            </div>

                            <div class="col-md-5">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city"
                                    value="{{ form_city if form_city is defined else (account.city or '' if account else '') }}"
                                    placeholder="e.g., Austin">
                            </div>

                            <div class="col-md-4">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state"
                                    value="{{ form_state if form_state is defined else (account.state or '' if account else '') }}"
                                    placeholder="e.g., TX">
                            </div>

                            <div class="col-md-3">
                                <label for="zip_code" class="form-label">ZIP Code</label>
                                <input type="text" class="form-control" id="zip_code" name="zip_code"
                                    value="{{ form_zip_code if form_zip_code is defined else (account.zip_code or '' if account else '') }}"
                                    placeholder="78701">
                            </div>

                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3">{{ form_notes if form_notes is defined else (account.notes or '' if account else '') }}</textarea>
                            </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            {% if is_new or warnings %}
                            <button type="submit" class="tos-btn tos-btn-primary">
                                <i class="bi bi-check-lg me-1"></i>
                                {% if warnings %}Save Anyway{% else %}Create Account{% endif %}
                            </button>
                            <a href="/accounts" class="tos-btn tos-btn-secondary">Cancel</a>
                            {% else %}
                            <!-- Auto-save mode: no Save button, just Done -->
                            <a href="/accounts/{{ account.id }}" class="tos-btn tos-btn-primary">
                                <i class="bi bi-check-lg me-1"></i> Done
                            </a>
                            <span class="tos-entity-sub align-self-center ms-2">
                                <i class="bi bi-cloud-check me-1"></i>Changes save automatically
                            </span>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Help sidebar -->
        <div class="col-lg-4">
            <div class="tos-card" style="background: #f8fafc;">
                <div class="p-3">
                    <h6 class="mb-2" style="font-size: 0.85rem;"><i class="bi bi-info-circle me-1"></i> Required Fields</h6>
                    <p class="tos-entity-sub mb-0">
                        Only the <span class="text-danger">*</span> field is required:
                    </p>
                    <ul class="tos-entity-sub mt-2 mb-0" style="padding-left: 1.25rem;">
                        <li>Account Name</li>
                    </ul>
                    <p class="tos-entity-sub mt-2 mb-0">
                        All other fields are optional.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if not is_new %}
<script>
(function() {
    const form = document.getElementById('accountForm');
    const endpoint = form.dataset.autoSave;
    if (form && endpoint) {
        AutoSave.init(form, endpoint);
    }
})();
</script>
{% endif %}
{% endblock %}
